<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>将树莓派连接到公网</title>
    <link href="/2020/11/09/%E5%B0%86%E6%A0%91%E8%8E%93%E6%B4%BE%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%85%AC%E7%BD%91/"/>
    <url>/2020/11/09/%E5%B0%86%E6%A0%91%E8%8E%93%E6%B4%BE%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%85%AC%E7%BD%91/</url>
    
    <content type="html"><![CDATA[<h3 id="连接公网"><a href="#连接公网" class="headerlink" title="连接公网"></a>连接公网</h3><p>要想把运行在本地的树莓派连接到公网访问，通常有两种方式。</p><h3 id="公网IP-DDNS"><a href="#公网IP-DDNS" class="headerlink" title="公网IP+DDNS"></a>公网IP+DDNS</h3><p>公网IP需要你的宽带运营商提供，这个IP仍然是动态的，即每次连接宽带，公网IP都会变化。如果需要一个稳定的入口则需要搭配域名和DDNS使用。</p><h4 id="索要ip"><a href="#索要ip" class="headerlink" title="索要ip"></a>索要ip</h4><p>宽带上网时，公网能看到的宽带运营商的IP地址（直接百度搜索“ip”即可查到自己的公网IP），是无法直接访问到你的计算机或者路由器的。可以理解为，公网IP和本地宽带入口之间还有一层路由信息，通过公网IP，外网的连接无法寻找到你的计算机。需要运营商给你的宽带一些特殊的配置。</p><p>电信宽带索要成功概率较大，不过不同地区也不太一样，比如我就要不到。但是我听一些朋友说，这也是有技巧的，不要直说，可以说家里安装监控，需要把网络改成<strong>桥接模式</strong>。</p><h4 id="DDNS"><a href="#DDNS" class="headerlink" title="DDNS"></a>DDNS</h4><p>外网可以访问到本地计算机了，但是想要从外网访问必须要记住经常变动的IP地址，十分不便。</p><p>DNS解析就是把 xxx.com这样的网址解析到 123.234.123.234这样的IP地址，更方便使用。DDNS即动态DNS，就是定时修改xxx.com所解析的地址，这样就不需要记住变更的IP了。</p><p> 一般路由器都有这种功能，我使用过TP-LINK和小米路由器，在路由器管理界面都有DDNS的设置方式。还是建议使用TPLINK，tplink有官方提供的免费DDNS服务，小米只能设置网上第三方提供的服务，这些服务可能要注册额外账号，也可能要收费。</p><p>TPLINK为例，创建新域名后，你就会得到一个 这样的域名 xxx.tpddns.cn，你可以把它映射到树莓派的内网IP上，通过xxx.tpddns.cn域名访问到路由器的流量都会被发送到树莓派上，树莓派上的服务就可以在公网访问了。</p><h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><p>公网IP+DDNS是最好的解决方案，但是宽带公网IP有时候很难获取。内网穿透也是一种解决方案。</p><h4 id="服务提供商"><a href="#服务提供商" class="headerlink" title="服务提供商"></a>服务提供商</h4><p>花生壳应该是国内最著名的内网穿透服务的提供商了，如果你需要稳定的外网访问，可以考虑，不过既然都是玩树莓派了，一般不是这样的需求。花生壳免费版限制较多，收费版性价比不高。</p><p>国外的 <a href="https://ngrok.com/">ngrok</a> 不错，推荐使用它的免费版，收费版不推荐，容易被墙，费用稍贵于国内服务，最重要的是不支持微信支付宝付款。免费版不支持自定义域名，且ngrok提供的域名会定期更换，不太方便。</p><p>国内推荐 <a href="https://www.ngrok.cc/">sunny-ngrok</a> 和 <a href="https://www.natfrp.com/">sakura frp</a>。国内不推荐免费版，一来收费很便宜，一般1个通道10元一个月，有时候搞活动还会打折。而来国内的白嫖党太多了，免费服务器用户太多很不稳定。</p><p>注意内网穿透很多都是一个通道一个计费的，如果你需要一个ssh和一个web服务那就要两个隧道，以此类推，如果追求稳定，就不建议免费版。 所以公网IP+DDNS的方式还是最好的。</p><h4 id="自己搭建服务"><a href="#自己搭建服务" class="headerlink" title="自己搭建服务"></a>自己搭建服务</h4><p>如果你有云服务器，可以自己搭建ngrok或者frp服务，自行搜索教程。由于云服务器通常价格较高，可以买低配服务器搭建内网穿透连接运行在本地的主机。如果是搭建云存储类的，建议流量付费，固定带宽速度太慢，可以考虑外网VPS，更加划算，还可以用于某些科学用途。如果是游戏服务器之类的，建议固定带宽，使用国内服务商延时低。</p><h3 id="注册域名"><a href="#注册域名" class="headerlink" title="注册域名"></a>注册域名</h3><p>最后建议注册一个域名，当然这不是必须的。内网穿透或者DDNS提供的域名，通常不可选择。想要更加方便灵活，就可以自己注册域名。配置DNS CNAME类型，把自定义的域名记录到例如上述的xxx.tpddns.cn，这样就可以通过自己的网址来访问自己的服务了。</p><p> 可选国内阿里云腾讯云，或者国外，国内需要备案，速度较慢，国外容易被封不稳定，部分国外域名提供商不支持国内付款方式，还是推荐国内的。域名费用通常不贵，一年价格特别便宜（相当于促销吧），比如.top .site 等后缀的域名一年费用甚至小于10元，一次性注册时间长单价会高一些，5年性价比较高，便宜的域名5年价格在100元多一点，相当划算。</p>]]></content>
    
    
    
    <tags>
      
      <tag>树莓派</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用树莓派</title>
    <link href="/2020/11/08/%E6%A0%91%E8%8E%93%E6%B4%BE/"/>
    <url>/2020/11/08/%E6%A0%91%E8%8E%93%E6%B4%BE/</url>
    
    <content type="html"><![CDATA[<p>阿里云腾讯云薅羊毛的廉价主机，性能有点烂，我有时在服务器上多部署了一些平时用的工具，就卡的不行。为了和朋友联机，我在阿里云1G2M的云服务器上部署了一个泰拉瑞亚的服务器，结果卡的大家都动不了。云服务商提供的高性能主机价格太高，薅羊毛也只有一次，因此我就想搞一台性能尚可的微型主机，同时还有一定可玩性就更好了。树莓派就是最好的选择了。</p><h3 id="系统选择"><a href="#系统选择" class="headerlink" title="系统选择"></a>系统选择</h3><p>我的树莓派型号是4B，4GB，淘宝购买，不注明的话商家会给你预装系统，建议安装，减少麻烦。基于linux debian的官方系统Raspbian一般有三种版本lite（无图形化界面），桌面版，桌面版含常用软件。不建议第三个，里面包含了太多无用的东西，如果你用的是16g sb卡空间会捉襟见肘。而一般店家都会默认装第三个系统，建议提前沟通安装版本。当然为树莓派定制的系统镜像还有很多，Ubuntu、Arch Linux ARM等等。还有一些为硬件用途定制的系统，我并不太了解。</p><h3 id="连接wifi"><a href="#连接wifi" class="headerlink" title="连接wifi"></a>连接wifi</h3><p>通常购买树莓派不会购买屏幕，通过SSH或者VNC连接主机。那第一次上网该如何连接？</p><ol><li>条件：有线网络，拥有路由器管理权限。 最简单的方式，直接插上就好了，在路由器管理上面找到 Raspberrypi 查看ip即可，默认账号密码与系统镜像有关，官方系统Raspbian 默认帐号：Username: pi Password: raspberry</li><li>无上述条件，在电脑上编辑烧录系统的SD卡。编辑其中的 <code>/boot/wpa_supplicant.conf</code> 文件。详细请看 <a href="https://shumeipai.nxez.com/2017/09/13/raspberry-pi-network-configuration-before-boot.html">https://shumeipai.nxez.com/2017/09/13/raspberry-pi-network-configuration-before-boot.html</a></li></ol><p>登录系统后编辑wifi账号密码的方式</p><pre><code class="hljs shell">sudo raspi-config</code></pre><p>选择 network options-&gt;wireless LAN 然后依次输入账号密码完成</p><h3 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h3><p>使用的Raspbian镜像自带的一些软件功能有问题。</p><h4 id="vim-键盘功能异常"><a href="#vim-键盘功能异常" class="headerlink" title="vim 键盘功能异常"></a>vim 键盘功能异常</h4><p>vim中键盘上部分按键无法使用（好像是树莓派键盘和标准键盘不同，所特别修改的）。可以卸载重装vim</p><pre><code class="hljs shell">sudo apt-get remove vim-commonsudo apt-get install vim</code></pre><p>然而<br>apt-get报错：</p><pre><code class="hljs less"><span class="hljs-attribute">dpkg</span>: 无法恢复的致命错误，中止: 软件包 <span class="hljs-attribute">libssh-gcrypt-4</span>:armhf 的文件名列表文件缺少最后结尾的换行符</code></pre><p>解决方法：</p><pre><code class="hljs shell">cd /var/lib/dpkg/infols libssh-gcrypt* ls libssh-gcrypt* <span class="hljs-meta">#</span><span class="bash">删除报错文件 并重装该模块</span>sudo rm libssh-gcrypt*sudo apt-get reinstall libssh-gcrypt-4</code></pre><h4 id="SD卡容量异常"><a href="#SD卡容量异常" class="headerlink" title="SD卡容量异常"></a>SD卡容量异常</h4><pre><code class="hljs ebnf"><span class="hljs-attribute">df -h</span></code></pre><p>发现16G SD卡可用空间只有7G，不是无良商家的假冒伪劣产品，是树莓派默认隐藏了一部分空间（我不懂为啥要这么做）</p><p>解决方法：</p><pre><code class="hljs shell">sudo raspi-config</code></pre><p>依次选择 -&gt;Advanced Options -&gt;Expand Filesystem</p><h4 id="卸载不必要的软件"><a href="#卸载不必要的软件" class="headerlink" title="卸载不必要的软件"></a>卸载不必要的软件</h4><p>系统中可能有一些不需要的软件，尤其是安装了图形化界面版本系统的。</p><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 搜索已安装软件 </span>dpkg -l| grep Xxx<span class="hljs-meta">#</span><span class="bash"> 根据搜索到的软件，选择删除</span>sudo apt remove xxxsudo apt-get autoremove --purge</code></pre><h3 id="自启动服务"><a href="#自启动服务" class="headerlink" title="自启动服务"></a>自启动服务</h3><p>通常我们使用树莓派这类主机，都会要跑一些常年在线的服务：web服务器，游戏服务器等等。</p><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 新建一个文件</span>touch my.service</code></pre><p>编辑文件</p><pre><code class="hljs routeros">[Unit]<span class="hljs-attribute">Description</span>=My<span class="hljs-built_in"> service </span># 服务介绍<span class="hljs-attribute">After</span>=network.target[Service]<span class="hljs-attribute">ExecStart</span>=/usr/bin/java -jar /home/pi/services/my-server-0.0.1.jar --server.<span class="hljs-attribute">port</span>=9000 # 要运行的程序，注意使用绝对路径<span class="hljs-comment"># 服务要使用的目录，注意如果程序内配置使用的目录和不再这个路境内，会无法编辑。如服务器配置日志输出路径为/log，那按下方设置/data/my-server将无法输出日志</span><span class="hljs-attribute">WorkingDirectory</span>=/data/my-server[Install]<span class="hljs-attribute">WantedBy</span>=multi-user.target</code></pre><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 把配置好的脚本复制到systemctl的目录</span>sudo cp my.service /etc/systemd/system/my.service<span class="hljs-meta">#</span><span class="bash"> 重新加载</span>sudo systemctl daemon-reload sudo systemctl start myscript.service # 尝试启动sudo systemctl status myscript.service  # 查看服务状态，可以看到服务输出的日志，方便排查问题sudo systemctl enable myscript.service  # 开机时自动运行</code></pre><p>注意，有时候后台运行的程序使用会使用nohup xxxx &amp;的方式启动，千万不要自systemctl的ExecStart脚本汇总使用nohup，会导致启动失败。本来每个service就维护着一个独立的进程，nohup没有意义了。</p><h3 id="samba共享文件"><a href="#samba共享文件" class="headerlink" title="samba共享文件"></a>samba共享文件</h3><p>使用samba服务局域网共享文件</p><pre><code class="hljs shell">sudo apt-get install samba samba-client</code></pre><p>配置smb.conf文件 <code>/etc/samba/smb.conf </code>，尾部添加</p><pre><code class="hljs applescript">[<span class="hljs-literal">pi</span>]workgroup = <span class="hljs-literal">pi</span> <span class="hljs-comment">#名字随意起</span>security = <span class="hljs-literal">pi</span>netbios <span class="hljs-built_in">name</span> = <span class="hljs-literal">pi</span>comment = <span class="hljs-literal">pi</span> homepath = /media/<span class="hljs-literal">pi</span>/mnt <span class="hljs-comment"># 我的外接移动硬盘的挂载位置</span>browsable = yeswriteable = yes<span class="hljs-built_in">read</span> only = no</code></pre><h4 id="samba读写速度慢"><a href="#samba读写速度慢" class="headerlink" title="samba读写速度慢"></a>samba读写速度慢</h4><p>在局域网传输速率文档在2m左右，且响应速度慢如，直接打开samba共享的电影，跳转到指定位置可能会卡顿。</p><p>解决方法（不完善，待研究）</p><p>编辑 <code>/etc/samba/smb.conf </code>，[global] 下添加参数:</p><pre><code class="hljs arduino"><span class="hljs-built_in">min</span> receivefile <span class="hljs-built_in">size</span> = <span class="hljs-number">16384</span><span class="hljs-built_in">write</span> cache <span class="hljs-built_in">size</span> = <span class="hljs-number">262144</span></code></pre><p>重启服务，响应速度已经完全正常了，看电影不卡了，速度提升到 5-6mb/s+，仍旧不理想，也许和路由器性能、网络环境、树莓派本身性能、操作系统、usb接口的带宽等等因素有关，未能进一步找到原因。</p>]]></content>
    
    
    
    <tags>
      
      <tag>树莓派</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>升级hexo</title>
    <link href="/2020/11/04/update_hexo/"/>
    <url>/2020/11/04/update_hexo/</url>
    
    <content type="html"><![CDATA[<p>长时间没有使用，本地的hexo版本是3.8</p><pre><code class="hljs yaml"><span class="hljs-string">&gt;</span> <span class="hljs-string">hexo</span> <span class="hljs-string">version</span><span class="hljs-attr">hexo:</span> <span class="hljs-number">3.8</span><span class="hljs-number">.0</span><span class="hljs-attr">hexo-cli:</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span><span class="hljs-attr">os:</span> <span class="hljs-string">Windows_NT</span> <span class="hljs-number">10.0</span><span class="hljs-number">.18363</span> <span class="hljs-string">win32</span> <span class="hljs-string">x64</span><span class="hljs-attr">http_parser:</span> <span class="hljs-number">2.8</span><span class="hljs-number">.0</span><span class="hljs-attr">node:</span> <span class="hljs-number">10.1</span><span class="hljs-number">.0</span><span class="hljs-attr">v8:</span> <span class="hljs-number">6.6</span><span class="hljs-number">.346</span><span class="hljs-number">.27</span><span class="hljs-string">-node.6</span><span class="hljs-attr">uv:</span> <span class="hljs-number">1.20</span><span class="hljs-number">.2</span><span class="hljs-attr">zlib:</span> <span class="hljs-number">1.2</span><span class="hljs-number">.11</span><span class="hljs-attr">ares:</span> <span class="hljs-number">1.14</span><span class="hljs-number">.0</span><span class="hljs-attr">modules:</span> <span class="hljs-number">64</span><span class="hljs-attr">nghttp2:</span> <span class="hljs-number">1.29</span><span class="hljs-number">.0</span><span class="hljs-attr">napi:</span> <span class="hljs-number">3</span><span class="hljs-attr">openssl:</span> <span class="hljs-number">1.1</span><span class="hljs-string">.0h</span><span class="hljs-attr">icu:</span> <span class="hljs-number">61.1</span><span class="hljs-attr">unicode:</span> <span class="hljs-number">10.0</span><span class="hljs-attr">cldr:</span> <span class="hljs-number">33.0</span><span class="hljs-attr">tz:</span> <span class="hljs-string">2018c</span></code></pre><p>升级执行 </p><pre><code class="hljs avrasm">npm i hexo-<span class="hljs-keyword">cli</span> -g</code></pre><p>等待升级完成…此时再次执行<code>hexo version</code>， 报错，原来本地的node环境还是版本10，于是升级node，windows环境下升级node最好还是官网下载安装包。</p><p>升级完成后再次执行<code>hexo version</code>， 升级成功。</p><p>更换主题，我一直使用的是默认的 landscape 主题，自己修改里面的模板文件ejs来满足需求。尝试了几个主题之后我选择了 <a href="https://hexo.fluid-dev.com/">fluid</a>，原因是它自带的搜索功能太好用了，可以搜索正文。这正是我想要的，本来就主要是写给自己看的，方便后面回来查找。其实是内置了hexo-generator-search插件，然而我以前并不知道，永远滴神。配置也非常丰富，虽然默认风格不是太喜欢，不过很容易修改。</p>]]></content>
    
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>过去的一年(4) 年轻人患上癌症，除了健康还会失去什么</title>
    <link href="/2020/11/02/last-year-4/"/>
    <url>/2020/11/02/last-year-4/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">个人主页</a></p><p>大半年的治疗快要结束了，我已经跟公司沟通过，即将回到工作岗位。作为一个癌症患者，我应该算是比较幸运的。首先最重要的是疾病是有望治愈的，生活还是有希望的。我的亲人也对我很好，尽力为我提供了好的治疗方式，家庭积蓄也还够应付这场灾难生活水平没有受到很大影响。很多病友都因病失业，原本以为长时间的请病假，我可能要失去工作了，结果工作单位对我也不错，虽然领导对我是否有能力回归工作还有疑虑，但是我最终还是留了下来。</p><p>癌症患者大多数是50-60岁或更年长的中老年人，我在放疗科排队治疗时，看见医生电脑上的数据，跟我一起治疗的病友们大多数都是这个年龄，年轻人只有我和一个19岁的女孩两个倒霉蛋。在50-60岁的年龄，除了疾病本身一般不用再考虑别的问题。我这样的年龄正是努力发展的时候，即时疾病没有复发，这样的遭遇也会对今后的人生产生重大影响。首先，疾病有复发的风险，这件事情始终是我头上的一块阴影，挥之不去。我实在无法承担如此代价，如果我需要面对最坏的情况，很难想象我父母今后的日子要如何度过。我妈曾经跟我说过，外婆和我都是她最亲的人，外婆生病去世，虽然她很难过，最终是能走出来的，毕竟生老病死是自然规律。但是我生重病，让她最无法接受，即便现在还是好的希望大一些。</p><p>再就是工作问题，大家都在努力工作，画着饼当着资本家的韭菜，希望升职加薪走向人生巅峰。或者走向体制内，工作更加稳定一些。生了病，总会想要求得个安稳，自然就会想到能不能考公务员？不好意思这条路已经堵死了，我咨询过本地的相关部门，恶性肿瘤病史体检一般做不合格处理，即便已经治愈多年。之前由于公司的一些疑虑，我一直以为工作没了，等病好了要重新找工作。在治病的后期，身体状况好的时候我也尝试去参加过几次面试，拿到过一些offer，面试好过入职很难。两个问题，现在很多职位需要提供上家公司的收入证明，然而我大半年没有收入我也不敢说自己是因为患病治疗所致（按照法律规定我的工作年限只有三个月病假工资可以发，且显著低于正常工资收入）。其次，治疗后体内还有残留的肿瘤尸体，一时半会还无法消失，体检可能会有异常，这一条更加适用于手术后的朋友，身体部分器官组织永久缺失，身上还有明显的伤疤，体检是一定会发现的。你可以说你已经好了和正常人一样工作，但是人家凭什么给自己增加风险？如果再生病不但会耽误工作，而且公司还要按照法律义务提供病假工资和社保。</p><p>第二就是感情问题了。我认识一位和我年级差不多的病友，他和女朋友大学就恋爱，在一起五六年了，都准备谈婚论嫁了，结果生病就分手了。理性想想，现在结婚现在都搞得跟商业谈判似的，更没有人会愿意与你共同承担今后不管是10%还是20% 30%的复发风险，除了你的父母他们是没有选择的。当然这世上有没有真爱呢，我想是有的，不过这也是个概率问题。一方面我认为现在大多数人都是比较现实的吧，另一方面父母对于子女也是真爱呀，他们觉得你和这样的另一半在一起，未来风险太大，有这样的阻力在，分手也很合理了。由此而来导致另一个问题，除了最近的几个亲人，我妈从不跟亲戚朋友提起我生病的事情，就怕今后对我的恋爱结婚产生影响。也命令我对多数同学朋友保密，连同学聚会都不让我参加。生病期间出去散步，就怕碰到熟人，为啥工作日在家里？为啥把头发剃光了？为啥皮肤上好多伤（化疗皮肤毒性有点多，好多皮肤破损，甚至有点烂）？ 我已经如此倒霉了，还要像是一个鬼鬼祟祟的逃犯。</p><p>在血液科病房住院期间，我见过了15岁的男生高危白血病，30多岁两个孩子的妈妈被复发的淋巴瘤折磨的疼痛难忍，不知是自己还是亲人确诊疾病后在谈话间嚎啕大哭的女生。我没法帮助他们做什么，就觉得自己即便这样也还算幸运。现在我对生活的期望值真的不高，对工作上没什么要求，现在这些薪水也够我用了，今后能不能有另一半也不是那么重要，安安稳稳的工作，培养自己的爱好，平平安安的过日子就好了。</p><p>不开心的事情就到这里结束吧，end</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>过去的一年(3) 关于癌症治疗的一些过程和想法</title>
    <link href="/2020/11/01/last_year-3/"/>
    <url>/2020/11/01/last_year-3/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">个人主页</a></p><p><em>本来我写博客的目的为了学习整理知识的，就不在这一年的故事上过多的纠结了，这篇一次性写完吧。还是科学理性为主，少写没用的。</em></p><p>2020年3月19日，我的确诊结果终于出来了：经典型霍奇金淋巴瘤。这是一种治愈率相当高的恶性肿瘤，多数人可以治愈。当然坏消息就是分期比较靠后，我已经是4期了，不过仍有不低的治愈希望。顺便说一下淋巴瘤分期方式 <em>Ann Arbor分期系统</em>  和实体肿瘤的常见的分期方式 <em>TNM分期系统</em> 是完全不同的，拿两个不同系统的参数来做比较意义不大。</p><p>人的心理是个很奇怪的东西，如果直接告诉我我患上了淋巴瘤，大约有30-40%无法治愈，我应该非常惊恐。但是当我一开始一直认为自己活下来需要奇迹的时候，转过头来得到这样的结果，我居然是开心的。我那天胃口很好，我甚至想和我父母庆祝一下，去外面吃点好的，无奈疫情期间很多餐馆都没开门。</p><p>如果疑似患上了恶性肿瘤性的疾病，对于疾病状况的评估，请找三甲医院的专科医生。如果条件允许尽量去权威的大医院 ，至少是在确诊、确定治疗方案、中期治疗评估等关键步骤上，最好应该去权威机构，对于患者的好处是非常多的，至少有以下几个方面：</p><ol><li>恶性肿瘤的病理类型千变万化，对于具体的细分类型，小医院的病理科甚至可能很少见过，误诊的可能性大大增加。这点以淋巴瘤最为明显，很多种类淋巴瘤的组织表现的非常相似，需要有丰富经验的人来判断。如果一开始路就走错了，对于治疗会有非常大的影响。</li><li>治疗方案的选择，由于科技的进步，癌症的治疗方案常常会有一些改进，或者全新的效果更好的治疗方法出现，权威医疗机构往往是最先掌握这些信息和技术的地方。能进一步增加疾病治愈、控制的可能性。</li><li>大多数肿瘤患者需要手术治疗，相比放化疗等通过固定药物或者机械完成的治疗，手术对个人能力要求很高，经验丰富的外科医生能够最大限度的提高治疗效果和降低对身体的伤害。</li></ol><p>个人认为如果不是东南沿海发达地区（发达地区相当多地方的地市三甲医院的水平已经非常高了），尽量应该去省会的肿瘤专科医院或者权威的综合医院治疗。但是如果你不是家住大城市且对当地人生地不熟，去大医院的求医之路会非常累人，但是我认为如果经济问题可以解决，这个问题是值得克服的，只是要有一定的思想准备。当然钱也是无法回避的因素，还有6亿人的人均收入不超过1000元，很多家庭面对动辄十万元数十万元的治疗费用，确实很难，这个问题之后有空我会继续吐槽。</p><p>我经常在疾病社区论坛上、病友群里等地方看到类似言论</p><blockquote><p>张三： xxx癌好治，我们家xxx都10几年了非常健康</p><p>李四： ***，这个病治不好的，我爷爷也是这个病，三个月人就没了</p><p> 张三： 我放化疗期间经常吃xxx，显著降低了副作用，推荐大家试试</p><p>李四： ***，我一点用没有？</p></blockquote><p>恶性肿瘤千变万化，人体结构纷繁复杂，对于别人的病情的个案，其实参考价值非常有限。决定治疗效果的因素非常多，我们不可能像做数学题一样得到一个正确的标准答案。统计学在疾病的治疗和医学的进步中扮演重要的十分作用。对于复杂的人体，我们可以收集以往治疗的病例数据，以及健康人群的相关数据来做分析，为疾病的预防、检查、治疗方案的改进提供重要的参考。 例如，我们分别收集了1000个肺癌患者和1000个健康人的生活习惯数据，发现肺癌患者中抽烟的比例比健康人中高出5倍，那我们可以得出结论，抽烟更容易患上肺癌。再比如，1000个患者xx疾病的患者使用A方案化疗，1000个患者使用B方案物化疗，第一组相对于第二组疾病的治愈率提高了10%，那我们可以得出结论对于XX疾病的治疗A方案会更合适。实际的统计会复杂很多，涉及专业的统计学知识和医学知识，数据之间的关系也没有这么直接，分析更加困难。同时如果需要人体实验，也存在伦理的问题，让病人去尝试风险过高的方案是不道德的。数据的分析统计是计算机的专长，在如今的信息化时代，计算机技术也要发挥很大作用。例如，如今已经通过数据分析机器学习，来判断影像中息肉/结节是恶性肿瘤概率的技术，给医生作为参考依据。</p><p>如果你现在跟我说 <em>“我见过XXX天天抽烟喝酒活到100岁，你说的都是扯淡”</em>，那我建议你关掉页面，或者先理解一下什么是“概率”和“统计”，我觉得这对于理性客观地面对疾病，和决定治疗方案是有意义的。</p><p>具体到每一个患者，概率中冷冰冰的数字实在是无情。治愈率90%，你也有可能是那10%，治愈率5%可能你就是那个生命的奇迹。保持乐观的心态和健康的生活方式，对于疾病的治疗有利，但是它们对疾病的影响是有限的。打个比方，你考上了一所重点高中，这所高中80%的人能考上重点大学，但是你是不是这80%绝大部分在于你自己的努力；你患上了癌症，发现的不算晚，80%类似状况的患者可以治愈，但是你自己除了配合治疗，很难做些什么，你是不是这80%，得看天。没考上好的大学你仍然有光明的未来，而对于癌症，那不好的结果实在是太过沉重不可接受了，尤其是对于我这样的年轻人。因此作为一个患者，我常常有种命运不掌握在自己手里的感觉。</p><p>淋巴瘤是一种血液系统恶性肿瘤，大多数淋巴瘤对放化疗高度敏感，但是淋巴瘤非常容易通过遍布全身的淋巴结和淋巴管散播，难以通过手术清除干净，所以手术不是淋巴瘤的主要治疗手段。但是由于在病理确诊前，难以通过影像检查知道肿瘤类型，也有部分病友通过手术切除后才确诊，因为除了淋巴瘤大多数恶性肿瘤都需要手术治疗。我由于肿瘤生长位置不好且波及范围较广，倒也算躲过了一刀。</p><p>放化疗是淋巴瘤的主要治疗手段，相当大的比例的患者可以通过这种方式治愈疾病。对于比较危险的淋巴瘤类型或者复发难治的患者，医生还会建议进行自体骨髓移植。自体移植其实和我们印象中的骨髓移植，大多是指的他人捐献骨髓的异体移植还是不太一样的。自体移植其实是做一次超大计量的化疗来尽可能的杀死身体中残存的肿瘤细胞，这个剂量会超过身体耐受的极限，最先受不了的就是骨髓造血系统，因此提前抽取一部分保存起来，等化疗过后再输回体内。当然除了骨髓，身体的其他组织器官在如此大剂量的化疗下，也会备受摧残，副作用很大相当痛苦。但是相对于异体骨髓移植，风险很小，对于年轻或者身体条件较好的人基本没有生命危险，同时费用也要低得多。另外，靶向药物、免疫治疗等新疗法对于包括淋巴瘤在内的血液系统恶性肿瘤效果非常显著，也已经被广泛用于治疗中，缺点就是贵且很多情况下医保不报销。总的来说，各种治疗手段就像是医生和肿瘤在打牌，游戏规则是这样的：医生手里的牌可以一张一张出，也可以结合在一起出，如果出到了某组牌，肿瘤要不起你就赢了。如果游戏胜算不大时，合理的出牌顺序也能尽可能的拖延失败的时间。我们当然希望最理想的结局，医生的第一手牌就能干碎敌人获得胜利。</p><p>疾病确诊后，我开始接受化疗。化疗通常有较大的副作用，最常见的恶性呕吐，掉头发等。另外还会伤害造血系统和肝肾等器官，因此医生会让定期抽血检查相应功能，如有问题及时对症治疗。对于没有太多基础疾病或者高龄的患者来说，通常问题不大，但是也要严防意外发生。很多人应该都看过《滚蛋吧，肿瘤君》这部电影，女主角的原型实际上得了一种和我类似的疾病-原发纵隔大B细胞淋巴瘤，我不知道她的疾病是某些特殊的类型或者是剧本的需要说她难以治愈，据我了解目前这种疾病的治愈率是相当高的，不低于我所患上的淋巴瘤类型，但是她最终还是不幸去世。据我查到的资料，她的死因应该是化疗后免疫力低下时严重的肺部感染–这很有可能与她当时过多参与社会活动有关。从某种角度来说，她的盲目乐观可能害了她，原本还有治愈的希望，以这种方式离开是十分可惜的。</p><p>对于我个人而言，化疗反应算是比较轻的，恶心无力的症状通常两三天就不严重了，就当每个周期得了一次重感冒，休息几天，副作用就基本不再影响生活了。我的造血系统非常坚强，六个月的化疗，除了到了最后期白细胞略微低于正常值下限以外，血象一直比较正常。期间肝功能出线了一些小问题，经过简单的治疗后一切正常。 对我来说最痛苦的副作用来自于皮肤，我使用的药物产生了很大的皮肤毒性，身上的多处皮肤脱皮、裂口、破损，同时化疗使用的PICC置管处，由于药物的皮肤毒性加我对异物的过敏，严重的溃烂。 三天两头跑医院处理这些问题，还真是挺麻烦的。每个月会做一次检查评估治疗效果，有一种中学月考的感觉，紧张的等着成绩。第一个月我的咳嗽已经基本消失，CT显示肿瘤显著缩小。治疗4个月后又做了一次PET-CT进行中期评估，我没有没有足够幸运地得到完全缓解，纵隔原发肿瘤比较大，现在仍然还有一些活性，不过其他波及的地方已经基本消失，医生给我更换了一种药物，继续治疗。6个月的治疗后，为了进一步提高治愈率降低复发可能，我又开始接受放疗。放疗的体验还是蛮好的，副作用不大，基本不影响生活。过程呢就是用一个事先定制好的模具固定身体在放疗机器上，然后加速器把高能射线打到指定的部位，对放疗敏感的肿瘤类型比正常组织面对高能射线时会更加脆弱，因此合适的剂量可以在最大程度上杀灭肿瘤且保护正常器官。</p><p>相比放化疗的副作用我更担心的是远期风险。即使疾病治愈，放化疗对身体的损伤会带来不少远期的风险，尤其是对年轻人来说，零件使用年限还很长。最重要的是问题是放化疗会显著增加第二肿瘤的发病率，对于我个人而言，由于化疗药物有一定的心脏毒性同时肿瘤离心脏很近，放疗不可避免的会损伤心脏，远期我这颗饱经风雨的心脏会不会受不了还是挺让人担心的。医生会建议治疗结束后后定期复查，越接近初期，原发疾病复发的风险越大，因此复查比较频繁，三五年后原发疾病复发的风险就很低了，但是治疗带来的长期风险仍然要重视。我再次换上肿瘤以及其他疾病的风险会高于普通人，但是如果定期检查能把疾病扼杀在萌芽之中，对生命的威胁也就不大了，一定要记得警钟长鸣。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>过去的一年(2)</title>
    <link href="/2020/10/31/last_year-2/"/>
    <url>/2020/10/31/last_year-2/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">个人主页</a></p><p>我本身是一个文字水平不太高的人，我就尽量少谈感觉，写一写更加理性客观和科学的内容。记录一下这一年的经历，以后如果有机会，我再回过头来看看，也有一定意义。如果有人愿意阅读，我也希望能至少做到一些科普，如果是病友或者家属，能给你们的治疗过程提供一些帮助那就非常有幸了。</p><p>我现在最重要的是必须马上挂号，那天是周五，周末没有专家号，我挂了周一的号。另外，这件事情必须要告诉我的父母了，我没有办法独自承担后续的压力了。但是我想尽量让他们晚点知道，至少这个周末，我不告诉他们就还是个快乐的周末，但是对于我来说已经是无比的恐惧和煎熬了。从周五晚上到周六晚上我似睡非睡的躺了一天，星期六晚上实在想上厕所才起床，我一天没吃饭了居然一点不饿。我实在无法承受这样的压力了，我甚至觉得我周一可能都无法独自前往医院，晚上我给我妈打了电话。</p><p>不得不说我是一个没有演技和情商的人，我想我没有女朋友和这个关系很大 :(。我想轻描淡写的告诉我妈，我的检查结果有点异常，周一我约了再去看看有空的话过来陪我一起，但是我当时的情绪和声音让我妈听出了情况并不妙。周日一早我的父母就来杭州了，很明显他们也没睡好。</p><p>星期一我们来到医院，胸外科医生给我开了一系列检查，增强CT、PET-CT…… 他特别给了我一个他们科室主任的联系方式，让我做完这些检查去找他，号挂不到就让我打电话找他加号，如果不行在某个时间到胸外科病区去找他，评估一下有没有手术的机会。一个素未谋面的医生居然给我如此特殊待遇，我已经没有词汇可以形容我们一家人当时的状态了。。</p><p>一系列检查就花费了7000多元，原来PET-CT医保是不报销的，在浙江做一次PET-CT价格是6500元。PET-CT是一种全面评估肿瘤在全身波及范围的检查手段。具体原理是，检查前会向我的身体里注射一种显像剂，一般用的是18F代葡萄糖，有高中化学、生物基础的人应该知道葡萄糖是生命活动能量的提供者。葡萄糖分子中含有羟基，显像剂用F元素的放射性同位素18F代替这个基团整合到葡萄糖分子上，即<code>-O-H</code>替换为<code> -F</code>。这样的分子它的部分性质类似葡萄糖，会被组织细胞当做葡萄糖吸收，然而他不能正常的被氧化放出能量，所以就在身体中聚集。恶性肿瘤是无限繁殖生长活跃的组织，他所消耗的能量很大，所以分子就会大量聚集在被肿瘤波及的地方。18F是放射性元素，半衰期大约100多分钟，衰变后会生成一个18O+一个正电子+一份伽马射线。正电子会和无处不在的负电子淫灭，被仪器检测到。衰变产生的氧原子回合无处不在的氢离子结合，变成一个正常的葡萄糖分子被人体代谢。而这些衰变产生的射线就是PET-CT会对人体产生放射性伤害而不能经常做的原因，这个辐射剂量还是比较大的，大约是国际上规定的正常人一年可接受的辐射剂量的上限的数倍。不过国际组织规定的无害计量都是非常保守的，相对于肿瘤本身而言，检查对身体的伤害可以忽略不计。</p><p>检查结果出来后我们去见了那位胸外科的主任，我对他第一印象不错，他不让我们多说话，一边阅读各项报告，同时问什么问题我就做对应回答，主任提取报告和交流得到的关键信息写在病历上。他认为现在情况不适合手术，要先化疗让病灶缩小才能有手术机会。但是病理学检查才是肿瘤确诊的金标准，所以现在的情况下需要通过穿刺的方式取得一小份肿瘤组织来确诊。同时他还给我开了一份基因检测，要1万多元，不在医院而是把血液和组织样本给北京的一家检测机构，医保不报销。后来冷静下来后回想，这份基因检测是不需要做的，是医生圈钱的行为，胸部肿瘤的基因检测主要是用于肺癌治疗的，当然对于其他部分肿瘤的治疗也有一定参考作用，但是有多种疑似的肿瘤类型完全不能从基因检测中获得帮助，我这种情况，是肺癌的可能性存在但并不大，即便是完全可以确诊后再做检测。每次想到这位主任，我总觉得有点不舒服，我觉得他破坏了医生在我心中高尚的形象，正规医生不会害命，谋财还是会的。当然可能是因为我之前没接触过医院，有很多医生都会这样，只是我见得少。</p><p>在没有确诊，医生的说法也很含糊，更多是安慰性质的。根据医生的说法，和我所查到的资料，我有可能患有的疾病有恶性畸胎瘤、胸腺瘤、恶性淋巴瘤等等。恶性肿瘤不是一种疾病他是一大类疾病的统称，不同原发器官甚至不同病理类型、不同基因突变对应疾病的治疗效果都会天差地别。 胸腺瘤多是良恶性交界的肿瘤，通常预后较好，恶性程度较高的类型发病率低，但是现在没有太多治疗手段；恶性畸胎瘤和其他生殖源性恶性肿瘤恶性程度高，预后不是太好；淋巴瘤本身也是一个大类疾病，可以原发纵隔的淋巴瘤也分很多种，治疗效果差别很大。我觉得我很像一个等待审判的罪犯，是有期徒刑？还是死缓？还是死刑立即执行？等待检查来取证，医生来审判。我除了等待没有任何事情可以做，跟罪犯不同的是，我并没有做错什么。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>重新开始更新-说说过去的一年</title>
    <link href="/2020/10/30/last_year-1/"/>
    <url>/2020/10/30/last_year-1/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">个人主页</a></p><p>上一次在这里写东西是2019年7月，那之后一段时间由于工作上和领导有矛盾，总体来说就是我想调整工作到离家近点的城市，领导不让我走，也不解决我的其他要求，我性格又比较急躁，和领导之间发生了一些不愉快的事情。我打算如果领导不帮我调整，我就过完年辞职回浙江重新找工作。那段时间心情不好，也无心再学习技术或者写点其他的。好在2019年底换了领导，我也成功离开了武汉回到浙江。后来众所周知的疫情爆发了，我很庆幸自己提前离开风暴中心，免于一难，怎能想到故事才刚刚开始。</p><p>由于疫情关系，2020年的春节假期变得格外的长，直到二月下旬我才接到公司让我回去上班的通知（我已经调到了杭州分公司工作），回到杭州后，虽然我不是高危地区过来的不用隔离，但是公司为了保险起见让外地归来的员工在家待一周再去上班。由于之前那段时间我一直咳嗽，持续了一个多月了，吃药也不怎么管用。趁有空余时间，国内疫情也有所缓解，我就准备去医院看看咳嗽的问题。其实我不觉得咳嗽是个大问题，我还跟我妈说一点小病去大医院真是杀鸡用牛刀了。</p><p>医生给我开了CT。做完检查有一个回执单，扫描上面的二维码就可以看到检查结果，大约中午12点多钟，我的手机上看到了CT结果，大致内容是这样的：</p><blockquote><p> 前中纵隔占位，与胸膜、左肺上叶、心包分界不清，恶性肿瘤考虑，纵隔多发淋巴结肿大，左肺上叶实性结节，转移待排。心包积液，左侧胸腔积液……</p></blockquote><p>我难以形容当时的心情，我的第一反应是医院是不是搞错了，我一直挺健康的，从来没住过院，不算体检抽血上一次去医院打针是哪年我都记不得了。理智告诉我这种可能性基本不存在，要冷静下来，但是我的双腿已经开始发软，我感觉天旋地转不知道如何是好。我没去找医生，我想回家静静，可是当时的状态我感觉我的双腿不足以支撑我走到地铁站，我只能打车回家了。</p><p>我自认为还是有一定科学常识的人，而且我的长辈也有人得癌症去世，我对这类疾病有一定了解。肿瘤边界不清、淋巴结肿大这是恶性肿瘤标志性的特征，不论肺上的结节是不是转移，这个问题已经非常严重。肿瘤比较大，有胸腔积液和淋巴结肿大，最好最好也是局部晚期了，对于大多数恶性肿瘤来说，治愈率已经很低，如果发现远端转移那基本上只能延长生命。</p><p>回到家，我开始反复查看那个CT报告，现在医院的信息化程度确实不错，不仅有报告，还有完整的CT图像。我搜到医学院的影像学课程，找到胸部CT影像的视频，对着视频的内容对比手机上我自己的CT图像，越看越觉得恐怖。我钻进被子里好像被子能帮我抵御恐惧，我把被子裹得很紧，不知道过了多久我睡着了。醒来我全身都是汗，我不知道为什么会这样，这是肿瘤的症状还是受到了惊吓。不过现在我的理智恢复了一些，不管前方的路有没有尽头，我都必须面对了。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>electron-vue多窗口</title>
    <link href="/2019/07/16/electron-vue%E5%A4%9A%E7%AA%97%E5%8F%A3/"/>
    <url>/2019/07/16/electron-vue%E5%A4%9A%E7%AA%97%E5%8F%A3/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">个人主页</a></p><h4 id="打开子窗口"><a href="#打开子窗口" class="headerlink" title="打开子窗口"></a>打开子窗口</h4><p>electron使用 vue-cli 模板 simulatedgreg/electron-vue 的开发过程其实和普通vue应用区别不大，普通vue组件可以直接迁移进来，还可以使用node丰富的api。由于我们的应用需要使用多个窗口，vue单页面应用只有一个页面入口，这是我目前的解决方案：</p><p>首先electron的窗口间通讯需要使用ipc，在主进程中使用ipcMain:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ipcMain = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>).ipcMain</span><br></pre></td></tr></table></figure><p>在渲染进程，即组件中使用ipcRenderer</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ipc = <span class="built_in">require</span>(<span class="string">&#x27;electron&#x27;</span>).ipcRenderer</span><br><span class="line">ipc.(event, args);</span><br><span class="line"><span class="comment">// 模板已经把它封装到vue的参数中了,也可以这样使用</span></span><br><span class="line"><span class="built_in">this</span>.$electron.ipcRenderer.send(event, args);</span><br></pre></td></tr></table></figure><p>在页面的入口组件上mounted钩子函数中加上,意味着接收主进程传来的router事件并指定路由参数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.$electron.ipcRenderer.on(<span class="string">&#x27;router&#x27;</span>,<span class="function">(<span class="params">event,params</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.$router.push(params)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在主进程脚本中接收事件并创建新窗口</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ipcMain.on(<span class="string">&#x27;new-window&#x27;</span>,<span class="function">(<span class="params">event,router</span>)=&gt;</span>&#123;</span><br><span class="line">   subWindow = <span class="keyword">new</span> BrowserWindow(&#123;</span><br><span class="line">        show: <span class="literal">false</span>,  <span class="comment">// 设置自动显示为false以使用ready-to-show事件回调</span></span><br><span class="line">        parent: mainWindow <span class="comment">// 如果需要设置父窗口</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    subWindow.on(<span class="string">&#x27;ready-to-show&#x27;</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        subWindow.show();</span><br><span class="line">        subWindow.send(<span class="string">&#x27;router&#x27;</span>,router); </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在主窗口发送事件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.$electron.ipcRenderer.send(<span class="string">&#x27;new-window&#x27;</span>,&#123;</span><br><span class="line">    name:<span class="string">&#x27;entry&#x27;</span>, <span class="comment">// vue-router传递参数时候不能使用path作为路径</span></span><br><span class="line">    params: &#123; <span class="attr">type</span>: channelType.key &#125; <span class="comment">//传递参数</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="窗口间数据交换"><a href="#窗口间数据交换" class="headerlink" title="窗口间数据交换"></a>窗口间数据交换</h4><p>还是进程间通讯问题，根据需求定义好几个事件，首先是子窗口准备好接收信息的事件，</p><p>在子窗口的组件即你路由到的那个指定组件的钩子函数mounted上加上以下代码告诉主进程，子窗口已经初始化完成，注意这不是electron窗口初始化完成而是指定的vue页面初始化完成</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.$electron.ipcRenderer.send(<span class="string">&#x27;sub-ready&#x27;</span>); </span><br><span class="line"><span class="built_in">this</span>.$electron.ipcRenderer.on(<span class="string">&#x27;data-to-sub&#x27;</span>,<span class="function">(<span class="params">event,data</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 接收到数据</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>此时主进程通知主窗口可以向子窗口通讯了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mainWindow.send(&#39;sub-ready&#39;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主窗口在合适位置监听：</span></span><br><span class="line"><span class="built_in">this</span>.$electron.ipcRenderer.on(<span class="string">&#x27;sub-ready&#x27;</span>,<span class="function">(<span class="params">event,params</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 这时候如果需要可以提示用户，或者变量标识可以发送消息了</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送消息的函数</span></span><br><span class="line"><span class="function"><span class="title">sendData</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.$electron.ipcRenderer.send(<span class="string">&#x27;data-to-sub&#x27;</span>,data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h4><ol><li>主窗口-&gt;主进程: 打开子窗口 </li><li>子窗口-&gt;主进程:初始化完成</li><li>主进程-&gt;子窗口:路由到指定页面</li><li>子窗口-&gt;主进程:页面加载完成</li><li>主进程-&gt;主窗口:子窗口已经可以使用了</li><li>窗口间可以互相通信</li></ol><p><img src="/images/1563257647260.png" alt="时序图"></p><p>以上例子是在一个主窗口和一个子窗口的情况下进行的，如果存在多个窗口或者复杂的路由，可能需要把代码抽象封装的更合理。</p>]]></content>
    
    
    
    <tags>
      
      <tag>electron</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>electron+vue的实践</title>
    <link href="/2019/07/09/electron-vue%E7%9A%84%E5%AE%9E%E8%B7%B5/"/>
    <url>/2019/07/09/electron-vue%E7%9A%84%E5%AE%9E%E8%B7%B5/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">个人主页</a></p><p>吐槽一下，我一个后端程序猿怎么天天在写前端呢😔？</p><p>我们项目要用到一个客户端程序，从我们本身的技术栈出发，最合适的就是electron+vue来实现了。网上有各种文章写到这些，我尝试了一下，记录一下踩坑的过程。</p><p>首先需要npm 和 vue-cli 这个就不再赘述了，</p><h4 id="初始化-开发-打包"><a href="#初始化-开发-打包" class="headerlink" title="初始化-开发-打包"></a>初始化-开发-打包</h4><p>百度上搜索关键词”electron vue” 找到的很多文章会让人误入歧途，比如这个：</p><p><a href="https://www.cnblogs.com/jiangxifanzhouyudu/p/9517651.html">https://www.cnblogs.com/jiangxifanzhouyudu/p/9517651.html</a>， 搜到的第一个就是它。使用 vue-cli 常规webpack打包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue init webpack xxx</span><br></pre></td></tr></table></figure><p>初始化普通vue单页面项目的方式都是不对的，electron中运行和服务器上运行的web应用有很多区别，对于以后的开发和调试都非常不方便。这才是正确方式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue init simulatedgreg&#x2F;electron-vue ele-vue</span><br></pre></td></tr></table></figure><p>这个模板帮助定义好了开发、调试、打包成多平台客户端的各方面配置。值得注意的是，electron和打包工具都非常大，npm的墙内速度真的会让你等到天荒地老，然后网络异常重来一遍。 如果你可以翻墙，就完美了，如果不幸可以在package.json的 build属性下新增以下内容使用淘宝镜像</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;build&quot;: &#123;</span><br><span class="line">    &quot;electronDownload&quot;: &#123;</span><br><span class="line">      &quot;mirror&quot;: &quot;https://npm.taobao.org/mirrors/electron/&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>仍然有一些其他依赖资源不，例如winCodeSign，参考文章  <a href="https://www.cnblogs.com/chenweixuan/p/7693718.html">https://www.cnblogs.com/chenweixuan/p/7693718.html</a></p><p>但经过我在不同电脑上多次配置，还是或多或少存在问题，仅在本地开发时，淘宝镜像安装一切正常，electron-builder打包最好的解决方案仍然删除node_modules然后翻墙使用npm install 简单方便没有任何奇怪的问题发生。</p>]]></content>
    
    
    
    <tags>
      
      <tag>electron</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于element-ui的页面内面包屑组件</title>
    <link href="/2019/07/02/%E5%9F%BA%E4%BA%8Eelement-ui%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%86%85%E9%9D%A2%E5%8C%85%E5%B1%91%E7%BB%84%E4%BB%B6/"/>
    <url>/2019/07/02/%E5%9F%BA%E4%BA%8Eelement-ui%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%86%85%E9%9D%A2%E5%8C%85%E5%B1%91%E7%BB%84%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">lzlz000的个人主页</a></p><p>elment-ui提供了面包屑组件 <strong>el-breadcrumb</strong> 然而他要配合url跳转路由使用，在项目中需要用到页面内的面包屑，因此我写了一个组件 <strong>inner-breadcrumb</strong>(源码在文章底部)</p><p>inner-breadcrumb 包装了 el-breadcrumb 显示效果基本相同，不同的是，不再跳转页面，而是提供一个v-model控制当前的path值，并且提供了动态路径显示的功能（样式只是因为我们的需求如此，这个可以很容易更改）<br>原版样式<br><img src="/images/5d037c361553b.png"><br>本组件样式<br><img src="/images/5d037bd441e48.png"></p><h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><table><thead><tr><th>名称</th><th>说明</th><th>类型</th><th>默认值</th></tr></thead><tbody><tr><td>v-model</td><td>绑定路径值</td><td>string/number</td><td>必填</td></tr><tr><td>path</td><td>面包屑全路径参数，详见下文</td><td>object</td><td>必填</td></tr><tr><td>showInRoot</td><td>是否在根页面显示该组件</td><td>boolean</td><td>false</td></tr><tr><td>showBack</td><td>是否在右侧显示“返回上一级”</td><td>boolean</td><td>false</td></tr><tr><td>labelArgs</td><td>面包屑标签动态参数,详见下文</td><td>object</td><td>-</td></tr></tbody></table><h3 id="例"><a href="#例" class="headerlink" title="例"></a>例</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">inner-breadcrumb</span></span></span><br><span class="line"><span class="tag">  <span class="attr">v-model</span>=<span class="string">&quot;innerPath&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:path</span>=<span class="string">&quot;&#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    label: &#x27;一级页面&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    key: &#x27;1&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    children: [</span></span></span><br><span class="line"><span class="tag"><span class="string">      &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">        key: &#x27;2A&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">        label: &#x27;二级页面A&#x27;</span></span></span><br><span class="line"><span class="tag"><span class="string">      &#125;,</span></span></span><br><span class="line"><span class="tag"><span class="string">      &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">        key: &#x27;2B&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">        label: &#x27;二级页面B&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">        children: [</span></span></span><br><span class="line"><span class="tag"><span class="string">          &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">            key: &#x27;3&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">            label: &#x27;三级页面&#x27;</span></span></span><br><span class="line"><span class="tag"><span class="string">          &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">        ]</span></span></span><br><span class="line"><span class="tag"><span class="string">      &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">    ]</span></span></span><br><span class="line"><span class="tag"><span class="string">&#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>当 v-model绑定值为”3”时，页面为：<br><img src="/images/5d037bd441e48.png"></p><ul><li>控制页面的方式</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div v-if&#x3D;&quot;innerPath&#x3D;&#x3D;&#39;1&#39;&quot;&gt;...&lt;&#x2F;div&gt;</span><br><span class="line">&lt;div v-else-if&#x3D;&quot;innerPath&#x3D;&#x3D;&#39;2A&#39;&quot;&gt;...&lt;&#x2F;div&gt;</span><br><span class="line">&lt;div v-else-if&#x3D;&quot;innerPath&#x3D;&#x3D;&#39;2B&#39;&quot;&gt;...&lt;&#x2F;div&gt;</span><br><span class="line">&lt;div v-else-if&#x3D;&quot;innerPath&#x3D;&#x3D;&#39;3&#39;&quot;&gt;...&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><p>以此类推，页面会按照树形结构自动生成当前位置的面包屑，你可以无限添加。</p><p>值得注意的是，当回到主页面时候，面包屑默认隐藏，因为绝大多数需求和常理都不需要在主页面显示孤零零的面包屑。当然可以通过添加参数 <strong>showInRoot</strong> 来显示它</p><h3 id="属性path的设置"><a href="#属性path的设置" class="headerlink" title="属性path的设置"></a>属性path的设置</h3><table><thead><tr><th>名称</th><th>说明</th><th>类型</th><th>默认值</th></tr></thead><tbody><tr><td>label</td><td>页面标签显示的值</td><td>string/number</td><td>必填</td></tr><tr><td>key</td><td>标签的key</td><td>string/number</td><td>必填</td></tr><tr><td>children</td><td>下一级路径的集合</td><td>array,其中每个元素都是一个节点，多叉树结构</td><td>-</td></tr><tr><td>disable</td><td>如果当前路径不允许被点击则加上</td><td>boolean</td><td>false</td></tr></tbody></table><ul><li>注意，开启“返回上一级”按钮，若上一级目录是disable，则会跳过，若所有上级目录均为disable，则无效，控制台会打印警告信息</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">label: &quot;一级页面&quot;, </span><br><span class="line">key: &quot;1&quot;,</span><br><span class="line">children: [</span><br><span class="line">  &#123;</span><br><span class="line">key: &quot;2A&quot;,</span><br><span class="line">label: &quot;二级页面A&quot;,</span><br><span class="line">disable: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">key: &quot;2B&quot;,</span><br><span class="line">label: &quot;二级页面B&quot;,</span><br><span class="line">children: [</span><br><span class="line">  &#123;</span><br><span class="line">key: &quot;3&quot;,</span><br><span class="line">label: &quot;三级页面&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="动态参数"><a href="#动态参数" class="headerlink" title="动态参数"></a>动态参数</h3><p>动态参数通过属性 <strong>labelArgs</strong> 设置，适用于需要路径动态标签的情况</p><h4 id="例-1"><a href="#例-1" class="headerlink" title="例"></a>例</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">inner-breadcrumb</span></span></span><br><span class="line"><span class="tag">  <span class="attr">v-model</span>=<span class="string">&quot;pathKey&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:label-args</span> =<span class="string">&quot;&#123;code: active.code&#125;&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:path</span>=<span class="string">&quot;&#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    label: &#x27;排课管理&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    key:&#x27;main&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    children:[&#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">      label: &#x27;教学班排课(&#123;code&#125;)&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">      key:&#x27;arrange&#x27;</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#125;,]</span></span></span><br><span class="line"><span class="tag"><span class="string">  &#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>当切换到对应路径<strong>arrange</strong>时候，会显示：<br><img src="/images/5d037be97b8c2.png"></p><p>源码如下:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 页面内部使用的面包屑组件（URL不变,不适用router跳转） --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner-breadcrumb&quot;</span> <span class="attr">v-show</span>=<span class="string">&quot;showInRoot || value!=root&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height:24px;padding:0 3px 10px;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-breadcrumb</span> <span class="attr">class</span>=<span class="string">&quot;breadcrumb&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;/&quot;</span> <span class="attr">style</span>=<span class="string">&quot;float:left;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-breadcrumb-item</span> <span class="attr">v-for</span>=<span class="string">&quot;(node, index) in pathArr&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-if</span>=<span class="string">&quot;node.disable &amp;&amp; index&lt;pathArr.length-1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;disable&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;&#123;&#x27;last&#x27;:index==pathArr.length-1&#125;&quot;</span>&gt;</span>&#123;&#123;parse(node.label)&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-else</span> <span class="attr">:class</span>=<span class="string">&quot;&#123;&#x27;last&#x27;:index==pathArr.length-1&#125;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;javascript:;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;change(node.key,node.disable)&quot;</span>&gt;</span>&#123;&#123;parse(node.label)&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">el-breadcrumb-item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-breadcrumb</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">v-if</span>=<span class="string">&quot;showBack&amp;&amp;pathArr.length&gt;1&quot;</span> <span class="attr">style</span>=<span class="string">&quot;float:right;padding:0;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;back&quot;</span>&gt;</span>返回上一级<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">/**</span><br><span class="line"> * 页面内部使用的面包屑组件（URL不变,不适用router跳转）</span><br><span class="line"> */</span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  name: <span class="string">&quot;InnerBreadcrumb&quot;</span>,</span></span><br><span class="line">  props: &#123;</span><br><span class="line">    value: &#123;</span><br><span class="line"><span class="javascript">      type: <span class="built_in">String</span>,</span></span><br><span class="line">    &#125;,</span><br><span class="line">    path: &#123;</span><br><span class="line"><span class="javascript">      type: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="javascript">      required: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 形如：</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>: &#123;</span></span><br><span class="line"><span class="javascript">        label: <span class="string">&quot;一级页面&quot;</span>,</span></span><br><span class="line"><span class="javascript">        key: <span class="string">&quot;1&quot;</span>,</span></span><br><span class="line">        children: [</span><br><span class="line">          &#123;</span><br><span class="line"><span class="javascript">            key: <span class="string">&quot;2A&quot;</span>,</span></span><br><span class="line"><span class="javascript">            label: <span class="string">&quot;二级页面A&quot;</span></span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line"><span class="javascript">            key: <span class="string">&quot;2B&quot;</span>,</span></span><br><span class="line"><span class="javascript">            label: <span class="string">&quot;二级页面B&quot;</span>,</span></span><br><span class="line"><span class="javascript">            disable: <span class="literal">true</span>,</span></span><br><span class="line">            children: [</span><br><span class="line">              &#123;</span><br><span class="line"><span class="javascript">                key: <span class="string">&quot;3&quot;</span>,</span></span><br><span class="line"><span class="javascript">                label: <span class="string">&quot;三级页面&quot;</span></span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    showBack:&#123; <span class="comment">// 是否显示返回上一级</span></span></span><br><span class="line"><span class="javascript">      type: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>: <span class="literal">false</span></span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    showInRoot: &#123; <span class="comment">// 是否在根目录显示</span></span></span><br><span class="line"><span class="javascript">      type: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>: <span class="literal">false</span></span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    labelArgs:&#123; <span class="comment">// 用于回显的参数 例如在 label 中使用 &#x27;设置:&#123;info&#125;&#x27;,在 labelArgs传入&#123;info:&#x27;用户信息&#x27;&#125; 即可</span></span></span><br><span class="line"><span class="javascript">      type: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="javascript">      <span class="keyword">default</span>: &#123;&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="javascript">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      pathMap: <span class="literal">null</span>,</span></span><br><span class="line"><span class="javascript">      root: <span class="literal">null</span>,</span></span><br><span class="line">      pathArr: []</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  watch: &#123;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">value</span>(<span class="params">val</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.buildPath(val);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">init</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> path = <span class="built_in">this</span>.path;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.root = path.key;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> pathMap = &#123;&#125;;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 遍历path树,给每个节点加上父节点的key，parentKey空则是根节点</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> traverse = <span class="function">(<span class="params">node, parentKey</span>) =&gt;</span> &#123;</span></span><br><span class="line">        node.parentKey = parentKey;</span><br><span class="line">        pathMap[node.key] = node;</span><br><span class="line">        if (node.children &amp;&amp; node.children.length) &#123;</span><br><span class="line"><span class="javascript">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; node.children.length; i++) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> child = node.children[i];</span></span><br><span class="line">            traverse(child, node.key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      traverse(path);</span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.pathMap = pathMap;</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">buildPath</span>(<span class="params">key</span>)</span> &#123;</span></span><br><span class="line">      if(!key)</span><br><span class="line"><span class="javascript">        <span class="keyword">return</span>;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 建立路径数组</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> node = <span class="built_in">this</span>.pathMap[key];</span></span><br><span class="line">      if (!node) &#123;</span><br><span class="line"><span class="javascript">        <span class="comment">// console.warn(&quot;InnerBreadcrumb 找不到key:&quot; + key);</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span>;</span></span><br><span class="line">      &#125;</span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> arr = [];</span></span><br><span class="line"><span class="javascript">      <span class="keyword">while</span> (node) &#123;</span></span><br><span class="line">        arr.push(node);</span><br><span class="line"><span class="javascript">        node = <span class="built_in">this</span>.pathMap[node.parentKey];</span></span><br><span class="line">      &#125;</span><br><span class="line">      arr.reverse();</span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.pathArr = arr;</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">parse</span>(<span class="params">label</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> reg = <span class="regexp">/\&#123;[^\&#125;]+\&#125;/g</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> labelCopy = label; <span class="comment">// 复制一份</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> match;</span></span><br><span class="line">      /* match的值</span><br><span class="line"><span class="javascript">        <span class="number">0</span>: <span class="string">&quot;&#123;abc&#125;&quot;</span></span></span><br><span class="line"><span class="javascript">        groups: <span class="literal">undefined</span></span></span><br><span class="line">        index: 3</span><br><span class="line"><span class="javascript">        input: <span class="string">&quot;123&#123;abc&#125;,&#123;b&#125;&quot;</span></span></span><br><span class="line">      */</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">while</span>(<span class="params">(match = reg.exec(label))!=<span class="literal">null</span></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> key = match[<span class="number">0</span>].substr(<span class="number">1</span>,match[<span class="number">0</span>].length-<span class="number">2</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> value = <span class="built_in">this</span>.labelArgs[key];</span></span><br><span class="line">        if (value)&#123;</span><br><span class="line"><span class="javascript">          <span class="comment">// console.warn(&#x27;InnerBreadcrumb 找不到参数:&#x27;, key);</span></span></span><br><span class="line">          labelCopy = labelCopy.replace(match[0],value);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> labelCopy;</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">change</span>(<span class="params">key, disable</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (disable) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// console.log(key);</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.$emit(<span class="string">&quot;input&quot;</span>, key);</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">back</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">if</span>(<span class="params"><span class="built_in">this</span>.pathArr &amp;&amp; <span class="built_in">this</span>.pathArr.length&gt;<span class="number">1</span></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="built_in">this</span>.pathArr.length-<span class="number">2</span>; i &gt;=<span class="number">0</span>; i--) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> node = <span class="built_in">this</span>.pathArr[i];</span></span><br><span class="line">          if (!node.disable)&#123;</span><br><span class="line"><span class="javascript">            <span class="built_in">this</span>.change(node.key);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span>;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.warn(<span class="string">&#x27;InnerBreadcrumb 没有非disalbe的上级路径&#x27;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="javascript">  <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;&#125;,</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">this</span>.init();</span></span><br><span class="line"><span class="javascript">    <span class="built_in">this</span>.buildPath(<span class="built_in">this</span>.value);</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;scss&quot;</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-class">.inner-breadcrumb</span> &#123;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.breadcrumb</span>&#123;</span></span><br><span class="line">    span &#123;</span><br><span class="line">      font-weight: normal;</span><br><span class="line"><span class="css">      <span class="selector-tag">color</span>: <span class="selector-id">#aaa</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line">    a &#123;</span><br><span class="line">      font-weight: normal;</span><br><span class="line"><span class="css">      <span class="selector-tag">color</span>: <span class="selector-id">#aaa</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span>&#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">color</span>: <span class="selector-id">#409EFF</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-class">.last</span>&#123;</span></span><br><span class="line">      font-weight: bold!important;</span><br><span class="line">      cursor: default!important;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-class">.disable</span>&#123;</span></span><br><span class="line">      cursor: default!important;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>万年历是如何计算的，python实现</title>
    <link href="/2019/07/01/%E4%B8%87%E5%B9%B4%E5%8E%86%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%E7%9A%84/"/>
    <url>/2019/07/01/%E4%B8%87%E5%B9%B4%E5%8E%86%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%E7%9A%84/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">lzlz000的个人主页</a></p><p>网上能搜到不少万年历的代码，但是这应该是最详细的万年历介绍，有对天文历法、农历转换原理的的详细介绍</p><p>一份万年历应该包含的内容有公历公元纪年、日期、星期；农历干支纪年、日期、二十四节气。本文主要写的是以一个给定的公历日期来查询星期，农历日期，至于节日，完全可以根据给定的公历农历日期、星期查表获得，比较简单不再描述, 例如这样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 公历节日字典</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;1001&#x27;</span>: <span class="string">&#x27;国庆节&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0501&#x27;</span>: <span class="string">&#x27;劳动节&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 农历节日字典 需要注意的是除夕的判断，由于农历12月有可能有29或者30天，需要判断处理</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;0101&#x27;</span>: <span class="string">&#x27;春节&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0815&#x27;</span>: <span class="string">&#x27;重阳节&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 公历月份星期节日 520即 5月第2个星期日</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;520&#x27;</span> : <span class="string">&#x27;母亲节&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;1021&#x27;</span> : <span class="string">&#x27;10月第2个星期1 不好意思今天没有节日&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>至于宜忌，(・∀・(・∀・(・∀・*)，我觉得我写的是一篇科普向的文章，封建迷信就算了吧，据我所知，程序对这种内容八成是随机生成的，或者爬黄历网站的数据，然而还有人相信，权当自我安慰吧。</p><h3 id="公历"><a href="#公历" class="headerlink" title="公历"></a>公历</h3><p>公历是一种太阳历，即以地球绕日公转为基础制定的历法。以地球自转一周为一天，一年有365.2422天（回归年，历法基本以回归年为基准，回归年以太阳直射地球的纬度的回归周期计算，恒星年（以地球在公转轨道的位置回归周期计算）和回归年有小的差别，因为地球自转轴是在摆动的）。</p><h4 id="闰年"><a href="#闰年" class="headerlink" title="闰年"></a>闰年</h4><p>为了弥补自传和公转的插值，保证每一年的同一天太阳直射地球的纬度大致相同（否则会出不同年的同一天所在的季节一直在变化），就产生了闰年，其规则为每400年有97个闰年，四年一闰，百年不闰，四百年再闰。用代码来表达:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 判断公元纪年是否为闰年</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_leap_year</span>(<span class="params">year:<span class="built_in">int</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> year % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> year % <span class="number">100</span> == <span class="number">0</span> <span class="keyword">and</span> year % <span class="number">400</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> year % <span class="number">100</span> != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h4 id="星期"><a href="#星期" class="headerlink" title="星期"></a>星期</h4><p><strong>蔡勒（Zeller）公式</strong> 是一个计算星期的公式，是一个简化星期的计算的技巧，给出一个日期，就能用这个公式推算出是星期几。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zeller</span>(<span class="params">year: <span class="built_in">int</span>, month: <span class="built_in">int</span>, day: <span class="built_in">int</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    蔡勒公式,计算指定年月日是星期几的算法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param year:  年</span></span><br><span class="line"><span class="string">    :param month: 月</span></span><br><span class="line"><span class="string">    :param day:   日</span></span><br><span class="line"><span class="string">    :return: 0-星期日，1-星期一，2-星期二，3-星期三，4-星期四，5-星期五，6-星期六</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 在蔡勒公式中，某年的1、2月要看作上一年的13、14月来计算，比如2019年1月1日要看作2018年的13月1日来计算</span></span><br><span class="line">    <span class="keyword">if</span> month &lt; <span class="number">3</span>:</span><br><span class="line">        m = month + <span class="number">12</span></span><br><span class="line">        year = year - <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        m = month</span><br><span class="line">    <span class="comment"># 公元前1年和公元元年(1年)相邻，没有0年</span></span><br><span class="line">    <span class="keyword">if</span> year == <span class="number">0</span>:</span><br><span class="line">        year = <span class="number">-1</span></span><br><span class="line">    y = year % <span class="number">100</span>  <span class="comment"># 取年的后两位</span></span><br><span class="line">    <span class="comment"># 世纪 取已经经过的世纪，即20xx取20而不是21世纪</span></span><br><span class="line">    c = (year - y) / <span class="number">100</span></span><br><span class="line">    <span class="comment"># 注意，如果年份是公元前的年份且非整百数的话，c应该等于所在世纪的编号，如公元前253年，是公元前3世纪</span></span><br><span class="line">    <span class="keyword">if</span> c &lt; <span class="number">0</span> <span class="keyword">and</span> y != <span class="number">0</span>:</span><br><span class="line">        c -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> (y + <span class="built_in">int</span>(y / <span class="number">4</span>) + <span class="built_in">int</span>(c / <span class="number">4</span>) - <span class="number">2</span> * c + <span class="built_in">int</span>(<span class="number">26</span> * (m + <span class="number">1</span>) / <span class="number">10</span>) + day - <span class="number">1</span>) % <span class="number">7</span></span><br></pre></td></tr></table></figure><h3 id="农历"><a href="#农历" class="headerlink" title="农历"></a>农历</h3><p>农历是混合历，日期记录以月亮历为基础，月球绕地公转周期约29.53059日，因此农历有大小月之分，大月30天小月29天。</p><h4 id="农历日期"><a href="#农历日期" class="headerlink" title="农历日期"></a>农历日期</h4><p>农历实际上没有非常强的规律性，它的定义是依赖天文观测值推算的，因此通常存储当前前后一百多年的观测/推算值作为农历数据，因此，所谓万年历是假的，大多数只能查询1900-2049这段时间的农历日期。</p><p>个人认为，这其实就是中国传统天文历法的缺陷性，观测只是手段，甚至无法用规律性的公式来表达历法，只能查表，没有追求对天体规律的研究，而把天象当作凶吉之兆，真是非常可惜的。要知道，西方文明对于天体运动的精确观测和规律的研究对牛顿提出万有引力定律和力学定律产生了直接的影响（再说牛顿被苹果砸想出万有引力定律的拖出去枪毙五分钟），从此我们知道了天上的星星和地上的人遵循着同样的运行规则。我们的文明智慧是不差的，点错了科技树实在是可惜啊。</p><p>当前日期和初始日期的间隔来得到具体是农历年月日以及是否为闰月</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="comment"># from datetime import timedelta</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1900-2049年的农历数据表,5个16进制数，共20bit</span></span><br><span class="line"><span class="comment"># - 前4位，在这一年是润年时才有意义，它代表这年润月的大小月，为1则润大月，为0则润小月。</span></span><br><span class="line"><span class="comment"># - 中间12位，即4bit，每位代表一个月，为1则为大月，为0则为小月。</span></span><br><span class="line"><span class="comment"># - 最后4位，即8，代表这一年的润月月份，为0则不润。首4位要与末4位搭配使用</span></span><br><span class="line">lunar_info = [<span class="number">0x04bd8</span>, <span class="number">0x04ae0</span>, <span class="number">0x0a570</span>, <span class="number">0x054d5</span>, <span class="number">0x0d260</span>, <span class="number">0x0d950</span>, <span class="number">0x16554</span>, <span class="number">0x056a0</span>, <span class="number">0x09ad0</span>, <span class="number">0x055d2</span>,</span><br><span class="line">              <span class="number">0x04ae0</span>, <span class="number">0x0a5b6</span>, <span class="number">0x0a4d0</span>, <span class="number">0x0d250</span>, <span class="number">0x1d255</span>, <span class="number">0x0b540</span>, <span class="number">0x0d6a0</span>, <span class="number">0x0ada2</span>, <span class="number">0x095b0</span>, <span class="number">0x14977</span>,</span><br><span class="line">              <span class="number">0x04970</span>, <span class="number">0x0a4b0</span>, <span class="number">0x0b4b5</span>, <span class="number">0x06a50</span>, <span class="number">0x06d40</span>, <span class="number">0x1ab54</span>, <span class="number">0x02b60</span>, <span class="number">0x09570</span>, <span class="number">0x052f2</span>, <span class="number">0x04970</span>,</span><br><span class="line">              <span class="number">0x06566</span>, <span class="number">0x0d4a0</span>, <span class="number">0x0ea50</span>, <span class="number">0x06e95</span>, <span class="number">0x05ad0</span>, <span class="number">0x02b60</span>, <span class="number">0x186e3</span>, <span class="number">0x092e0</span>, <span class="number">0x1c8d7</span>, <span class="number">0x0c950</span>,</span><br><span class="line">              <span class="number">0x0d4a0</span>, <span class="number">0x1d8a6</span>, <span class="number">0x0b550</span>, <span class="number">0x056a0</span>, <span class="number">0x1a5b4</span>, <span class="number">0x025d0</span>, <span class="number">0x092d0</span>, <span class="number">0x0d2b2</span>, <span class="number">0x0a950</span>, <span class="number">0x0b557</span>,</span><br><span class="line">              <span class="number">0x06ca0</span>, <span class="number">0x0b550</span>, <span class="number">0x15355</span>, <span class="number">0x04da0</span>, <span class="number">0x0a5d0</span>, <span class="number">0x14573</span>, <span class="number">0x052d0</span>, <span class="number">0x0a9a8</span>, <span class="number">0x0e950</span>, <span class="number">0x06aa0</span>,</span><br><span class="line">              <span class="number">0x0aea6</span>, <span class="number">0x0ab50</span>, <span class="number">0x04b60</span>, <span class="number">0x0aae4</span>, <span class="number">0x0a570</span>, <span class="number">0x05260</span>, <span class="number">0x0f263</span>, <span class="number">0x0d950</span>, <span class="number">0x05b57</span>, <span class="number">0x056a0</span>,</span><br><span class="line">              <span class="number">0x096d0</span>, <span class="number">0x04dd5</span>, <span class="number">0x04ad0</span>, <span class="number">0x0a4d0</span>, <span class="number">0x0d4d4</span>, <span class="number">0x0d250</span>, <span class="number">0x0d558</span>, <span class="number">0x0b540</span>, <span class="number">0x0b5a0</span>, <span class="number">0x195a6</span>,</span><br><span class="line">              <span class="number">0x095b0</span>, <span class="number">0x049b0</span>, <span class="number">0x0a974</span>, <span class="number">0x0a4b0</span>, <span class="number">0x0b27a</span>, <span class="number">0x06a50</span>, <span class="number">0x06d40</span>, <span class="number">0x0af46</span>, <span class="number">0x0ab60</span>, <span class="number">0x09570</span>,</span><br><span class="line">              <span class="number">0x04af5</span>, <span class="number">0x04970</span>, <span class="number">0x064b0</span>, <span class="number">0x074a3</span>, <span class="number">0x0ea50</span>, <span class="number">0x06b58</span>, <span class="number">0x055c0</span>, <span class="number">0x0ab60</span>, <span class="number">0x096d5</span>, <span class="number">0x092e0</span>,</span><br><span class="line">              <span class="number">0x0c960</span>, <span class="number">0x0d954</span>, <span class="number">0x0d4a0</span>, <span class="number">0x0da50</span>, <span class="number">0x07552</span>, <span class="number">0x056a0</span>, <span class="number">0x0abb7</span>, <span class="number">0x025d0</span>, <span class="number">0x092d0</span>, <span class="number">0x0cab5</span>,</span><br><span class="line">              <span class="number">0x0a950</span>, <span class="number">0x0b4a0</span>, <span class="number">0x0baa4</span>, <span class="number">0x0ad50</span>, <span class="number">0x055d9</span>, <span class="number">0x04ba0</span>, <span class="number">0x0a5b0</span>, <span class="number">0x15176</span>, <span class="number">0x052b0</span>, <span class="number">0x0a930</span>,</span><br><span class="line">              <span class="number">0x07954</span>, <span class="number">0x06aa0</span>, <span class="number">0x0ad50</span>, <span class="number">0x05b52</span>, <span class="number">0x04b60</span>, <span class="number">0x0a6e6</span>, <span class="number">0x0a4e0</span>, <span class="number">0x0d260</span>, <span class="number">0x0ea65</span>, <span class="number">0x0d530</span>,</span><br><span class="line">              <span class="number">0x05aa0</span>, <span class="number">0x076a3</span>, <span class="number">0x096d0</span>, <span class="number">0x04bd7</span>, <span class="number">0x04ad0</span>, <span class="number">0x0a4d0</span>, <span class="number">0x1d0b6</span>, <span class="number">0x0d250</span>, <span class="number">0x0d520</span>, <span class="number">0x0dd45</span>,</span><br><span class="line">              <span class="number">0x0b5a0</span>, <span class="number">0x056d0</span>, <span class="number">0x055b2</span>, <span class="number">0x049b0</span>, <span class="number">0x0a577</span>, <span class="number">0x0a4b0</span>, <span class="number">0x0aa50</span>, <span class="number">0x1b255</span>, <span class="number">0x06d20</span>, <span class="number">0x0ada0</span>]</span><br><span class="line">gan = [<span class="string">&quot;甲&quot;</span>, <span class="string">&quot;乙&quot;</span>, <span class="string">&quot;丙&quot;</span>, <span class="string">&quot;丁&quot;</span>, <span class="string">&quot;戊&quot;</span>, <span class="string">&quot;己&quot;</span>, <span class="string">&quot;庚&quot;</span>, <span class="string">&quot;辛&quot;</span>, <span class="string">&quot;壬&quot;</span>, <span class="string">&quot;癸&quot;</span>]</span><br><span class="line">zhi = [<span class="string">&quot;子&quot;</span>, <span class="string">&quot;丑&quot;</span>, <span class="string">&quot;寅&quot;</span>, <span class="string">&quot;卯&quot;</span>, <span class="string">&quot;辰&quot;</span>, <span class="string">&quot;巳&quot;</span>, <span class="string">&quot;午&quot;</span>, <span class="string">&quot;未&quot;</span>, <span class="string">&quot;申&quot;</span>, <span class="string">&quot;酉&quot;</span>, <span class="string">&quot;戌&quot;</span>, <span class="string">&quot;亥&quot;</span>]</span><br><span class="line">mon_str = [<span class="string">&#x27;正&#x27;</span>, <span class="string">&#x27;二&#x27;</span>, <span class="string">&#x27;三&#x27;</span>, <span class="string">&#x27;四&#x27;</span>, <span class="string">&#x27;五&#x27;</span>, <span class="string">&#x27;六&#x27;</span>, <span class="string">&#x27;七&#x27;</span>, <span class="string">&#x27;八&#x27;</span>, <span class="string">&#x27;九&#x27;</span>, <span class="string">&#x27;十&#x27;</span>, <span class="string">&#x27;十一&#x27;</span>, <span class="string">&#x27;腊&#x27;</span>]</span><br><span class="line">day_str1 = [<span class="string">&#x27;初&#x27;</span>, <span class="string">&#x27;十&#x27;</span>, <span class="string">&#x27;廿&#x27;</span>]</span><br><span class="line">day_str2 = [<span class="string">&#x27;一&#x27;</span>, <span class="string">&#x27;二&#x27;</span>, <span class="string">&#x27;三&#x27;</span>, <span class="string">&#x27;四&#x27;</span>, <span class="string">&#x27;五&#x27;</span>, <span class="string">&#x27;六&#x27;</span>, <span class="string">&#x27;七&#x27;</span>, <span class="string">&#x27;八&#x27;</span>, <span class="string">&#x27;九&#x27;</span>, <span class="string">&#x27;十&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始条件：1900年1月31日为农历正月初一</span></span><br><span class="line">first_lunar_day = datetime(<span class="number">1900</span>, <span class="number">1</span>, <span class="number">31</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取一个农历年有多少天</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum_days</span>(<span class="params">offset</span>):</span></span><br><span class="line">    info = lunar_info[offset]</span><br><span class="line">    <span class="comment"># 获取月份信息</span></span><br><span class="line">    month_info = (info &amp; <span class="number">0x0ffff</span>) &gt;&gt; <span class="number">4</span></span><br><span class="line">    big_month_count = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 循环计数有多少位二进制1，原理如下：</span></span><br><span class="line">    <span class="comment"># (2)10101 - 1 = (2)10100,  </span></span><br><span class="line">    <span class="comment"># (2)10101 &amp; (2)10100 = (2)10100</span></span><br><span class="line">    <span class="comment"># (2)10100 - 1 = (2)10011</span></span><br><span class="line">    <span class="comment"># (2)10100 &amp; (2)10011 = (2)10000</span></span><br><span class="line">    <span class="comment"># 所有二进制值-1得到的结果有这样的特点：最后一位1变成0,最后一位1之后的0都变成1，其他不变</span></span><br><span class="line">    <span class="comment"># 这样取 &amp; 运算会得到把最后一位1置为0的效果，循环次数便为1的数量</span></span><br><span class="line">    <span class="keyword">while</span> month_info != <span class="number">0</span>:</span><br><span class="line">        month_info = month_info &amp; (month_info - <span class="number">1</span>)</span><br><span class="line">        big_month_count += <span class="number">1</span></span><br><span class="line">    days = <span class="number">29</span> * <span class="number">12</span> + big_month_count</span><br><span class="line">    <span class="comment"># 如果有闰月</span></span><br><span class="line">    <span class="keyword">if</span> (info &amp; <span class="number">0x0000f</span>) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 闰月是否为大月</span></span><br><span class="line">        <span class="keyword">if</span> (info &amp; <span class="number">0x10000</span>) &gt; <span class="number">0</span>:</span><br><span class="line">            days += <span class="number">30</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            days += <span class="number">29</span></span><br><span class="line">    <span class="keyword">return</span> days</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">month_str</span>(<span class="params">month</span>):</span></span><br><span class="line">    <span class="keyword">return</span> mon_str[month - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">day_str</span>(<span class="params">day</span>):</span></span><br><span class="line">    <span class="keyword">if</span> day == <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;初十&quot;</span></span><br><span class="line">    <span class="keyword">if</span> day == <span class="number">20</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;二十&quot;</span></span><br><span class="line">    <span class="keyword">if</span> day == <span class="number">30</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;三十&quot;</span></span><br><span class="line">    <span class="keyword">return</span> day_str1[<span class="built_in">int</span>(day / <span class="number">10</span>)] + day_str2[day % <span class="number">10</span> - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ganzhi_year</span>(<span class="params">year</span>):</span></span><br><span class="line">    offset = year - <span class="number">1864</span>  <span class="comment"># 1864是一个甲子年</span></span><br><span class="line">    <span class="keyword">return</span> gan[offset % <span class="number">10</span>] + zhi[offset % <span class="number">12</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取在指定年之前有多少天</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lunar_str</span>(<span class="params">year, month, day</span>):</span></span><br><span class="line">    interval_days = (datetime(year, month, day) - first_lunar_day).days + <span class="number">1</span></span><br><span class="line">    <span class="comment"># print(&#x27;interval_days&#x27;, interval_days)</span></span><br><span class="line">    sum_day = <span class="number">0</span></span><br><span class="line">    year_offset = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        temp = sum_day + sum_days(year_offset)</span><br><span class="line">        <span class="keyword">if</span> temp &gt;= interval_days:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        year_offset += <span class="number">1</span></span><br><span class="line">        sum_day = temp</span><br><span class="line">    info = lunar_info[year_offset]  <span class="comment"># 所在年的信息</span></span><br><span class="line">    rest_days = interval_days - sum_day  <span class="comment"># 还剩下多少天没有计算</span></span><br><span class="line">    month = <span class="number">0</span></span><br><span class="line">    month_info = (info &amp; <span class="number">0x0ffff</span>) &gt;&gt; <span class="number">4</span></span><br><span class="line">    leap_month = info &amp; <span class="number">0x0000ff</span></span><br><span class="line">    has_leap_month = leap_month &gt; <span class="number">0</span></span><br><span class="line">    leap_month -= <span class="number">1</span></span><br><span class="line">    days = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">12</span>):</span><br><span class="line">        temp = days</span><br><span class="line">        <span class="comment"># 判断是否为大月</span></span><br><span class="line">        temp += <span class="number">30</span> <span class="keyword">if</span> (<span class="number">0x800</span> &gt;&gt; i) &amp; month_info &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">29</span></span><br><span class="line">        <span class="keyword">if</span> temp &gt;= rest_days:</span><br><span class="line">            month = i + <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        days = temp</span><br><span class="line">        <span class="keyword">if</span> has_leap_month <span class="keyword">and</span> i == leap_month:</span><br><span class="line">            temp += <span class="number">30</span> <span class="keyword">if</span> (info &amp; <span class="number">0x10000</span>) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">29</span>  <span class="comment"># 闰月是大月还是小月</span></span><br><span class="line">        <span class="keyword">if</span> temp &gt;= rest_days:</span><br><span class="line">            month = <span class="string">&quot;闰&quot;</span> + <span class="built_in">str</span>(i + <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        days = temp</span><br><span class="line">    day = rest_days - days</span><br><span class="line">    <span class="comment"># 注意农历和下一年公历重叠的情况</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#123;0&#125;年 &#123;1&#125;月&#123;2&#125;&#x27;</span>.<span class="built_in">format</span>(ganzhi_year(<span class="number">1900</span> + year_offset),  month_str(month),  day_str(day))</span><br><span class="line"></span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">2</span>, <span class="number">5</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">3</span>, <span class="number">6</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">5</span>, <span class="number">4</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">6</span>, <span class="number">2</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">7</span>, <span class="number">2</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">10</span>, <span class="number">26</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">10</span>, <span class="number">27</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">11</span>, <span class="number">25</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">11</span>, <span class="number">26</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">12</span>, <span class="number">25</span>))</span><br><span class="line">print(lunar_str(<span class="number">2000</span>, <span class="number">12</span>, <span class="number">26</span>))</span><br><span class="line">print(lunar_str(<span class="number">2001</span>, <span class="number">1</span>, <span class="number">23</span>))</span><br><span class="line">print(lunar_str(<span class="number">2001</span>, <span class="number">1</span>, <span class="number">24</span>))</span><br><span class="line">print(lunar_str(<span class="number">2019</span>, <span class="number">7</span>, <span class="number">2</span>))</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">庚辰年 正月初一</span><br><span class="line">庚辰年 二月初一</span><br><span class="line">庚辰年 三月初一</span><br><span class="line">庚辰年 四月初一</span><br><span class="line">庚辰年 五月初一</span><br><span class="line">庚辰年 六月初一</span><br><span class="line">庚辰年 九月廿九</span><br><span class="line">庚辰年 十月初一</span><br><span class="line">庚辰年 十月三十</span><br><span class="line">庚辰年 十一月初一</span><br><span class="line">庚辰年 十一月三十</span><br><span class="line">庚辰年 腊月初一</span><br><span class="line">庚辰年 腊月廿九</span><br><span class="line">辛巳年 正月初一</span><br><span class="line">己亥年 五月三十</span><br></pre></td></tr></table></figure><h4 id="二十四节气"><a href="#二十四节气" class="headerlink" title="二十四节气"></a>二十四节气</h4><p>24节气是太阳历，其定义以地球在绕日轨道上的位置为基准，冬至即太阳照射到地球南回归线上的时刻，夏至为北回归线，春分秋分就是太阳直射赤道的时刻，所以二十四节气的是有精确的时刻，这个时刻所在的那一天便是节气的日期。由于地球日和公转回归年的差异，这个日期会在一两天内摇摆。</p><p>节气的定法有两种。古代历法采用的称为”恒气”，即按时间把一年等分为24份，每一节气平均得15天有余，所以又称”平气”。现代农历采用的称为”定气”，即按地球在轨道上的位置为标准，一周360°，两节气之间相隔15°。由于地球的公转轨道其实是椭圆，冬至时地球位于近日点附近，运动速度较快，因而太阳在黄道上移动15°的时间不到15天。夏至前后的情况正好相反，太阳在黄道上移动较慢，一个节气达16天之多。采用定气时可以保证春、秋两分必然在昼夜平分的那两天，可以更好的体现节气对季节的区分作用。</p><p>定义24个节气与第一个节气所相差的时间长度（分钟），然后以一个确定的时刻作为标准，上面已经说过一个公转回归年为365.2422天即 525948.768分钟，由于节气均不在元旦日期附近，即使由于闰年相差一两天也不会跨年，直接以年份和基准节气时间（本例中的1900年1月6日 2:05:00AM）的间隔*525948.768 数加上当前节气时间间隔数便是本年24节气的时间。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">solarTerm = [<span class="string">&quot;小寒&quot;</span>, <span class="string">&quot;大寒&quot;</span>, <span class="string">&quot;立春&quot;</span>, <span class="string">&quot;雨水&quot;</span>, <span class="string">&quot;惊蛰&quot;</span>, <span class="string">&quot;春分&quot;</span>, <span class="string">&quot;清明&quot;</span>, <span class="string">&quot;谷雨&quot;</span>, <span class="string">&quot;立夏&quot;</span>, <span class="string">&quot;小满&quot;</span>, <span class="string">&quot;芒种&quot;</span>, <span class="string">&quot;夏至&quot;</span>, <span class="string">&quot;小暑&quot;</span>, <span class="string">&quot;大暑&quot;</span>, <span class="string">&quot;立秋&quot;</span>, <span class="string">&quot;处暑&quot;</span>, <span class="string">&quot;白露&quot;</span>, <span class="string">&quot;秋分&quot;</span>, <span class="string">&quot;寒露&quot;</span>, <span class="string">&quot;霜降&quot;</span>, <span class="string">&quot;立冬&quot;</span>, <span class="string">&quot;小雪&quot;</span>, <span class="string">&quot;大雪&quot;</span>, <span class="string">&quot;冬至&quot;</span>]</span><br><span class="line">sTermInfo = [<span class="number">0</span>, <span class="number">21208</span>, <span class="number">42467</span>, <span class="number">63836</span>, <span class="number">85337</span>, <span class="number">107014</span>, <span class="number">128867</span>, <span class="number">150921</span>, <span class="number">173149</span>, <span class="number">195551</span>, <span class="number">218072</span>, <span class="number">240693</span>, <span class="number">263343</span>, <span class="number">285989</span>, <span class="number">308563</span>, <span class="number">331033</span>, <span class="number">353350</span>, <span class="number">375494</span>, <span class="number">397447</span>, <span class="number">419210</span>, <span class="number">440795</span>, <span class="number">462224</span>, <span class="number">483532</span>, <span class="number">504758</span>]</span><br><span class="line"><span class="comment"># 1900年小寒</span></span><br><span class="line">solarTermBase = datetime(<span class="number">1900</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">57</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solar_term_of_year</span>(<span class="params">year</span>):</span></span><br><span class="line">    year_min = <span class="number">525948.768</span></span><br><span class="line">    base_year = <span class="number">1900</span></span><br><span class="line">    <span class="comment"># 指定年的小寒节气</span></span><br><span class="line">    first_term_of_year = solarTermBase + timedelta(minutes=(year - base_year) * year_min)</span><br><span class="line">    <span class="keyword">for</span> index,minutes <span class="keyword">in</span> <span class="built_in">enumerate</span>(sTermInfo):</span><br><span class="line">        term = first_term_of_year + timedelta(minutes=minutes)</span><br><span class="line">        <span class="comment"># print(term.strftime( &#x27;%Y-%m-%d %H:%M:%S&#x27;)+solarTerm[index])</span></span><br><span class="line">        print(term.strftime( <span class="string">&#x27;%Y-%m-%d&#x27;</span>)+solarTerm[index])</span><br><span class="line">      </span><br><span class="line">solar_term_of_year(<span class="number">2018</span>)</span><br></pre></td></tr></table></figure><p>注意，sTermInfo数据的不准确，计算出来的值和现在查询到的2019年精确值是有误差，如果刚好在0点附近就会产生日期不对的情况，我还没找到一个准确的数据可以使用，但是作为原理的介绍没有问题</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">2018-01-05小寒</span><br><span class="line">2018-01-20大寒</span><br><span class="line">2018-02-04立春</span><br><span class="line">2018-02-18雨水</span><br><span class="line">2018-03-05惊蛰</span><br><span class="line">2018-03-20春分</span><br><span class="line">2018-04-05清明</span><br><span class="line">2018-04-20谷雨</span><br><span class="line">2018-05-05立夏</span><br><span class="line">2018-05-21小满</span><br><span class="line">2018-06-06芒种</span><br><span class="line">2018-06-21夏至</span><br><span class="line">2018-07-07小暑</span><br><span class="line">2018-07-23大暑</span><br><span class="line">2018-08-07立秋</span><br><span class="line">2018-08-23处暑</span><br><span class="line">2018-09-08白露</span><br><span class="line">2018-09-23秋分</span><br><span class="line">2018-10-08寒露</span><br><span class="line">2018-10-23霜降</span><br><span class="line">2018-11-07立冬</span><br><span class="line">2018-11-22小雪</span><br><span class="line">2018-12-07大雪</span><br><span class="line">2018-12-22冬至</span><br></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>算法</tag>
      
      <tag>python</tag>
      
      <tag>探索与发现</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql的Ferderated引擎</title>
    <link href="/2019/06/25/mysql%E7%9A%84Ferderated%E5%BC%95%E6%93%8E/"/>
    <url>/2019/06/25/mysql%E7%9A%84Ferderated%E5%BC%95%E6%93%8E/</url>
    
    <content type="html"><![CDATA[<p><strong>Ferderated</strong> 引擎提供了以本地一张独立的表访问远程MySQL服务器上表的方法。本地不存储数据，数据全部放到远程服务器上，但是本地需要保存表结构和远程服务器的连接信息。</p><p>首先Ferderated引擎在mysql中是默认关闭的，可以使用 <strong>show engines</strong> 命令查看是否开启了该引擎：</p><p><img src="/images/1561399282036.png"></p><p>可以发现 Ferderated 的 support为 NO</p><p>我们需要在mysql配置文件中加入 federated</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">datadir&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line">socket&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line">federated #加入这一行</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>重启服务，会发现Ferderated 已经开启</p><p><img src="/images/1561399506237.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 在任意mysql服务器上创建一个表，作为Ferderated的目标远程服务器，该服务器不需要开启Ferderated引擎</span><br><span class="line"># 本例中，表创建在127.0.0.1:3307&#x2F;mysql-test</span><br><span class="line">CREATE TABLE remote_fed (</span><br><span class="line">id INT auto_increment NOT NULL,</span><br><span class="line">c1 VARCHAR ( 10 ) NOT NULL DEFAULT &#39;&#39;,</span><br><span class="line">c2 CHAR ( 10 ) NOT NULL DEFAULT &#39;&#39;,</span><br><span class="line">PRIMARY KEY ( id ) </span><br><span class="line">) ENGINE &#x3D; INNODB</span><br><span class="line"></span><br><span class="line"># 在开启了Ferderated引擎创建表</span><br><span class="line">CREATE TABLE local_fed (</span><br><span class="line">id INT auto_increment NOT NULL,</span><br><span class="line">c1 VARCHAR ( 10 ) NOT NULL DEFAULT &#39;&#39;,</span><br><span class="line">c2 CHAR ( 10 ) NOT NULL DEFAULT &#39;&#39;,</span><br><span class="line">PRIMARY KEY ( id ) </span><br><span class="line">) ENGINE&#x3D;federated CONNECTION &#x3D;&#39;mysql:&#x2F;&#x2F;root:123456@127.0.0.1:3307&#x2F;mysql-test&#x2F;remote_fed&#39;</span><br></pre></td></tr></table></figure><p>一些注意事项</p><ol><li>对本地虚拟表的结构修改，并不会修改远程表的结构，但是改变自身的表结构会出现意想不到的错误</li><li>truncate 命令，会清除远程表数据 </li><li> drop命令只会删除虚拟表，并不会删除远程表</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>自制hexo评论插件（一）</title>
    <link href="/2019/06/13/%E8%87%AA%E5%88%B6hexo%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2019/06/13/%E8%87%AA%E5%88%B6hexo%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p>hexo等静态博客，现在有很多可使用的评论插件，基本都需要繁琐的注册，国内的还需要实名制审核（我本人特别特别讨厌实名制审核，有一种我在网上干什么都有别人偷窥的感觉，虽然我是守法公民，但是即使我在床上只睡觉不干其他不可描述的事情，我也不希望有摄像头对着我拍不是吗？）我就在想，能不能自己做一个？</p><p>我仔细思考了一下，确实可以做，不过是一个前端界面和一个后端服务器。但是作为一个“插件”和一个前端页面还是有区别的，我希望能尽量让使用者简单的引入，最好启用一个服务器+引入一个js文件+少量配置就可以完成。</p><p>首先，不要太复杂的功能：基本功能针对每个页面的评论、回复、邮件即可，考虑后续加上markdown语法支持，管理界面等功能。</p><h3 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h3><p>我尝试使用了一些现有的插件，并试图模仿他们的样式并简化功能，于是我做出了下面这样的界面：</p><p><img src="/images/1560364377217.png"></p><p>是不是还挺像那么回事的😀？</p><p>这部分的代码如下:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#tiny-comment</span>&#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">10px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#ffffff</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#C0C4CC</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.tiny-container</span>&#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span> <span class="number">20px</span> <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.tiny-footer</span>&#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>  <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#262A30</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#999999</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">12px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.tiny-footer</span> <span class="selector-tag">a</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#258FB8</span>;</span><br><span class="line">    <span class="attribute">text-decoration</span>:none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-tag">input</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">150px</span>;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#C0C4CC</span>;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">margin-right</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-tag">input</span><span class="selector-pseudo">:focus</span>&#123;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#409EFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.input-wrapper</span>&#123;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> dashed <span class="number">#C0C4CC</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">20px</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.input-wrapper</span> <span class="selector-tag">textarea</span>&#123;</span><br><span class="line">    <span class="comment">/* border: 1px dashed #C0C4CC; */</span></span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">resize</span>: vertical;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">    <span class="attribute">-webkit-box-sizing</span>: border-box;</span><br><span class="line">    <span class="attribute">-moz-box-sizing</span>: border-box;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-tag">button</span>&#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#DCDFE6</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">    <span class="attribute">background</span>: transparent;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-tag">button</span><span class="selector-pseudo">:active</span>&#123;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#409EFF</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#409EFF</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.comment-count</span>&#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">10px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.segment</span>&#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">10px</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#DCDFE6</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.secondary</span>&#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">12px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#C0C4CC</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.segment</span> <span class="selector-class">.nickname</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#409EFF</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: default;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.comment-content</span>&#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">12px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.reply-btn</span>&#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">12px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#F56C6C</span>;</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.reply-btn</span><span class="selector-pseudo">:active</span>&#123;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">214</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.reply</span>&#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">5px</span> <span class="number">0</span> <span class="number">5px</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="number">#DCDFE6</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">13px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#tiny-comment</span> <span class="selector-class">.reply</span> <span class="selector-class">.comment-content</span>&#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;tiny-comment&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tiny-container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-wrapper&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;昵称&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;邮箱&quot;</span> <span class="attr">title</span>=<span class="string">&quot;邮箱不会公布，有新的回复时接收邮件&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;tiny-comment-textarea&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;你的留言...&quot;</span>  <span class="attr">rows</span>=<span class="string">&quot;5&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height:35px;&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">&quot;float:right;&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comment-count&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight: bold&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 评论<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;segment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;nickname&quot;</span>&gt;</span>匿名用户<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;secondary&quot;</span>&gt;</span>13秒前<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;reply-btn&quot;</span> <span class="attr">style</span>=<span class="string">&quot;float: right&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comment-content&quot;</span>&gt;</span></span><br><span class="line">            这是一条评论</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;segment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;nickname&quot;</span>&gt;</span>匿名用户<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;secondary&quot;</span>&gt;</span>13秒前<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;reply-btn&quot;</span> <span class="attr">style</span>=<span class="string">&quot;float: right&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comment-content&quot;</span>&gt;</span></span><br><span class="line">            这是一条评论</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;segment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;nickname&quot;</span>&gt;</span>匿名用户<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;secondary&quot;</span>&gt;</span>13秒前<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;reply-btn&quot;</span> <span class="attr">style</span>=<span class="string">&quot;float: right&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comment-content&quot;</span>&gt;</span></span><br><span class="line">            这是一条评论</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;reply&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;nickname&quot;</span>&gt;</span>匿名用户<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;secondary&quot;</span>&gt;</span>13秒前<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;reply-btn&quot;</span> <span class="attr">style</span>=<span class="string">&quot;float: right&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comment-content&quot;</span>&gt;</span>这是一条回复<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;reply&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;nickname&quot;</span>&gt;</span>匿名用户<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;secondary&quot;</span>&gt;</span>13秒前<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;reply-btn&quot;</span> <span class="attr">style</span>=<span class="string">&quot;float: right&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comment-content&quot;</span>&gt;</span>这是一条回复<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;reply&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;nickname&quot;</span>&gt;</span>匿名用户<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;secondary&quot;</span>&gt;</span>13秒前<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;reply-btn&quot;</span> <span class="attr">style</span>=<span class="string">&quot;float: right&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;comment-content&quot;</span>&gt;</span>这是一条回复<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;load-more&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span>&gt;</span>加载更多...<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tiny-footer&quot;</span>&gt;</span></span><br><span class="line">    Powerd by <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span>&gt;</span>lzlz000<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接下来，我们考虑如何让前端能简单的引入这个节点呢？</p><hr><p><a href="https://lzlz000.github.io/"><img src="https://img.shields.io/badge/lzlz000-%E4%B8%AA%E4%BA%BA%E7%A9%BA%E9%97%B4-brightgreen.svg?style=flat&logo=data:image/gif;base64,R0lGODlhPAA8APf/AP/TAHsbG6ZJAGsBAcertKL75+jsZ93teMTk+o5BRruVm+72/3ILC7OGjbS7zIIqK4QyNZDDtKFbWqZuc//sN/v//8+7xN7X4eDc5JFJTa59gsHtpL+cpJx9iZ1dYpnu431xae/4/5Jpc6H965RNUIqonPH8/7rJ3MOlq/bsTm4KC9bI0ZpZXcPh9opTW6NpbKl0eqVkZOzy/nkeH8Da79jM0nUaHJNDQ3wgIZ2Cj6mcq7f1vbaLkaSToYItL4wpAHUQEIs0M+3z+ptTVOnt9enu+JFjbNO+yMHc8e/3/N3V3tXGz4E8Qoy+t5ZxfK2ru9rR2ujr9cTj+GUAAMPi+Obm7bW+0P/aAMmxuaGLmLK1xrCxwXwuMvL8/7nG2Y09Qv/WAJZPVMh6AMLg9cDb8MDY7bLuvplWWp9gZevx/IVHTo4+PrfD1r/Y7O71+nYVFXgVFdC9xW4VFqORnsy2vn4lKHY1M9rP2YY2ObmSmHMWG8KhqHwzOeLg65FGSHspLXEOD7yYnolNVI46OY5cZWsHCOzx/evw+ubn8dbJztPDzYs7Pqx4fcWoros5OYk2OHAQEoJDVnETFHYTE3gXGO30//T///X///P//34nM4VLX77W6r/X68Lf9O31//H7//b//8Pi96pwd/L+/+zy/fD6//D7/8DZ7u/5//L//8Le8/P+/8Hd8r7U6L/X7L/W6m8HB4ZNYuz0/7vN4IMnJ9fK1I04N+akANLtiv/sMNPEzMXm+6aZp6ecq69/hKhra5hMS5dUWKL/9Ojq76H349bH0KnvzKLt1af32I2zpciAAH+AduGdAMTi97eQlpVJSIcvL28kIl8AAKdxd2sNFufp77+fpbrusu32/6Jnae31/LT1w5335rK3yO30/qFGAII5Prbttezw9qqgr6ynuMHe8sLd8ngjJ+jq8uns8aD45Ofo88uzvMu1vX84PnY4NnBHQHwxNrvtrYg9P3gSDI07PdjN1nYOBbGzxM65wNPEyfH6/6NfXuzz/r7V6QAAACH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS4zLWMwMTEgNjYuMTQ1NjYxLCAyMDEyLzAyLzA2LTE0OjU2OjI3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo4QUY2MjJFMDk2QTgxMUU5QjE4QTlEMjI1ODQ3MTdFQSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo4QUY2MjJFMTk2QTgxMUU5QjE4QTlEMjI1ODQ3MTdFQSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjhBRjYyMkRFOTZBODExRTlCMThBOUQyMjU4NDcxN0VBIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjhBRjYyMkRGOTZBODExRTlCMThBOUQyMjU4NDcxN0VBIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+Af/+/fz7+vn49/b19PPy8fDv7u3s6+rp6Ofm5eTj4uHg397d3Nva2djX1tXU09LR0M/OzczLysnIx8bFxMPCwcC/vr28u7q5uLe2tbSzsrGwr66trKuqqainpqWko6KhoJ+enZybmpmYl5aVlJOSkZCPjo2Mi4qJiIeGhYSDgoGAf359fHt6eXh3dnV0c3JxcG9ubWxramloZ2ZlZGNiYWBfXl1cW1pZWFdWVVRTUlFQT05NTEtKSUhHRkVEQ0JBQD8+PTw7Ojk4NzY1NDMyMTAvLi0sKyopKCcmJSQjIiEgHx4dHBsaGRgXFhUUExIREA8ODQwLCgkIBwYFBAMCAQAAIfkEAQAA/wAsAAAAADwAPAAACP8A/wkcSLCgwYL8oAEZwBAWjmcHI0qcSHHgDUo4/ExwhoJAIw6+WPh486CiyZMEKdl4EYdIKkuWMKVKhQlmCCV58KgggbLnwRkzFBC5ZGJBv6NIkVZCZamLPhKFfvn0GaOQBnGWjCb1tKCrp0pJK5mwlO8PjqknIZxLBEprvwWjLKVaUGRdFFKmYqIC208WJiEvCqGlOCNBOkxI80Zpx8jPgwCUAuB45CGQEhOYPB1dcEnBlMERcWRIUupoKUs1sgUAFI9Qhx69eGVxosYGoDV7hGACWwkUis+gCQ7CkwRVv0qrMLBQwSeLF1VUWnRS1WlMqBb+nhCCRKvRKOOyQAX/GhB8oKQqn2QswBQIEB9ynVqc2uSvvv36nFhJOSGiUJgqiFVyyQRvlDcAHZbIgEoSaBSSgzmd0HffhPedgkA3XASQiCVvJfEAP6AFwcIl/YTgRgZybIEAJxS2OKEqp7igQhwJjqIIeYPBgkEpnpgQhh5sYOfikPad0owRsNQwSj+XBHMDWoOgQaIljBRixRhEUtjKKaGQYV8bobgQQDWomGAPjj7BUssno8QxgA5SZEkhDQ44oYWQ/pxSxjlD7LbKImg9UMoCSdDiAgJyUkhFB9JIMg4CEnayxQDsrGJJIAH4NAgMl2DCQSEn0JDofZuccgI4UxSShRQs+oOAC9CU/3kBAz7BgQUmqPhgBKKj1rcJGTS00IogUwzghHz+kGEFLHSsEkIdPgFygSWKwOIAEr36swkNRjBhxS5IGDHFFITQUIY/UjDBAkwkxNATJVGAwsgfrEg4Kiec1CHNDFvsEkoHA0whyCuctJAFJUWAMsGTKOHgzSr1GBFntsk68McUgOgQihQ9qDCAA8BawcASoDQQRE91hHBIAHNgSbE/nczCRLE9jDEGPuNoy6INHFTAAzQ94YBKH0A8wcrL9SHBiQtTdIAdEqr4Wg4XGlRg8rv9KAGEFl4inScn+LRir31jMDFBBTAwfBIQfVwASDdde80JEq+02InZFZwhQU+TWP+ASNFHe03kJqxw4UsFEPgUhC/7BNBDJ4ITufMe2kwy1SOgPCLCxJG3SIPIdygCxFSwIAIDHxF23uIYc1BSyjSDTEVLAyuowIaoqk8ohSBhWDLDYAjj0AHnuftTxiyAYBEHrWhNwgEPNrTRavFU5EAJKl+AONgkGEySA/Gdu+KKDbSjiRYtEyigwiy4qy5FB0AU4YO7wQ1AgCNqSFF350iwUcgezgBEeQQCCSwwoAO8EpwrOuEOP9TCfMEZgg/yAIseJPBlm0CACN6wAhsMkCBrwIMGVNADf7XghChMoQpRGIpddEAFBICA2j74jzX44AxTiEQsNMHDHvrwhz2MRST/VMADPDiChgWRQCF+IIAmOvGJUIziN+hhA4ggsSCTYMYVAMDFLnrxi18Eww/CcEWDAOEWWwSjGsF4hR+U0SBf+IYyxEDHOtrxjni8xxsLAgxqZOKPgAykIAeph9HtcSAqgIIpKsHIRjrykY4MAToesLdDAiEPoKiEJ75igkt48pOgvIQlsLHJSmDigYf8Bw6S4BZULAEGooilLGWZPiHwpR+gQIMt9jg7Eh2lEl3wAzxAQMxiGlMOK/hEYqAAiz0yQAml+eU+EpAMYRTgmtgswAhGYIcjmEApXcDDHuuwSaV8IgElIIYBUpACMxyAndf4QDe/iRRLaOBkZcwAYsyJ/051yGMDGzhGOABqDHl6MymjwAIcyiiBdYXlnOnExQEmSlEzGJSeRzFFLQyJxIZyiJ8lUEcKckGBklIgFxu4aFJQcQGO0tCjD0XnCLaxg5raFBnceMdBkRKCPljuihLwgC9/2YVFLCMCTUiqUpMagWjs9CghkEGmrjiEDIjSLV1wBhcgwNWuepUEVcDGZjCBCQtA8IOSgIA10BGTEFSiFKQ4RBrSYAhS2NWuhkDFAkJQkyigYB4qoN8bKUEJFjQCA0wRJSZGYYLGmuAlogwBBlDAAkq8QSqpFMgQAvCGG2rAGu3QhT3ucIcl0MEavgiGDyYxgyFkViISCEIAgMAABgzAorZACEAQKgmagAAAOw=="></a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>hexo+typora 插入图片的简便解决方案</title>
    <link href="/2019/06/08/hexo-%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87/"/>
    <url>/2019/06/08/hexo-%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87/</url>
    
    <content type="html"><![CDATA[<p>hexo 官方有推荐的方式，但是结合实际使用，我的文章通过typora编辑，希望能得到所见即所得的效果，还能尽可能的减少重复操作。</p><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><p>通过搜索得到的解决方案最常见的是安装插件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-asset-image --save</span><br></pre></td></tr></table></figure><p>这个方式其实非常不好用，首先这插件是基于 hexo2开发的，在hexo3上使用有bug,解析的图片地址 都变成了形如  xxx/.io//xxx.png ，搜索下解决方法 ，还要自己手动去 node_modules 中修改脚本才能用，我们知道，node_modules 实际上都是npm install的时候自动生成的，这样的改动以后还要反复手动操作，太难受了，此方法不可取。</p><h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3><p>hexo官方给了两种解决方式 <a href="https://hexo.io/zh-cn/docs/asset-folders">https://hexo.io/zh-cn/docs/asset-folders</a> </p><p>一个是使用hexo的标签：</p><p><img src="/images/1559990605779.png"></p><p>这个方式看起来完美解决了问题，但是在我本地通过typora编辑文档时，是看不到图片的，不方便使用。</p><h3 id="方法3"><a href="#方法3" class="headerlink" title="方法3"></a>方法3</h3><p>使用最简单的方式在 source 目录下创建images目录，然后图片都保存在这里。</p><p>关键是要在typora上做以下设置：</p><p>在md文件头部的配置项中，添加 <code>typora-root-url: ../</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title:  hexo+typora 插入图片</span><br><span class="line">date: 2019-06-08 10:37:22</span><br><span class="line">tags:</span><br><span class="line">typora-root-url: ..&#x2F;</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>这样引用的图片都以上一级目录即 sourse作为根目录了，此时插入的图片时，只要点击“复制图片到…”并选择一次文件夹，以后每次都会自动保存在 sourse/image目录下，并且本地的显示和服务器上的根目录完全一致，使用体验还是很方便的。</p><p><img src="/images/1559989480817.png" alt="本地路径和服务器路径一致"></p>]]></content>
    
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hello hexo</title>
    <link href="/2019/06/07/hello-hexo/"/>
    <url>/2019/06/07/hello-hexo/</url>
    
    <content type="html"><![CDATA[<p>目前市面上常见的静态博客框架就是 <code>hexo</code> 和 <code>jekyll</code>，由于hexo基于node而jekyll基于ruby, 而node我相对熟悉一些，因此就是用了hexo。</p><hr><p><strong>之所以想搭建一个静态页面，有以下几个原因</strong></p><p>目前我的笔记分布于简书，有道云笔记和git仓库、坚果云等多个地方，普遍采用了markdown格式，我想统一汇总整理，把可以分享的内容发布出来，不分享的hexo也提供了存储的方式。虽然是菜鸟一枚，但有时候也能帮助到正好碰到相同问题的朋友，或者对一些问题谈谈自己的看法。</p><p>在我的印象中，github.io 以前常被墙，最近似乎解除了，这就有了一个非常好的地方存放这些内容。</p><p>国内的博客系统即使是分享一些技术文章，也有可能被和谐。比如我收藏了一些关于VPS搭建的文章就失踪了。</p><h3 id="目前的问题"><a href="#目前的问题" class="headerlink" title="目前的问题"></a>目前的问题</h3><p>我用了hexo的默认主题 landscape，稍微修改了下模板，修改了 banner图片，该图片是来自<a href="https://site.douban.com/163509/">https://site.douban.com/163509/</a> 页面背景上的像素画，我非常喜欢这张图。未经授权，但是也不是商业用途，我就擅自拿了，如有侵权,请告知我,我会删除。去除了正中间的大字标题，因为我看着不舒服。</p><p>还有一些问题，当前的分享功能都是twitter、fb、google什么的，我还不知道如何添加国内常用的分享方式，以及如何使用评论功能插件。</p><h4 id="迁移问题"><a href="#迁移问题" class="headerlink" title="迁移问题"></a>迁移问题</h4><p>我尝试迁移了一些已有的笔记文件，目前遇到以下问题:</p><ol><li>一些有单行代码的地方会出现格式错误，即便它在typora或者其他支持markdown语法的网站如github、简书是显示正常的</li><li>需要手动添加 yaml front matter</li></ol><p>目前看来，格式问题较多，每个页面要手动检查并修改格式，有外部图片链接的也要手动调整，虽然调整不是很麻烦，但工作量挺大。。。 我可能不会搬运所有的文档了，整理下搬运一些值得分享的东西，而不是琐碎的笔记。</p>]]></content>
    
    
    
    <tags>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx配置反向代理</title>
    <link href="/2019/04/09/nginx%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"/>
    <url>/2019/04/09/nginx%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nginx</span><br></pre></td></tr></table></figure><p>启动Nginx并设置开机自动运行 ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nginx.service</span><br><span class="line">systemctl enable nginx.service</span><br></pre></td></tr></table></figure><p>默认端口80<br>浏览器输入 服务器地址 即可看到 nginx的首页<br>yum 安装的 nginx 配置路径在 <strong>/etc/nginx/nginx.conf</strong> ,可以修改端口号再重启</p><h3 id="域名转发"><a href="#域名转发" class="headerlink" title="域名转发"></a>域名转发</h3><p>在本机上，我事先装了一个 nexus 私服，端口是8081，以此为例子, 我们通过域名转发把 nexus.xx.xx 转发到 xx.xx:8081.</p><p>首先，要有一个域名。</p><h6 id="配置dns-解析"><a href="#配置dns-解析" class="headerlink" title="配置dns 解析"></a>配置dns 解析</h6><p>然后新建一个DNS解析配置，把子域名 nexus.xx.xx  解析到服务器IP地址，稍等片刻，等待DNS服务器更新解析，我自己的域名使用了 <a href="https://www.dns.com/">https://www.dns.com/</a> 提供的 DNS服务器<br><img src="/images/12404.png" alt="image.png"></p><p>浏览器键入 nexus.xx.xx，进入了nginx的首页。此步骤完成</p><h6 id="配置nginx域名转发"><a href="#配置nginx域名转发" class="headerlink" title="配置nginx域名转发"></a>配置nginx域名转发</h6><p>在 nginx.conf的 http 模块中 加入一个 server </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">   &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name nexus.xx.xx;</span><br><span class="line">       location / &#123;</span><br><span class="line">           proxy_redirect off;</span><br><span class="line">           proxy_set_header Host $host;</span><br><span class="line">           proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">           proxy_pass http://127.0.0.1:8081; # 转发地址 可以是 baidu.com 或者任何地址</span><br><span class="line">       &#125;</span><br><span class="line">       access_log logs/nexus.log;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>保存并重启服务器 （我尝试使用nginx -s reload 重新加载配置文件无效，只能重启）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -s quit</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure><p>浏览器键入 nexus.xx.xx 咦 404? 没错啦，这是nexus的404 nexus的web 首页在 nexus.xx.xx/nexus </p><p>END</p>]]></content>
    
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>量子密钥分发是如何实现的</title>
    <link href="/2019/03/20/%E9%87%8F%E5%AD%90%E5%AF%86%E9%92%A5%E5%88%86%E5%8F%91%E5%8E%9F%E7%90%86-python%E5%AE%9E%E7%8E%B0/"/>
    <url>/2019/03/20/%E9%87%8F%E5%AD%90%E5%AF%86%E9%92%A5%E5%88%86%E5%8F%91%E5%8E%9F%E7%90%86-python%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<p>我只是一个程序员，对自然科学比较感兴趣。首先说明，我对量子力学仅停留在科普级别的了解。我仅仅利用其性质，来用代码尝试说明量子加密是如何实现的，仅供拓展思维。打个比方，本文对量子加密的讨论就如同通过“窜天猴”鞭炮作为demo来了解运载火箭的原理。</p><p><img src="/images/12402.png" alt="本文内容"> <img src="/images/124.png" alt="量子通讯"></p><h4 id="观测对测量结果的影响"><a href="#观测对测量结果的影响" class="headerlink" title="观测对测量结果的影响"></a>观测对测量结果的影响</h4><p>观测对测量结果产生影响的这种思想，真的对我的世界观产生了极大的挑战，世间万物居然遵循着这样的规律运行，让人感觉十分奇妙。</p><p>一个宏观对象，假设他有a,b,c 3个属性，该属性在对象生成时就确定，值可以为0或者1。就如同你生来就是男生/女生 不可修改，当然现在可以变性，但是实际上你的基因并不会改变，仅仅是“形似”罢了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Object</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.__a = random.randint(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">        self.__b = random.randint(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">        self.__c = random.randint(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_a</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__a</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_b</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__b</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_c</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__b</span><br><span class="line"></span><br><span class="line">o = Object()</span><br><span class="line">print(<span class="string">&quot;a:&quot;</span>+<span class="built_in">str</span>(o.get_a())+<span class="string">&quot; b:&quot;</span>+<span class="built_in">str</span>(o.get_b())+<span class="string">&quot; c:&quot;</span>+<span class="built_in">str</span>(o.get_c()))</span><br><span class="line">print(<span class="string">&quot;b:&quot;</span>+<span class="built_in">str</span>(o.get_b())+<span class="string">&quot; a:&quot;</span>+<span class="built_in">str</span>(o.get_a()))</span><br><span class="line">print(<span class="string">&quot;c:&quot;</span>+<span class="built_in">str</span>(o.get_a())+<span class="string">&quot; b:&quot;</span>+<span class="built_in">str</span>(o.get_b()))</span><br><span class="line">print(<span class="string">&quot;a:&quot;</span>+<span class="built_in">str</span>(o.get_a())+<span class="string">&quot; c:&quot;</span>+<span class="built_in">str</span>(o.get_b()))</span><br></pre></td></tr></table></figure><p>显而易见，对象生成后它的属性便是一个确定的值，该结果不会因为你的测量顺序而改变。比如你是一个汉族男性，不会因为先检查你的性别还是先检查你的民族而有所差别，在人类没有发现量子世界的性质之前，世间万物皆为如此。可能的运行结果：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:1 b:0 c:0</span><br><span class="line">b:0 a:1</span><br><span class="line">c:0 b:0</span><br><span class="line">a:1 c:0</span><br></pre></td></tr></table></figure><p><strong>量子的观测不对异性</strong><br>对量子的不同特征进行测量，观测的顺序会影响测量的结果，这种性质被称为 “量子的观测不对异性” 。嗯，一个充满哲♂学气息的性质，可见量子是个gay，观测只对同性。<br>注意，该结果不是随机的，而是“叠加的”，因为当你的测量顺序一定时得到的结果是确定的。在两个属性（a,b）的情况下，一个量子的观测方式有[a,b],[b,a]两种，因此其a,b属性应该是两种状态的叠加。以此类推我们用代码来描述一个拥有a,b,c 3个属性的“量子对象”。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">            self.__children = &#123;&#125;</span><br><span class="line">            self.__val = random.randint(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">set_child</span>(<span class="params">self, name, child</span>):</span></span><br><span class="line">            self.__children[name]=child</span><br><span class="line">            <span class="keyword">return</span> child <span class="comment"># 方便连续调用简化代码</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get_child</span>(<span class="params">self, name</span>):</span></span><br><span class="line">            <span class="keyword">return</span> self.__children[name]</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get_val</span>(<span class="params">self</span>):</span></span><br><span class="line">            <span class="keyword">return</span> self.__val</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Quantum</span>:</span></span><br><span class="line">    <span class="comment">#关于叠加态 我们可以用树结构来维护</span></span><br><span class="line">    <span class="comment">#一个3个属性的量子，可表示为,</span></span><br><span class="line">    <span class="comment">#     root</span></span><br><span class="line">    <span class="comment">#   /   |   \</span></span><br><span class="line">    <span class="comment">#  a    b    c</span></span><br><span class="line">    <span class="comment">#  /\   /\   /\</span></span><br><span class="line">    <span class="comment"># b  c a  c a  b </span></span><br><span class="line">    <span class="comment"># |  | |  | |  |</span></span><br><span class="line">    <span class="comment"># c  b c  a b  a</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测量方式，队列，如果新的测量属性和队列中最后一个值不一致则加入队列，</span></span><br><span class="line">    <span class="comment"># 如果队列长度大于（属性数-1）则头部数据出列，，为了便于理解，假设有abc三个属性</span></span><br><span class="line">    <span class="comment"># 测量属性 队列值</span></span><br><span class="line">    <span class="comment"># a       [a]</span></span><br><span class="line">    <span class="comment"># b       [a,b]  </span></span><br><span class="line">    <span class="comment"># c       [b,c]  </span></span><br><span class="line">    <span class="comment"># c       [b,c]   和最后一次测量一样 不发生改变</span></span><br><span class="line">    <span class="comment"># a       [c,a]  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.route = []</span><br><span class="line">        root = TreeNode()</span><br><span class="line">        self.root = root</span><br><span class="line">        root.set_child(<span class="string">&#x27;a&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;b&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;c&#x27;</span>,TreeNode())</span><br><span class="line">        root.get_child(<span class="string">&#x27;a&#x27;</span>).set_child(<span class="string">&#x27;c&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;b&#x27;</span>,TreeNode())</span><br><span class="line">        root.set_child(<span class="string">&#x27;b&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;a&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;c&#x27;</span>,TreeNode())</span><br><span class="line">        root.get_child(<span class="string">&#x27;b&#x27;</span>).set_child(<span class="string">&#x27;c&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;a&#x27;</span>,TreeNode())</span><br><span class="line">        root.set_child(<span class="string">&#x27;c&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;a&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;b&#x27;</span>,TreeNode())</span><br><span class="line">        root.get_child(<span class="string">&#x27;c&#x27;</span>).set_child(<span class="string">&#x27;b&#x27;</span>,TreeNode()).set_child(<span class="string">&#x27;a&#x27;</span>,TreeNode())</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        length = <span class="built_in">len</span>(self.route)</span><br><span class="line">        <span class="keyword">if</span> (length == <span class="number">0</span> <span class="keyword">or</span> self.route[<span class="number">-1</span>]!=name):</span><br><span class="line">            self.route.append(name)</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">len</span>(self.route) &gt;<span class="number">2</span>):</span><br><span class="line">                self.route.pop(<span class="number">0</span>)</span><br><span class="line">        node = self.root</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> self.route:</span><br><span class="line">            node = node.get_child(name)</span><br><span class="line">        <span class="keyword">return</span> node.get_val()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_a</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__get(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_b</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__get(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_c</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__get(<span class="string">&#x27;c&#x27;</span>)</span><br></pre></td></tr></table></figure><p>好了，我们已经通过代码实现了“观测对测量结果产生影响”的效果。每一次get属性值，就是对对象的一次观测，不同观测顺序下，变量会返回不同的值。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创造一个量子并对他的属性反复观测</span></span><br><span class="line">q = Quantum()</span><br><span class="line">print(<span class="string">&#x27;a&#x27;</span>,q.get_a())</span><br><span class="line">print(<span class="string">&#x27;b&#x27;</span>,q.get_a())</span><br><span class="line">print(<span class="string">&#x27;a&#x27;</span>,q.get_b())</span><br><span class="line">print(<span class="string">&#x27;c&#x27;</span>,q.get_c())</span><br><span class="line">print(<span class="string">&#x27;a&#x27;</span>,q.get_a())</span><br><span class="line">print(<span class="string">&#x27;b&#x27;</span>,q.get_a())</span><br><span class="line">print(<span class="string">&#x27;a&#x27;</span>,q.get_a())</span><br></pre></td></tr></table></figure><p>可能的运行结果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a 0</span><br><span class="line">b 0</span><br><span class="line">a 1</span><br><span class="line">c 1</span><br><span class="line">a 0</span><br><span class="line">b 0</span><br><span class="line">a 0</span><br></pre></td></tr></table></figure><h4 id="量子秘钥分发"><a href="#量子秘钥分发" class="headerlink" title="量子秘钥分发"></a>量子秘钥分发</h4><p>通过量子的物理性质，保证了秘钥分发时的绝对安全<br>用代码来模拟该过程：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from quantum import Quantum</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Observer:</span><br><span class="line">    length &#x3D; 20</span><br><span class="line"></span><br><span class="line">    def __init__(self, name):</span><br><span class="line">        self.name &#x3D; name</span><br><span class="line">        self.q_list &#x3D; []  # 量子集合</span><br><span class="line"></span><br><span class="line">    # 初始化量子集合</span><br><span class="line">    def init_quantum(self):</span><br><span class="line">        for i in range(Observer.length):</span><br><span class="line">            self.q_list.append(Quantum())</span><br><span class="line"></span><br><span class="line">    # 观测</span><br><span class="line">    def observe(self):</span><br><span class="line">        def __observe(quantum):</span><br><span class="line">            ran &#x3D; random.randint(0, 2)</span><br><span class="line">            #最常见的光量子就有“线偏振”和“圆偏振”两种属性</span><br><span class="line">            # 只使用a,b两个属性 来模拟这种情况</span><br><span class="line">            if (ran &#x3D;&#x3D; 0):</span><br><span class="line">                return (&#39;a&#39;, q.get_a())</span><br><span class="line">            else:</span><br><span class="line">                return (&#39;b&#39;, q.get_b())</span><br><span class="line">        self.path &#x3D; []</span><br><span class="line">        self.result &#x3D; []</span><br><span class="line">        for q in self.q_list:</span><br><span class="line">            result &#x3D; __observe(q)</span><br><span class="line">            self.path.append(result[0])</span><br><span class="line">            self.result.append(result[1])</span><br><span class="line">        print(self.name,&#39;观测方式：&#39;, self.path)</span><br><span class="line">        print(self.name,&#39;观测结果：&#39;, self.result)</span><br><span class="line">    </span><br><span class="line">    # 从另一个观测者获取量子序列</span><br><span class="line">    def get_quantum(self, another):</span><br><span class="line">        self.q_list&#x3D;another.q_list</span><br><span class="line">    </span><br><span class="line">    # 从另一个观测者获取观测方式</span><br><span class="line">    def get_path(self, another):</span><br><span class="line">        self.key &#x3D; []</span><br><span class="line">        for i in range(Observer.length):</span><br><span class="line">            if (another.path[i] &#x3D;&#x3D; self.path[i]):</span><br><span class="line">                self.key.append(self.result[i])</span><br><span class="line">        print(self.name,&#39;秘钥：&#39;, self.key)</span><br></pre></td></tr></table></figure><p>观测和秘钥传输</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sender &#x3D; Observer(&#39;发送者&#39;)</span><br><span class="line">sender.init_quantum() # 初始化量子序列</span><br><span class="line">sender.observe() # 对量子序列进行观测</span><br><span class="line"></span><br><span class="line">reciver &#x3D; Observer(&#39;接收者&#39;)</span><br><span class="line">reciver.get_quantum(sender) # 发送者把量子传输给接收者</span><br><span class="line">reciver.observe() # 接收者对其观测</span><br><span class="line"></span><br><span class="line"># 双方交换观察方式</span><br><span class="line">sender.get_path(reciver)</span><br><span class="line">reciver.get_path(sender)</span><br></pre></td></tr></table></figure><p>可以得到这样的运行结果：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">发送者 观测方式： [&#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;]</span><br><span class="line">发送者 观测结果： [0, 0, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1]</span><br><span class="line">接收者 观测方式： [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;]</span><br><span class="line">接收者 观测结果： [0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0]</span><br><span class="line">发送者 秘钥： [0, 0, 1, 1, 0, 1, 0, 0, 1, 1]</span><br><span class="line">接收者 秘钥： [0, 0, 1, 1, 0, 1, 0, 0, 1, 1]</span><br></pre></td></tr></table></figure><h4 id="如何保证安全"><a href="#如何保证安全" class="headerlink" title="如何保证安全"></a>如何保证安全</h4><p>在模拟的代码中，“量子的观测不对异性” 通过存储观测方式 path 在Quantum对象中实现。这是我们在宏观世界来模拟这种现象的一种实现手段，实际上这是一种基本物理性质，观测者不可能从量子上得到之前对它观测的方式。</p><p><strong>量子不可克隆</strong><br>要保证安全还需要量子的另一个特性“量子不可克隆”。就是说，世间没有两个相同的量子，你不可能通过一个已得到的量子获得完全相同的另一个量子。没有这个原理，窃听者完全可以复制一个量子对它进行观测并把原来的量子传送给接收者。</p><p><strong>窃听过程</strong><br>知道上述两个物理性质后，如果有人试图监听，便是只能中截获了发送者传输的量子，并观测其值，然后再把它发送给接收者。然而此时所有人都不知道发送者的观测方式。窃听者也只能按自己的想法随意观测其属性。但没有关系，你对量子的观测便改变了量子的状态，当接收者获取到量子时，即便和发送者用同样的方式观测，也有可能得到不同的结果，当这个序列数量非常大的时候,这是必然发生的，结果就是得到了和发送者不一样的秘钥，这样窃听便被发现了。</p><p>模拟上述过程：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sender = Observer(<span class="string">&#x27;发送者&#x27;</span>)</span><br><span class="line">sender.init_quantum() <span class="comment"># 初始化量子序列</span></span><br><span class="line">sender.observe() <span class="comment"># 对量子序列进行观测</span></span><br><span class="line"></span><br><span class="line">interceptor = Observer(<span class="string">&#x27;窃听者&#x27;</span>)</span><br><span class="line">interceptor.get_quantum(sender) <span class="comment"># 截取信息</span></span><br><span class="line">interceptor.observe() <span class="comment"># 观测</span></span><br><span class="line"></span><br><span class="line">reciver = Observer(<span class="string">&#x27;接收者&#x27;</span>)</span><br><span class="line">reciver.get_quantum(interceptor) <span class="comment"># 发送者把量子传输给接收者</span></span><br><span class="line">reciver.observe() <span class="comment"># 接收者对其观测</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 双方交换观察方式</span></span><br><span class="line">sender.get_path(reciver)</span><br><span class="line">reciver.get_path(sender)</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">发送者 观测方式： [&#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;]</span><br><span class="line">发送者 观测结果： [1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1]</span><br><span class="line">窃听者 观测方式： [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;]</span><br><span class="line">窃听者 观测结果： [0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0]</span><br><span class="line">接收者 观测方式： [&#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;a&#x27;]</span><br><span class="line">接收者 观测结果： [0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0]</span><br><span class="line">发送者 秘钥： [1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1]</span><br><span class="line">接收者 秘钥： [1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0]</span><br></pre></td></tr></table></figure><p>代码请参考<br><a href="https://github.com/lzlz000/simple-clear-knowledge/tree/master/%5Bpython%5D%E9%87%8F%E5%AD%90%E9%80%9A%E8%AE%AF">https://github.com/lzlz000/simple-clear-knowledge/tree/master/%5Bpython%5D%E9%87%8F%E5%AD%90%E9%80%9A%E8%AE%AF</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>python</tag>
      
      <tag>探索与发现</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RSA算法原理</title>
    <link href="/2019/03/15/RSA%E7%AE%97%E6%B3%95/"/>
    <url>/2019/03/15/RSA%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h4 id="算法介绍"><a href="#算法介绍" class="headerlink" title="算法介绍"></a>算法介绍</h4><ol><li>随意选择两个大的素数  p q</li><li><code>n = p * q</code></li><li><code>φ(n) = (p-1)(q-1)</code>  (欧拉函数)</li><li>公钥e: 满足 <code>1&lt;e&lt;φ(n)</code>的整数 且和 φ(n)互质</li><li>私钥d: 满足 <code>e*d mod φ(n)==1</code></li><li>销毁p, q</li><li>公开发布 n和公钥 e</li></ol><p>加密解密：</p><ol><li>加密，明文m (m应为小于n的整数)，m的e次幂取n的余数，得到值c即为密文<br>$c = m^e mod(n)$</li><li>解密， 计算密文c的d次幂取n的余数，即得到明文m</li></ol><p>整体流程的简易代码 (python3)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 欧几里得算法 （辗转相除法） 求最大公约数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span>(<span class="params">m, n</span>):</span></span><br><span class="line">    mod = <span class="number">1</span></span><br><span class="line">    <span class="comment"># 将小数放到d1中</span></span><br><span class="line">    <span class="keyword">if</span>(m &lt;= n):</span><br><span class="line">        d1 = m</span><br><span class="line">        d2 = n</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        d1 = n</span><br><span class="line">        d2 = m</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> mod != <span class="number">0</span>:</span><br><span class="line">        mod = d2 % d1</span><br><span class="line">        d2 = d1</span><br><span class="line">        d1 = mod</span><br><span class="line">    <span class="keyword">return</span> d2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 真实情况下应该是很大的素数 通常为512、1024、2048位二进制数,如1024位二进制整数大约为十进制10^308数量级</span></span><br><span class="line"><span class="comment"># 计算得到秘钥然后以一定规则编码成字符串形式，形成常见的秘钥</span></span><br><span class="line">p = <span class="number">41</span></span><br><span class="line">q = <span class="number">43</span></span><br><span class="line">n = p * q</span><br><span class="line"><span class="comment"># 欧拉函数</span></span><br><span class="line">phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line"><span class="comment"># 1&lt;e&lt;φ(n)的整数 且和 φ(n)互质</span></span><br><span class="line">publicKey = <span class="number">2</span></span><br><span class="line"><span class="comment"># 检查是否互质 否则+1</span></span><br><span class="line"><span class="keyword">while</span> gcd(phi, publicKey) != <span class="number">1</span>:</span><br><span class="line">    publicKey = publicKey+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 私钥d: e*d%φ(n)==1</span></span><br><span class="line">privateKey = (phi + <span class="number">1</span>) * publicKey</span><br><span class="line">print(<span class="string">&quot;公钥:&quot;</span>, publicKey,<span class="string">&quot;私钥:&quot;</span>, privateKey,<span class="string">&quot;n:&quot;</span>, n)</span><br><span class="line"><span class="comment"># 存储在计算机里的一切信息都可以认为是一串按一定规则序列化成的数字</span></span><br><span class="line">content = <span class="number">412</span>  <span class="comment"># 密文的值要小于 p * q,否则需要分段加密</span></span><br><span class="line">cipher = <span class="built_in">pow</span>(content, publicKey, n)</span><br><span class="line">print(<span class="string">&quot;密文&quot;</span>, cipher)</span><br><span class="line">content1 = <span class="built_in">pow</span>(cipher, privateKey, n)</span><br><span class="line">print(<span class="string">&quot;明文&quot;</span>, content1)</span><br></pre></td></tr></table></figure><h5 id="幂模运算"><a href="#幂模运算" class="headerlink" title="幂模运算"></a>幂模运算</h5><p>上述代码中 通过 <strong>pow(a, b, c)**获取 a的b次幂取c的模，该函数在python中是一个自带的函数，然而在其他常见语言的自带库（如java、js等）中，pow() 函数/方法 通常没有取模的功能，</strong>千万不可用 pow(a,b)%c代替该运算**。上文的简单例子中，私钥的值已经高达 18491，任何一个大于1整数的18491次幂都已经是个天文数字，在大多数语言中运行时得到的已经不是一个精确的结果，取模的值是错误的。更不要说实际上使用的大素数，经过这样的运算，得到的值大到计算机内存肯定是存不下的。</p><p>如果你不想深入了解该问题，在任何常用语言中，可以轻易找到科学计算库，都带有该算法，如果你还有兴趣，请搜索“蒙哥马利幂模运算”，也很容易理解。</p><h5 id="获取大素数"><a href="#获取大素数" class="headerlink" title="获取大素数"></a>获取大素数</h5><p>我们知道判断一个数是否为素数的方法是这样：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math    </span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isPrime</span>(<span class="params">n</span>):</span>    </span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>   </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="built_in">int</span>(math.sqrt(n)) + <span class="number">1</span>):    </span><br><span class="line">    <span class="keyword">if</span> n % i == <span class="number">0</span>:    </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>   </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>   </span><br></pre></td></tr></table></figure><p>然而我们如果要获取一个大素数，如果把大数一个一个遍历直到找到一个素数其实是很低效的。因此我们通过一些素数的性质或者其规律，通过更有效率的办法筛选出可能符合要求的整数，然后对其进行精确的判断是实际常用的方法。参考下面的链接：<br><a href="https://www.zhihu.com/question/293656940/answer/512820832">https://www.zhihu.com/question/293656940/answer/512820832</a></p><h4 id="为什么RSA算法能保证安全？"><a href="#为什么RSA算法能保证安全？" class="headerlink" title="为什么RSA算法能保证安全？"></a>为什么RSA算法能保证安全？</h4><p>公开场合只能获取到公钥对 (n,publicKey)<br>publicKey 和 privateKey 的对应关系为  <em>publicKey = privateKey((p-1)(q-1)+1)</em>,<br>而p,q在算法中已经被销毁了，我们只知道p,q的乘积n，通过n分解质因数找到质数p,q的是一个指数级别复杂度的算法，在实际使用中，p,q都是10的几百次方数量级的大数，计算出p,q对于现代计算机来说可以认为是一个在有限时间内不可解的问题。</p><h4 id="随便写点"><a href="#随便写点" class="headerlink" title="随便写点"></a>随便写点</h4><p>相比技术问题，我更喜欢谈谈技术和技术以外事物的关系，从今天起开始写简明知识系列文章，其内容一般以代码作为载体，以简明的方式，短小的篇幅写下和编程相关的技术问题，也谈谈相关的非技术问题。</p><p>RSA算法被认为是世界上最重要的算法之一。二战时期，科技强如德国，密码都可以被盟军破译。然而现在个人就可以对信息做到理论级别不可破解的方式加密，2016年“苹果fbi事件”就是如此。因此双向加密算法被用在了了生活中的方方面面，从https到你的银行账户，无处不在。</p><blockquote><p>联邦调查局将CNET引向联邦调查局长詹姆斯·科米（James Comey）的言论，科米谈到美国如何始终平衡隐私与公共安全，以及加密技术如何破坏了这种平衡。“强加密的逻辑意味着所有人的生命，包括执法，都将很快受到强加密的影响。”他说。“在我看来，根据我们的历史和我们的价值观，绝对的隐私以及那些认为政府应该把手从人民手机上拿开的想法没有任何意义。”</p></blockquote><p>拿不到私钥，即使强如国家暴力也无法获取你加密的任何信息，打破了强弱力量之间的平衡，让个人通过技术获取了可以对抗强权的小小手段。</p><p>量子计算机的发展让在有限时间内破解私钥在未来变得有可能实现，因此情报部门如今会截获并保存他们认为有可能有价值的密文信息和公钥对，在破解私钥实现后便可得到其信息。然而每天世界上通讯中的加密数据海量，数据价值的时效性也有限，因此RSA算法保证信息的安全性在目前还是没有问题滴 : ）</p>]]></content>
    
    
    
    <tags>
      
      <tag>算法</tag>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java正则表达式-环视、反向引用、贪婪</title>
    <link href="/2019/03/01/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-%E7%8E%AF%E8%A7%86%E4%B8%8E%E8%B4%AA%E5%A9%AA/"/>
    <url>/2019/03/01/java%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-%E7%8E%AF%E8%A7%86%E4%B8%8E%E8%B4%AA%E5%A9%AA/</url>
    
    <content type="html"><![CDATA[<h3 id="环视"><a href="#环视" class="headerlink" title="环视"></a>环视</h3><h4 id="什么是环视"><a href="#什么是环视" class="headerlink" title="什么是环视"></a>什么是环视</h4><p> 环视顾名思义就是从四周看。正则表达式一向都是从左向右工作的，但是环视也能从右向左工作。最典型的列子就是给你一个数字如12345678，需要你改成12，345，678这种格式。如果按照我们的思维来，应该是会从右边开始划分吧，每三个数字加一个逗号。环视就能按照我们的思维去解决这样的问题。这里要注意的是环视不匹配任何字符，只是匹配位置而已。作用和^,&amp;相似。环视又分为顺序环视和逆序环视。也就是从左到右工作和从右到左的区别.顺序环视在正则中用(?=)表示，包含括号。逆序用(?&lt;=)</p><h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><p><strong>(?=Expression)</strong>  顺序肯定环视，表示所在位置右侧能够匹配Expression<br>**(?!Expression)**   顺序否定环视，表示所在位置右侧不能匹配Expression<br>**(?&lt;=Expression)** 逆序肯定环视，表示所在位置左侧能够匹配Expression<br>**(?&lt;!Expression)**  逆序否定环视，表示所在位置左侧不能匹配Expression</p><p><strong>java中的使用方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 匹配 前缀为 test的字母</span></span><br><span class="line">String s = <span class="string">&quot;123testabc abc 123testLttt&quot;</span>;</span><br><span class="line">Pattern pattern = Pattern.compile(<span class="string">&quot;(?&lt;=test)\\w+&quot;</span>);</span><br><span class="line">Matcher matcher = pattern.matcher(s);</span><br><span class="line"><span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">System.out.println(matcher.group());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="反向引用"><a href="#反向引用" class="headerlink" title="反向引用"></a>反向引用</h3><p>按照()子表达式划分成若干组；每出现一对()就是一个捕获组；引擎会对捕获组进行编号，编号规则是左括号(从左到右出现的顺序，从1开始编号。</p><p><strong>例：</strong></p><p><strong>\1</strong> 代表对第一次匹配 <strong>(\w+)</strong> 的引用</p><p>在使用了括号来包裹表达式后，matcher.groupCount()的值&gt;0，可以通过其获取捕获的值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">&quot;123testabc abc 123testLttt&quot;</span>;</span><br><span class="line">Pattern pattern = Pattern.compile(<span class="string">&quot;(\\w+) \\1&quot;</span>);</span><br><span class="line">Matcher matcher = pattern.matcher(s);</span><br><span class="line">System.out.println(matcher.groupCount());</span><br><span class="line"><span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">    System.out.println(matcher.group(<span class="number">0</span>));</span><br><span class="line">    System.out.println(matcher.group(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="贪婪"><a href="#贪婪" class="headerlink" title="贪婪"></a>贪婪</h3><p>java中正则默认为贪婪模式，即尽可能多的匹配多的字符， “趋向于最大长度匹配”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">&quot;&lt;div&gt;hello&lt;/div&gt;&lt;div&gt;world&lt;/div&gt;&quot;</span>;</span><br><span class="line">Pattern pattern = Pattern.compile(<span class="string">&quot;&lt;div&gt;.*&lt;/div&gt;&quot;</span>);</span><br><span class="line">Matcher matcher = pattern.matcher(s);</span><br><span class="line"><span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">    System.out.println(matcher.group());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;hello&lt;&#x2F;div&gt;&lt;div&gt;world&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><p><strong>非贪婪</strong></p><p>使用方法 在需要匹配的串后面加上 <strong>?</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">&quot;&lt;div&gt;hello&lt;/div&gt;&lt;div&gt;world&lt;/div&gt;&quot;</span>;</span><br><span class="line">Pattern pattern = Pattern.compile(<span class="string">&quot;&lt;div&gt;.*?&lt;/div&gt;&quot;</span>);</span><br><span class="line">Matcher matcher = pattern.matcher(s);</span><br><span class="line"><span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">    System.out.println(matcher.group());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;hello&lt;&#x2F;div&gt;</span><br><span class="line">&lt;div&gt;world&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql优化问题（三）sql优化</title>
    <link href="/2018/10/01/mysql%E4%BC%98%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <url>/2018/10/01/mysql%E4%BC%98%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql优化问题（二）执行计划</title>
    <link href="/2018/09/27/mysql%E4%BC%98%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <url>/2018/09/27/mysql%E4%BC%98%E5%8C%96%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h2 id="执行计划"><a href="#执行计划" class="headerlink" title="执行计划"></a><strong>执行计划</strong></h2><p>使用EXPLAIN关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的SQL语句的。分析你的查询语句或是表结构的性能瓶颈</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Explain [SQL语句]</span><br></pre></td></tr></table></figure><h3 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h3><p>执行 Explain 语句得到的结果将包含以下列</p><p><img src="/images/1561914397839.png"></p><h4 id="ID列"><a href="#ID列" class="headerlink" title="ID列"></a>ID列</h4><p>id列表明了语句间的执行顺序，顺序判断规则如下</p><ul><li>id相同：执行顺序由上至下</li><li>id不同：如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行</li></ul><p>举个栗子：</p><p>这是一个复杂的关联查询语句的执行计划内容，其查询顺序按照1-&gt;2-&gt;3-&gt;4的顺序执行。</p><p><img src="/images/1561915413315.png"></p><h4 id="select-type列"><a href="#select-type列" class="headerlink" title="select_type列"></a>select_type列</h4><p><img src="/images/clip_image002.jpg"></p><h4 id="table列"><a href="#table列" class="headerlink" title="table列"></a>table列</h4><p>当前查询的表，没有可解释的地方</p><h4 id="Type列"><a href="#Type列" class="headerlink" title="Type列"></a>Type列</h4><p>访问类型，一个重要的参数指标，结果值从最好到最坏依次是：<br>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL </p><p>常见的有 system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;ALL 这几种类型</p>]]></content>
    
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mysql优化问题（一）慢查询</title>
    <link href="/2018/09/25/mysql%E4%BC%98%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2018/09/25/mysql%E4%BC%98%E5%8C%96%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p><a href="https://lzlz000.github.io/">lzlz000的个人主页</a></p><p>总结一下最近学习整理的mysql优化问题 😀</p><p>我感觉mysql优化特别像看病：通过慢查询来定位症状，执行计划则是检测项目-CT,X光,验血…，sql优化就是治疗手段。当然好的业务设计就像是良好的生活习惯，能减少疾病的发生。</p><h2 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h2><p>即慢查询日志，是指mysql记录所有执行超过long_query_time参数设定的时间阈值的SQL语句的日志。该日志能为SQL语句的优化带来很好的帮助</p><h3 id="开启慢查询"><a href="#开启慢查询" class="headerlink" title="开启慢查询"></a>开启慢查询</h3><p>默认情况下，慢查询日志是关闭的，要使用慢查询日志功能，首先要开启慢查询日志功能。</p><p><strong>通过下面命令查看下的配置：</strong></p><p>show VARIABLES like ‘%配置变量%’</p><p><strong>慢查询相关配置信息：</strong></p><ul><li>slow_query_log 启动停止技术慢查询日志</li><li>slow_query_log_file 指定慢查询日志得存储路径及文件（默认和数据文件放一起）</li><li>long_query_time 指定记录慢查询日志SQL执行时间得伐值（单位：秒，默认10秒）</li><li>log_queries_not_using_indexes  是否记录未使用索引的SQL</li><li>log_output 日志存放的地方【TABLE】【FILE】【FILE,TABLE】</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-- 慢查询没有开启</span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;%slow_query_log%&#39;;</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| Variable_name       | Value                                |</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| slow_query_log      | OFF                                  |</span><br><span class="line">| slow_query_log_file | &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;21502193a9d9-slow.log |</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line"></span><br><span class="line">-- 开启慢查询功能</span><br><span class="line">mysql&gt; SET GLOBAL  slow_query_log&#x3D;true;</span><br><span class="line">Query OK, 0 rows affected (0.09 sec)</span><br><span class="line"></span><br><span class="line">-- 默认10秒，这里为了演示方便设置为0</span><br><span class="line">mysql&gt; set global long_query_time&#x3D;0;   </span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br></pre></td></tr></table></figure><p>注意:</p><ul><li><p>当前开启的参数在mysql重启后都会无效，如果想要永久开启慢查询并配置阈值，请在配置文件中加上 slow_query_log=1，long_query_time=你想设置的时间</p></li><li><p><strong>long_query_time</strong> 参数存在session属性和global属性 设置完之后查询 ：</p><p>SHOW VARIABLES LIKE ‘long_query_time’ </p><p>可能会发生不生效的情况，可以重启会话，或者  </p><p>SHOW GLOBAL VARIABLES LIKE ‘long_query_time’;</p></li></ul><h3 id="慢查询分析"><a href="#慢查询分析" class="headerlink" title="慢查询分析"></a>慢查询分析</h3><p>上文中的 slow_query_log_file 路径下保存了 慢查询日志文件。在本人所装的mysql5.7版本中，一条慢查询日志包括以下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Time: 2019-06-30T16:08:45.138780Z</span><br><span class="line"># User@Host: root[root] @  [119.98.146.86]  Id:     2</span><br><span class="line"># Query_time: 22.573668  Lock_time: 0.000150 Rows_sent: 28922  Rows_examined: 28922</span><br><span class="line">SET timestamp&#x3D;1561910925;</span><br><span class="line">SELECT * FROM class_t t1 WHERE NAME_ IS NOT NULL;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>这里有个小问题，<strong>set global long_query_time</strong> “不生效”的问题，long_query_time 这个属性是有global值和session值的，你可以关闭并重启会话，或者使用 SHOW GLOBAL VARIABLES LIKE ‘long_query_time’ 查询当前值</li></ul><table><thead><tr><th>行数</th><th>内容</th></tr></thead><tbody><tr><td>1</td><td>时间</td></tr><tr><td>2</td><td>用户名 、用户的IP信息、线程ID号</td></tr><tr><td>3</td><td>执行花费的时间【单位：毫秒】、执行获得锁的时间、获得的结果行数、扫描的数据行数</td></tr><tr><td>4</td><td>SQL执行的具体时间戳(与第一行时间一致，注意mysql时间戳和其他语言中的毫秒时间戳的差别)</td></tr><tr><td>5</td><td>具体的SQL语句</td></tr></tbody></table><p>不同版本的mysql，行数和内容有些许差别，但区别不大</p><h4 id="mysqldumpslow"><a href="#mysqldumpslow" class="headerlink" title="mysqldumpslow"></a>mysqldumpslow</h4><p>mysql自带的慢查询分析工具，简单尝试下功能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow --help</span><br><span class="line"></span><br><span class="line">  --verbose    verbose</span><br><span class="line">  --debug      debug</span><br><span class="line">  --help       write this text to standard output</span><br><span class="line"></span><br><span class="line">  -v           verbose</span><br><span class="line">  -d           debug</span><br><span class="line">  # 排序：</span><br><span class="line">  c:总次数</span><br><span class="line">  t:总时间</span><br><span class="line">  l:锁的时间</span><br><span class="line">  r:总数据行</span><br><span class="line">  at,al,ar  :t,l,r平均数  【例如：at &#x3D; 总时间&#x2F;总次数】</span><br><span class="line">  -s ORDER     what to sort by (al, at, ar, c, l, r, t), &#39;at&#39; is default</span><br><span class="line">                al: average lock time</span><br><span class="line">                ar: average rows sent</span><br><span class="line">                at: average query time</span><br><span class="line">                 c: count</span><br><span class="line">                 l: lock time</span><br><span class="line">                 r: rows sent</span><br><span class="line">                 t: query time  </span><br><span class="line">  -r           reverse the sort order (largest last instead of first)</span><br><span class="line">  -t NUM       just show the top n queries</span><br><span class="line">  -a           don&#39;t abstract all numbers to N and strings to &#39;S&#39;</span><br><span class="line">  -n NUM       abstract numbers with at least n digits within names</span><br><span class="line">  -g PATTERN   grep: only consider stmts that include this string</span><br><span class="line">  -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),</span><br><span class="line">               default is &#39;*&#39;, i.e. match all</span><br><span class="line">  -i NAME      name of server instance (if using mysql.server startup script)</span><br><span class="line">  -l           don&#39;t subtract lock time from total time</span><br></pre></td></tr></table></figure><p>一些例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s r -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;21502193a9d9-slow.log</span><br><span class="line">得到返回记录集最多的10个查询。</span><br><span class="line"></span><br><span class="line">mysqldumpslow -s t -t 10 -g “left join” &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;21502193a9d9-slow.log</span><br><span class="line">得到按照时间排序的前10条里面含有左连接的查询语句。</span><br><span class="line"></span><br><span class="line">mysqldumpslow -a -s t -t 2 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;21502193a9d9-slow.log</span><br><span class="line">-a 参数，说明不合并类似的SQL语句，显示具体的SQL语句中的数字和字符串。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>值得注意的是，若不加-a参数，mysql是会默认合并类似的语句，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM teaching_class_t t1 WHERE id_&gt;10000  LIMIT 0,20000</span><br></pre></td></tr></table></figure><p>mysqldumpslow中会得到的结果,并且把类似的合并为同一个Count：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Count: 1  Time&#x3D;16.81s (16s)  Lock&#x3D;0.00s (0s)  Rows&#x3D;20000.0 (20000), root[root]@[119.98.146.86]</span><br><span class="line">  SELECT * FROM teaching_class_t t1 WHERE id_&gt;N  LIMIT N,N</span><br></pre></td></tr></table></figure><h4 id="pt-query-digest"><a href="#pt-query-digest" class="headerlink" title="pt_query_digest"></a>pt_query_digest</h4><p>一个更加强大的mysql慢查询分析工具，安装:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y  install &#39;perl(Data::Dumper)&#39;;</span><br><span class="line">yum -y install perl-Digest-MD5</span><br><span class="line">yum -y install perl-DBI</span><br><span class="line">yum -y install perl-DBD-MySQL</span><br></pre></td></tr></table></figure><h5 id="语法及重要选项"><a href="#语法及重要选项" class="headerlink" title="语法及重要选项"></a>语法及重要选项</h5><p>由于安装出现问题，一直装不上没有实际尝试，我先记录下来以备以后使用，来源于 <a href="https://www.cnblogs.com/luyucheng/p/6265873.html">https://www.cnblogs.com/luyucheng/p/6265873.html</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest [OPTIONS] [FILES] [DSN]</span><br><span class="line"></span><br><span class="line">--create-review-table 当使用--review参数把分析结果输出到表中时，如果没有表就自动创建。</span><br><span class="line">--create-history-table 当使用--history参数把分析结果输出到表中时，如果没有表就自动创建。</span><br><span class="line">--filter 对输入的慢查询按指定的字符串进行匹配过滤后再进行分析</span><br><span class="line">--limit 限制输出结果百分比或数量，默认值是20,即将最慢的20条语句输出，如果是50%则按总响应时间占比从大到小排序，输出到总和达到50%位置截止。</span><br><span class="line">--host mysql服务器地址</span><br><span class="line">--user mysql用户名</span><br><span class="line">--password mysql用户密码</span><br><span class="line">--history 将分析结果保存到表中，分析结果比较详细，下次再使用--history时，如果存在相同的语句，且查询所在的时间区间和历史表中的不同，则会记录到数据表中，可以通过查询同一CHECKSUM来比较某类型查询的历史变化。</span><br><span class="line">--review 将分析结果保存到表中，这个分析只是对查询条件进行参数化，一个类型的查询一条记录，比较简单。当下次使用--review时，如果存在相同的语句分析，就不会记录到数据表中。</span><br><span class="line">--output 分析结果输出类型，值可以是report(标准分析报告)、slowlog(Mysql slow log)、json、json-anon，一般使用report，以便于阅读。</span><br><span class="line">--since 从什么时间开始分析，值为字符串，可以是指定的某个”yyyy-mm-dd [hh:mm:ss]”格式的时间点，也可以是简单的一个时间值：s(秒)、h(小时)、m(分钟)、d(天)，如12h就表示从12小时前开始统计。</span><br><span class="line">--until 截止时间，配合—since可以分析一段时间内的慢查询</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>分析pt-query-digest输出结果</strong></p><p>第一部分：总体统计结果<br>Overall：总共有多少条查询<br>Time range：查询执行的时间范围<br>unique：唯一查询数量，即对查询条件进行参数化以后，总共有多少个不同的查询<br>total：总计   min：最小   max：最大  avg：平均<br>95%：把所有值从小到大排列，位置位于95%的那个数，这个数一般最具有参考价值<br>median：中位数，把所有值从小到大排列，位置位于中间那个数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 该工具执行日志分析的用户时间，系统时间，物理内存占用大小，虚拟内存占用大小</span><br><span class="line"># 340ms user time, 140ms system time, 23.99M rss, 203.11M vsz</span><br><span class="line"># 工具执行时间</span><br><span class="line"># Current date: Fri Nov 25 02:37:18 2016</span><br><span class="line"># 运行分析工具的主机名</span><br><span class="line"># Hostname: localhost.localdomain</span><br><span class="line"># 被分析的文件名</span><br><span class="line"># Files: slow.log</span><br><span class="line"># 语句总数量，唯一的语句数量，QPS，并发数</span><br><span class="line"># Overall: 2 total, 2 unique, 0.01 QPS, 0.01x concurrency ________________</span><br><span class="line"># 日志记录的时间范围</span><br><span class="line"># Time range: 2016-11-22 06:06:18 to 06:11:40</span><br><span class="line"># 属性               总计      最小    最大    平均    95%  标准    中等</span><br><span class="line"># Attribute          total     min     max     avg     95%  stddev  median</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;     &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># 语句执行时间</span><br><span class="line"># Exec time             3s   640ms      2s      1s      2s   999ms      1s</span><br><span class="line"># 锁占用时间</span><br><span class="line"># Lock time            1ms       0     1ms   723us     1ms     1ms   723us</span><br><span class="line"># 发送到客户端的行数</span><br><span class="line"># Rows sent              5       1       4    2.50       4    2.12    2.50</span><br><span class="line"># select语句扫描行数</span><br><span class="line"># Rows examine     186.17k       0 186.17k  93.09k 186.17k 131.64k  93.09k</span><br><span class="line"># 查询的字符数</span><br><span class="line"># Query size           455      15     440  227.50     440  300.52  227.50</span><br></pre></td></tr></table></figure><p>第二部分：查询分组统计结果<br>Rank：所有语句的排名，默认按查询时间降序排列，通过–order-by指定<br>Query ID：语句的ID，（去掉多余空格和文本字符，计算hash值）<br>Response：总的响应时间<br>time：该查询在本次分析中总的时间占比<br>calls：执行次数，即本次分析总共有多少条这种类型的查询语句<br>R/Call：平均每次执行的响应时间<br>V/M：响应时间Variance-to-mean的比率<br>Item：查询对象</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Profile</span><br><span class="line"># Rank Query ID           Response time Calls R&#x2F;Call V&#x2F;M   Item</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">#    1 0xF9A57DD5A41825CA  2.0529 76.2%     1 2.0529  0.00 SELECT</span><br><span class="line">#    2 0x4194D8F83F4F9365  0.6401 23.8%     1 0.6401  0.00 SELECT wx_member_base</span><br></pre></td></tr></table></figure><p>第三部分：每一种查询的详细统计结果<br>由下面查询的详细统计结果，最上面的表格列出了执行次数、最大、最小、平均、95%等各项目的统计。<br>ID：查询的ID号，和上图的Query ID对应<br>Databases：数据库名<br>Users：各个用户执行的次数（占比）<br>Query_time distribution ：查询时间分布, 长短体现区间占比，本例中1s-10s之间查询数量是10s以上的两倍。<br>Tables：查询中涉及到的表<br>Explain：SQL语句</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># Query 1: 0 QPS, 0x concurrency, ID 0xF9A57DD5A41825CA at byte 802 ______</span><br><span class="line"># This item is included in the report because it matches --limit.</span><br><span class="line"># Scores: V&#x2F;M &#x3D; 0.00</span><br><span class="line"># Time range: all events occurred at 2016-11-22 06:11:40</span><br><span class="line"># Attribute    pct   total     min     max     avg     95%  stddev  median</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># Count         50       1</span><br><span class="line"># Exec time     76      2s      2s      2s      2s      2s       0      2s</span><br><span class="line"># Lock time      0       0       0       0       0       0       0       0</span><br><span class="line"># Rows sent     20       1       1       1       1       1       0       1</span><br><span class="line"># Rows examine   0       0       0       0       0       0       0       0</span><br><span class="line"># Query size     3      15      15      15      15      15       0      15</span><br><span class="line"># String:</span><br><span class="line"># Databases    test</span><br><span class="line"># Hosts        192.168.8.1</span><br><span class="line"># Users        mysql</span><br><span class="line"># Query_time distribution</span><br><span class="line">#   1us</span><br><span class="line">#  10us</span><br><span class="line"># 100us</span><br><span class="line">#   1ms</span><br><span class="line">#  10ms</span><br><span class="line"># 100ms</span><br><span class="line">#    1s  ################################################################</span><br><span class="line">#  10s+</span><br><span class="line"># EXPLAIN &#x2F;*!50100 PARTITIONS*&#x2F;</span><br><span class="line">select sleep(2)\G</span><br></pre></td></tr></table></figure><h5 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h5><p>1.直接分析慢查询文件:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest  slow.log &gt; slow_report.log</span><br></pre></td></tr></table></figure><p>2.分析最近12小时内的查询：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest  --since&#x3D;12h  slow.log &gt; slow_report2.log</span><br></pre></td></tr></table></figure><p>3.分析指定时间范围内的查询：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest slow.log --since &#39;2017-01-07 09:30:00&#39; --until &#39;2017-01-07 10:00:00&#39;&gt; &gt; slow_report3.log</span><br></pre></td></tr></table></figure><p>4.分析指含有select语句的慢查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --filter &#39;$event-&gt;&#123;fingerprint&#125; &#x3D;~ m&#x2F;^select&#x2F;i&#39; slow.log&gt; slow_report4.log</span><br></pre></td></tr></table></figure><p>5.针对某个用户的慢查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --filter &#39;($event-&gt;&#123;user&#125; || &quot;&quot;) &#x3D;~ m&#x2F;^root&#x2F;i&#39; slow.log&gt; slow_report5.log</span><br></pre></td></tr></table></figure><p>6.查询所有所有的全表扫描或full join的慢查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --filter &#39;(($event-&gt;&#123;Full_scan&#125; || &quot;&quot;) eq &quot;yes&quot;) ||(($event-&gt;&#123;Full_join&#125; || &quot;&quot;) eq &quot;yes&quot;)&#39; slow.log&gt; slow_report6.log</span><br></pre></td></tr></table></figure><p>7.把查询保存到query_review表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --user&#x3D;root –password&#x3D;abc123 --review  h&#x3D;localhost,D&#x3D;test,t&#x3D;query_review--create-review-table  slow.log</span><br></pre></td></tr></table></figure><p>8.把查询保存到query_history表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest  --user&#x3D;root –password&#x3D;abc123 --review  h&#x3D;localhost,D&#x3D;test,t&#x3D;query_history--create-review-table  slow.log_0001</span><br><span class="line">pt-query-digest  --user&#x3D;root –password&#x3D;abc123 --review  h&#x3D;localhost,D&#x3D;test,t&#x3D;query_history--create-review-table  slow.log_0002</span><br></pre></td></tr></table></figure><p>9.通过tcpdump抓取mysql的tcp协议数据，然后再分析</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -s 65535 -x -nn -q -tttt -i any -c 1000 port 3306 &gt; mysql.tcp.txt</span><br><span class="line">pt-query-digest --type tcpdump mysql.tcp.txt&gt; slow_report9.log</span><br></pre></td></tr></table></figure><p>10.分析binlog</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog mysql-bin.000093 &gt; mysql-bin000093.sql</span><br><span class="line">pt-query-digest  --type&#x3D;binlog  mysql-bin000093.sql &gt; slow_report10.log</span><br></pre></td></tr></table></figure><p>11.分析general log</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest  --type&#x3D;genlog  localhost.log &gt; slow_report11.log</span><br></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>springboot单元测试中使用 mock</title>
    <link href="/2018/07/20/junit%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8mock/"/>
    <url>/2018/07/20/junit%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8mock/</url>
    
    <content type="html"><![CDATA[<p>使用场景：</p><p>做单元测试时，需要依赖一个RPC接口，而该接口并不是测试所关心的地方，可以一个使用mock来返回一个虚假的值而避免复杂化测试过程。</p><p>以此类推，要依赖任何和测试无关并且比较复杂/执行慢/接口在变化or不确定的代码，都可以使用mock</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ApplicationTest是springboot单元测试的启动类，本例通过继承方式加载</span></span><br><span class="line"><span class="comment">// 设置单元测试的配置文件，通常放在test目录下</span></span><br><span class="line"><span class="meta">@ActiveProfiles(&quot;mock-test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestrictCheckServiceImplTest</span> <span class="keyword">extends</span> <span class="title">ApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger LOG =</span><br><span class="line">            LoggerFactory.getLogger(RestrictCheckServiceImplTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mock对象</span></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArrangeAssistMaintain arrangeAssistMaintain;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mock注入对象(测试类)</span></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestrictCheckServiceImpl restrictCheckService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mockClassroom</span><span class="params">()</span></span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 当调用 getClassroomById(Long id) 方法时，执行mock方法</span></span><br><span class="line">        Mockito.when(arrangeAssistMaintain.getClassroomById(Mockito.anyLong()))</span><br><span class="line">                .thenAnswer((Answer&lt;Classroom&gt;) invocationOnMock -&gt; &#123;</span><br><span class="line">            Long classroomId = invocationOnMock.getArgumentAt(<span class="number">0</span>, Long.class);</span><br><span class="line">            LOG.info(<span class="string">&quot;============ mock 教室 ============&quot;</span>);</span><br><span class="line">            Classroom classroom = <span class="keyword">new</span> Classroom();</span><br><span class="line">            classroom.setId(classroomId);</span><br><span class="line">            classroom.setType(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            classroom.setName(<span class="string">&quot;mock教室&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> classroom;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getClassroom</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Classroom classroom = restrictCheckService.getClassroom(<span class="number">1</span>);</span><br><span class="line">        System.out.println(ToStringBuilder.reflectionToString(classroom));</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中要注意的地方:</p><ol><li>记得在配置mock的代码<strong>之前</strong> 执行 <em>MockitoAnnotations.initMocks(this);</em></li><li>被 <strong>@InjectMocks</strong>  标记注入的类 (在本例中为 <strong>RestrictCheckServiceImpl</strong>)，一定要有被注入类的set方法，否则注入失败，并且不会报出任何异常</li><li>mock对象的变量名尽量与被注入类中的变量名相同，经验证变量名不同也可以注入，但当存在多个同类型变量时，可能会产生困扰</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>element-ui的响应式栅格布局</title>
    <link href="/2018/07/10/element-ui-%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%A0%85%E6%A0%BC%E5%B8%83%E5%B1%80/"/>
    <url>/2018/07/10/element-ui-%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%A0%85%E6%A0%BC%E5%B8%83%E5%B1%80/</url>
    
    <content type="html"><![CDATA[<p>要注意的问题</p><ul><li><p>xs、sm、md、lg、xl 五个尺寸的默认值均为24，意味着，任何一个尺寸属性不设置，则该尺寸下响应式宽度为24，这与bootstrap不同</p></li><li><p>尺寸属性可以设为0，则该el-col不显示</p></li><li><p>不论尺寸属性设置为多少，若el-col中没有任何内容则该el-col不显示（内部元素为空也不行，如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-col&gt;</span><br><span class="line">    &lt;div&gt;&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;span&gt;&lt;&#x2F;span&gt;</span><br><span class="line">&lt;&#x2F;el-col&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-row&gt;</span><br><span class="line">    &lt;el-col :xs&#x3D;&quot;12&quot; :sm&#x3D;&quot;9&quot; :md&#x3D;&quot;6&quot; :lg&#x3D;&quot;0&quot; :xl&#x3D;&quot;0&quot;&gt;123&lt;&#x2F;el-col&gt;</span><br><span class="line">    &lt;el-col :xs&#x3D;&quot;12&quot; :sm&#x3D;&quot;15&quot; :md&#x3D;&quot;18&quot; :lg&#x3D;&quot;21&quot; :xl&#x3D;&quot;24&quot;&gt;456&lt;&#x2F;el-col&gt;</span><br><span class="line">&lt;&#x2F;el-row&gt;</span><br></pre></td></tr></table></figure></li><li><p>offset 属性是没有响应式的，可以通过加入一个带一个空格的el-col解决： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-col :xs&#x3D;&quot;0&quot; :sm&#x3D;&quot;1&quot; :md&#x3D;&quot;2&quot; :lg&#x3D;&quot;3&quot; :xl&#x3D;&quot;3&quot;&gt;&amp;nbsp;&lt;&#x2F;el-col&gt;</span><br></pre></td></tr></table></figure></li></ul><p>可以把固定的响应式布局作为组件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(&#39;my-container&#39;,&#123;</span><br><span class="line">    template:&#96;</span><br><span class="line">    &lt;el-row&gt;</span><br><span class="line">        &lt;el-col :xs&#x3D;&quot;0&quot; :sm&#x3D;&quot;1&quot; :md&#x3D;&quot;2&quot; :lg&#x3D;&quot;3&quot; :xl&#x3D;&quot;4&quot;&gt;&amp;nbsp;&lt;&#x2F;el-col&gt;</span><br><span class="line">        &lt;el-col :xs&#x3D;&quot;24&quot; :sm&#x3D;&quot;22&quot; :md&#x3D;&quot;20&quot; :lg&#x3D;&quot;18&quot; :xl&#x3D;&quot;18&quot;&gt;</span><br><span class="line">            &lt;slot&gt;&lt;&#x2F;slot&gt;</span><br><span class="line">        &lt;&#x2F;el-col&gt;</span><br><span class="line">        &lt;el-col :xs&#x3D;&quot;0&quot; :sm&#x3D;&quot;1&quot; :md&#x3D;&quot;2&quot; :lg&#x3D;&quot;3&quot; :xl&#x3D;&quot;4&quot;&gt;&amp;nbsp;&lt;&#x2F;el-col&gt;</span><br><span class="line">    &lt;&#x2F;el-row&gt;</span><br><span class="line">    &#96;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>就可以愉快的使用了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;my-container&gt;</span><br><span class="line">    &lt;div style&#x3D;&quot;background: red&quot;&gt;内容&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;my-container&gt;&#96;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用Feign进行应用间通信</title>
    <link href="/2018/05/23/%E4%BD%BF%E7%94%A8Feign%E8%BF%9B%E8%A1%8C%E5%BA%94%E7%94%A8%E9%97%B4%E9%80%9A%E4%BF%A1/"/>
    <url>/2018/05/23/%E4%BD%BF%E7%94%A8Feign%E8%BF%9B%E8%A1%8C%E5%BA%94%E7%94%A8%E9%97%B4%E9%80%9A%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="使用Feign进行应用间通信"><a href="#使用Feign进行应用间通信" class="headerlink" title="使用Feign进行应用间通信"></a>使用Feign进行应用间通信</h2><h5 id="添加maven依赖"><a href="#添加maven依赖" class="headerlink" title="添加maven依赖"></a>添加maven依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.M2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>坑</strong><br>我是用了 <strong>Spring Boot 2.0.2.RELEASE</strong>  以及其对应的spring-cloud版本 <strong>Spring-Cloud Finchley.RC2</strong> 即2.0.0.RC2<br>按理说，spring-cloud-starter-feign 应该不再需要指定版本，然而maven的中央仓库中甚至都没有2.0版本的 Feign。spring官方仓库也没有对应版本，因此不指定版本就无法导入依赖了，但是好歹有可兼容的2.0.x版本，所以指定版本 <strong>2.0.0.M2</strong> </p><p>大概是因为Spring Boot 2.0刚发布没几个月，对应的版本还没有发布吧？作为一个菜鸟，就不该作死用2.0版本学习spring cloud，一堆麻烦:(</p><p><img src="https://upload-images.jianshu.io/upload_images/3867641-30328eaf1c0a8a05.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="maven中央仓库"></p><p><img src="https://upload-images.jianshu.io/upload_images/3867641-d9745dbf1964ad6a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="spring官方仓库"></p><h5 id="使用Feign"><a href="#使用Feign" class="headerlink" title="使用Feign"></a>使用Feign</h5><p>Feign 的使用非常简单<br>新建类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lzlz.demo.springcloud.consumer.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其实不需要加@Component注解，只是idea无法识别，在注入的地方提示错误</span></span><br><span class="line"><span class="comment">// 虽然不影响编译运行，但是看着不舒服，不在意的可以忽略</span></span><br><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="meta">@FeignClient(name = &quot;product&quot;)</span> <span class="comment">//对应的应用名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/echo&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">productMsg</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在需要使用的地方注入此对象，调用对应方法即可：<br><code>String resp = productClient.productMsg();</code></p><p>在FeignClient中 可以完全像Controller那样使用各种 <code>@RequestMapping</code> 注解，用于类和方法上。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@FeignClient(name &#x3D; &quot;product&quot;)</span><br><span class="line">@RequestMapping(&quot;test&quot;)</span><br><span class="line">public interface ProductClient &#123;</span><br><span class="line">    @GetMapping(&quot;&#x2F;echo&quot;)</span><br><span class="line">    String productMsg();</span><br><span class="line"></span><br><span class="line">    @PostMapping(&quot;&#x2F;echo&quot;)</span><br><span class="line">    String productMsg1();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Feign，我们就如同调用本地方法一样使用rest远程调用，体验还是不错滴。</p>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>spring-cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用RestTemplate进行应用间通信</title>
    <link href="/2018/05/22/%E4%BD%BF%E7%94%A8RestTemplate%E8%BF%9B%E8%A1%8C%E5%BA%94%E7%94%A8%E9%97%B4%E9%80%9A%E4%BF%A1/"/>
    <url>/2018/05/22/%E4%BD%BF%E7%94%A8RestTemplate%E8%BF%9B%E8%A1%8C%E5%BA%94%E7%94%A8%E9%97%B4%E9%80%9A%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="使用RestTemplate进行应用间通信"><a href="#使用RestTemplate进行应用间通信" class="headerlink" title="使用RestTemplate进行应用间通信"></a>使用RestTemplate进行应用间通信</h2><p>上文中我们已经准备好了 Eureka Server，在测试环境中，就不需要多个Eureka了，启动一个应用即可，为了方便我们打包运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar .\target\eureka-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/3867641-ae7dbf9d401a1954.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p>我们再创建两个 Spring Boot 项目，分别为product，consumer 并修改配置文件注册到 Eureka 中</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure><p>记得在启动类添加注解 <code>@EnableEurekaClient</code></p><h6 id="product项目中"><a href="#product项目中" class="headerlink" title="product项目中"></a>product项目中</h6><p>添加controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;echo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echoeMessage</span><span class="params">(HttpServletRequest request)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;this is server &quot;</span>+ request.getServerName()+<span class="string">&quot;:&quot;</span>+request.getServerPort();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="consumer-项目中"><a href="#consumer-项目中" class="headerlink" title="consumer 项目中"></a>consumer 项目中</h6><p>添加config类，其中<code>@LoadBalanced</code>注解帮助提供一个负载均衡的RestTemplate Bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加 controller，其中 restTemplate直接在url中用在Eureka中注册的应用名代替地址和端口,在product项目中，我们配置的应用名</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">product</span></span><br></pre></td></tr></table></figure><p>代码调用（应用名不区分大小写）<br><code>restTemplate.getForObject(&quot;http://product/echo&quot;,String.class);</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class ClientController &#123;</span><br><span class="line"></span><br><span class="line">    private RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public ClientController(RestTemplate restTemplate) &#123;</span><br><span class="line">        this.restTemplate &#x3D; restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#x2F;product-msg&quot;)</span><br><span class="line">    public String getProductMsg()&#123;</span><br><span class="line">        String resp &#x3D; restTemplate.getForObject(&quot;http:&#x2F;&#x2F;product&#x2F;echo&quot;,String.class);</span><br><span class="line">        log.info(&quot;response&#x3D;&#123;&#125;&quot;,resp);</span><br><span class="line">        return resp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过-Dserver.port=xxxx设置不同的端口，启动多个product实例，idea中：<img src="https://upload-images.jianshu.io/upload_images/3867641-05f910499d165abd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p>或者打包执行 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar xxxxx.jar --server.port&#x3D;xxxx </span><br></pre></td></tr></table></figure><p>我们启动两个实例，使用8080和8081端口</p><p>启动consumer，反复请求地址 <a href="http://localhost:8180/product-msg">http://localhost:8180/product-msg</a><br>将会得到不同的返回：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">this is server 192.168.1.107:8081</span><br><span class="line">this is server 192.168.1.107:8080</span><br><span class="line">this is server 192.168.1.107:8081</span><br><span class="line">this is server 192.168.1.107:8080</span><br></pre></td></tr></table></figure><p>可以发现，请求在两个服务器间轮换执行<br>我们可以在client的配置文件中配置负载均衡的规则，我们把负载均衡规则改为 随机</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#应用名</span></span><br><span class="line"><span class="attr">PRODUCT:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure><p>所有规则均在 com.netflix.loadbalancer包下并实现 com.netflix.loadbalancer.IRule接口，默认使用 com.netflix.loadbalancer.RoundRobinRule</p>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>spring-cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用多个 Eureka</title>
    <link href="/2018/05/21/%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA-Eureka-Server/"/>
    <url>/2018/05/21/%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA-Eureka-Server/</url>
    
    <content type="html"><![CDATA[<h2 id="使用多个-Eureka"><a href="#使用多个-Eureka" class="headerlink" title="使用多个 Eureka"></a>使用多个 Eureka</h2><p>通过不同的配置文件 application.yml 启动多个实例来实现</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Server 1</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> </span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8762/eureka/</span> <span class="comment">#两个server相互注册</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-demo</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Server 2</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8762</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> </span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment">#两个server相互注册</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-demo</span></span><br></pre></td></tr></table></figure><p>这样 在 idea 或者 Eclipse 中我们需要启动一个实例，然后修改配置再启动一个实例，有点乱。<br>可以把 application.yml 定义为下面的形式：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无参数启动</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-demo</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment">#防止由于eureka的机制导致 client 被错误显示在线 在开发环境使用</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 启动参数 --spring.profiles.active=server1</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">server1</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line"><span class="string">​</span>    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8762/eureka/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 启动参数 --spring.profiles.active=server2</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">server2</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8762</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line"><span class="string">​</span>    <span class="attr">service-url:</span></span><br><span class="line"><span class="string">​</span>      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure><p>运行方式</p><ol><li>在idea中运行<br>新建2个运行配置 server1 server2，按图片所示分别添加参数<br>​<code>--spring.profiles.active=server1</code><br>​<code>--spring.profiles.active=server2</code><br><img src="https://upload-images.jianshu.io/upload_images/3867641-311c2582738563e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></li><li>打包运行<br>启动两个cmd窗口，切换到项目目录下，分别运行<br>​<code>java -jar target/eureka-0.0.1-SNAPSHOT.jar --spring.profiles.active=server1</code><br>​<code>java -jar target/eureka-0.0.1-SNAPSHOT.jar --spring.profiles.active=server2</code></li></ol><p>我们同时运行刚才创建的 Client，注意我们只把 Client 注册到了<code>http://localhost:8761/eureka/</code> 也就是server1中<br>此时，localhost:8761,localhost:8762的Eureka Server 均显示如下，即只在server1中注册的Client也被注册到了server2<img src="https://upload-images.jianshu.io/upload_images/3867641-b9e6e0ebca02eea4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p>虽然，Client被自动注册到了server2，但是如果server1不启动，server2无法得到Client的注册（Client在server2注册后，server1变成不可用并不影响）。所以我们在Client中做修改,配置2个defaultZone<br>​```yml<br>eureka:<br>  client:<br>​    service-url:<br>​      defaultZone: <a href="http://localhost:8761/eureka/,http://localhost:8762/eureka/">http://localhost:8761/eureka/,http://localhost:8762/eureka/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">当有3个Eureka Server时，以此类推，三个Server相互配置另外2个地址，Client 配置 3个地址</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>spring-cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>创建配置Eureka</title>
    <link href="/2018/05/20/%E5%88%9B%E5%BB%BA%E3%80%81%E9%85%8D%E7%BD%AEEureka-Server-%E5%92%8C-Client/"/>
    <url>/2018/05/20/%E5%88%9B%E5%BB%BA%E3%80%81%E9%85%8D%E7%BD%AEEureka-Server-%E5%92%8C-Client/</url>
    
    <content type="html"><![CDATA[<p>开发环境 Windows10、 IDEA 2018.1.3 ，Spring Boot 版本 2.0.2.RELEASE</p><h5 id="通过-idea-创建Eureka-server项目"><a href="#通过-idea-创建Eureka-server项目" class="headerlink" title="通过 idea 创建Eureka server项目"></a>通过 idea 创建Eureka server项目</h5><p>New Project-&gt; Spring Initalizr<br>next 修改group 和 artifact<br>next 我使用的是2.0.2版本的SpringBoot 注意在选择依赖时 勾选 Web 和 Eureka Server<br><img src="https://upload-images.jianshu.io/upload_images/3867641-9a7c8bf374c7217f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><br>一路确定 完成创建。</p><h5 id="配置启动项目"><a href="#配置启动项目" class="headerlink" title="配置启动项目"></a>配置启动项目</h5><p>首先就有一个坑，在墙内我们喜欢用阿里云的maven仓库，<br>与 <em>SpringBoot</em>  <code>2.0.2.RELEASE</code>版本对应的 <em>Spring Cloud</em> 版本是<code>Finchley.RC2</code>，通过<em>Spring Initalizr_创建的项目会自动选择合适的版本。<br>但是阿里云仓库里似乎没有这个版本的 _Spring Cloud</em> ，导致 <em>Eureka</em> 相关的包都找不到。</p><p>哎，我也是搞了好久才发现是这个问题，以前都以为阿里云maven仓库应该是完整的。后来我发现这个锅也不能让阿里仓库背，maven中央仓库的版本甚至比阿里仓库还低，在pom中手动添加spring官方仓库，里面有所需版本 <code>Finchley.RC2</code>。菜鸟学习技术需谨慎啊，盲目使用最新版本，给自己带来不必要的麻烦。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;repositories&gt;</span><br><span class="line">    &lt;repository&gt;</span><br><span class="line">        &lt;id&gt;spring-milestones&lt;&#x2F;id&gt;</span><br><span class="line">        &lt;name&gt;Spring Milestones&lt;&#x2F;name&gt;</span><br><span class="line">        &lt;url&gt;https:&#x2F;&#x2F;repo.spring.io&#x2F;milestone&lt;&#x2F;url&gt;</span><br><span class="line">        &lt;snapshots&gt;</span><br><span class="line">            &lt;enabled&gt;false&lt;&#x2F;enabled&gt;</span><br><span class="line">        &lt;&#x2F;snapshots&gt;</span><br><span class="line">    &lt;&#x2F;repository&gt;</span><br><span class="line">&lt;&#x2F;repositories&gt;</span><br></pre></td></tr></table></figure><p>使用 application.yml 的配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span> <span class="comment"># 8761是eureka server的默认端口</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment">#防止由于Eureka的机制导致Client被错误显示在线 仅在开发环境使用</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment">#这便是此eureka server的应用注册地址</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#不显示对server应用的注册</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-demo</span></span><br></pre></td></tr></table></figure><p>记得在springboot 启动类上加上注解<code>@EnableEurekaServer</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package lzlz.demo.springcloud.eureka;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaServer</span><br><span class="line">public class EurekaApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在就可以启动啦，红色的警告部分就是配置<code>enable-self-preservation: false</code>造成的<br><img src="https://upload-images.jianshu.io/upload_images/3867641-247ff9a28424023f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>也可以通过 <code>mvn clean package</code> 把此项目编译成jar包方便使用，jar包在 target目录下。</p><h5 id="创建-配置Eureka-Client项目"><a href="#创建-配置Eureka-Client项目" class="headerlink" title="创建 配置Eureka Client项目"></a>创建 配置Eureka Client项目</h5><p>New Project-&gt; Spring Initalizr<br>next 修改group 和 artifact<br>next 我使用的是2.0.2版本的SpringBoot 选择 Web 和 Eureka Discovery 依赖<br><img src="https://upload-images.jianshu.io/upload_images/3867641-6ea44056d7fa4fee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p>一路确定 完成创建。</p><p>使用 application.yml 的配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment">#注册到刚才那台Eureka Server地址</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client-0</span></span><br></pre></td></tr></table></figure><p>记得在 <em>SpringBoot</em> 启动类上加上注解<code>@EnableDiscoveryClient</code></p><h6 id="运行Server-和-Client"><a href="#运行Server-和-Client" class="headerlink" title="运行Server 和 Client"></a>运行Server 和 Client</h6><p>可以看到名为 <em>client-0</em> 的应用已经注册到 <em>Eureka</em> 中<br><img src="https://upload-images.jianshu.io/upload_images/3867641-485fb1c48cf134f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p><p>注意 Eureka 服务端和客户端的连接有心跳检测的机制，因此客户端连接或者断开连接都可能不是即时反应的。</p>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>spring-cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringBoot+ajax长轮询实现简单即时通讯</title>
    <link href="/2018/03/10/SpringBoot-AJAX-%E9%95%BF%E8%BD%AE%E8%AF%A2%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/"/>
    <url>/2018/03/10/SpringBoot-AJAX-%E9%95%BF%E8%BD%AE%E8%AF%A2%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/</url>
    
    <content type="html"><![CDATA[<p>先来看看需要实现的效果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 客户端A</span><br><span class="line">&gt; IM.subscribe(&#39;频道1&#39;)</span><br><span class="line">&gt; IM.subscribe(&#39;频道2&#39;)</span><br><span class="line">&lt; undefined</span><br><span class="line">订阅 [频道1] 成功</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 客户端B 发送了消息</span><br><span class="line">&gt; IM.send(&#39;频道1&#39;,&#39;hello world&#39;)</span><br><span class="line">&#x2F;&#x2F; 客户端C 短时间内向 [频道1] 和 [频道2] 发送了多条消息 “频道1message1”-&quot;频道1message10&quot;,“频道2message1”-&quot;频道2message10&quot;</span><br><span class="line">for(...)&#123;IM.send(&#39;频道1&#39;,&#39;....&#39;)&#125;;for(...)&#123;IM.send(&#39;频道2&#39;,&#39;....&#39;)&#125;</span><br><span class="line">发送成功</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 客户端A收到消息</span><br><span class="line">[&#123;&quot;text&quot;:&quot;hello world&quot;&#125;]</span><br><span class="line">&#x2F;&#x2F; 客户端A收到消息</span><br><span class="line">[&#123;&quot;text&quot;:&quot;频道1message1&quot;&#125;,&#123;&quot;text&quot;:&quot;频道1message2&quot;&#125;, ...... </span><br><span class="line">&#123;&quot;text&quot;:&quot;频道1message10&quot;&#125;,&#123;&quot;text&quot;:&quot;频道2message1&quot;&#125;, ...... </span><br><span class="line">&#123;&quot;text&quot;:&quot;频道2message10&quot;&#125;]</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;取消订阅 频道2</span><br><span class="line">&gt; IM.unsubscribe(&#39;频道2&#39;)</span><br></pre></td></tr></table></figure><p>需要实现</p><ol><li>订阅频道</li><li>取消订阅</li><li>发送消息</li><li>接收消息</li></ol><hr><p>首先，我们需要使用 <code>org.springframework.web.context.request.async.DeferredResult</code> 来做消息的异步返回。<br>关于<code>DeferredResult</code>的用法，不做详细介绍，可以看看这个简单的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.async.DeferredResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test/deferredResult&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeferredResultController</span> </span>&#123;</span><br><span class="line">    <span class="comment">//DeferredResult存储在队列中，若同时有多个request1接收到时，request2可以把消息发送给所有的request1请求</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;DeferredResult&lt;String&gt;&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;request1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">request1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DeferredResult&lt;String&gt; result = <span class="keyword">new</span> DeferredResult&lt;&gt;(<span class="number">10000L</span>); <span class="comment">//设置过期时间 10000ms</span></span><br><span class="line">        result.onTimeout(()-&gt;result.setResult(<span class="string">&quot;deferredResult已过期&quot;</span>));</span><br><span class="line">        <span class="keyword">synchronized</span> (queue)&#123;</span><br><span class="line">            queue.add(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;request2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">request2</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (queue)&#123;</span><br><span class="line">            queue.forEach(deferredResult -&gt; &#123;</span><br><span class="line">                deferredResult.setResult(message);</span><br><span class="line">                queue.remove(deferredResult);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li> 向request1 <em>/test/deferredResult/request1</em> 发送请求</li><li> 向request1 <em>/test/deferredResult/request2</em> 发送请求，data为 <em>{“message”:”hello world”}</em> 。此时request1、request2分别返回了值*”hello world”,”success”*</li><li>若过期时间内没有请求request2 返回消息 “deferredResult已过期”</li></ol><p>这就是通过长轮询接收消息的基本方式：发送请求到服务器，服务器收到请求后保持请求，当收到消息时通过此请求返回消息。</p><hr><p>定义客户端和频道这两个类：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;客户端</span><br><span class="line">@Data</span><br><span class="line">public class IMClient&#123;</span><br><span class="line">    String id;</span><br><span class="line">    String name;</span><br><span class="line">    long saveTime;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 过期时间 ms，&lt;&#x3D;0即不过期</span><br><span class="line">     *&#x2F;</span><br><span class="line">    int expire;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;频道</span><br><span class="line">@Data</span><br><span class="line">public class Channel &#123;</span><br><span class="line">    String name;</span><br><span class="line">    Set&lt;IMClient&gt; subscriptionSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们在客户端通过循环调用的方式-收到返回的结果时再次发送请求，来保证服务器一直手握着客户端的请求，而且对于一个客户端至多只有一个请求，节省资源。<br><img src="/images/1240"></p><p>通过jquery实现的代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">poll</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url:<span class="string">&quot;/im/poll&quot;</span>,</span><br><span class="line">        type: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">            <span class="built_in">setTimeout</span>(poll,<span class="number">500</span>);<span class="comment">//给点延时 减少请求的频率</span></span><br><span class="line">        &#125;,</span><br><span class="line">        error: <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(err));</span><br><span class="line">            <span class="built_in">setTimeout</span>(poll,<span class="number">5000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然而 ，在服务器端返回请求后直到收到客户端下一个请求之前的这段时间，服务器并没有维持着客户端的请求。这段时间内发送给服务器的消息将被丢失，因此我们需要一个消息队列来保存未发送的消息：<img src="/images/12401">通过在收到消息和收到轮询请求时都调用flush方法，消息可以尽可能即时地发送给客户端 – 当DeferredResult可用时，收到消息立刻返回，当DeferredResult不可用时，在收到轮询请求后立刻返回消息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lzlz000.entity.CommonMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.async.DeferredResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IMMessageQueue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> DeferredResult&lt;List&lt;CommonMessage&gt;&gt; result;</span><br><span class="line">    <span class="comment">//使用LinkedList作为消息队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;CommonMessage&gt; messageQueue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(CommonMessage message)</span></span>&#123;</span><br><span class="line">        messageQueue.add(message);</span><br><span class="line">        flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> DeferredResult&lt;List&lt;CommonMessage&gt;&gt; poll()&#123;</span><br><span class="line">        result = <span class="keyword">new</span> DeferredResult&lt;&gt;(<span class="number">10000L</span>);</span><br><span class="line">        flush();</span><br><span class="line">        result.onTimeout(()-&gt;result.setResult(<span class="keyword">null</span>));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * flush()方法会在DeferredResult可用（非空且未被使用）时把消息发送出去，在send和poll时都会执行flush(),</span></span><br><span class="line"><span class="comment"> * 这样无论什么情况下消息最终都会被发送出去</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (result!=<span class="keyword">null</span>&amp;&amp;!result.hasResult()&amp;&amp;messageQueue.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//这里需要拷贝一份消息，因为此处为异步调用，而在当前线程中，messageQueue的引用随后将被clear()</span></span><br><span class="line">            result.setResult(<span class="keyword">new</span> ArrayList&lt;&gt;(messageQueue));</span><br><span class="line">            messageQueue.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>接下来就是要维护频道和客户端了，我通过ClientService 和 ChannelService来实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lzlz000.entity.im.IMClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> expire = <span class="number">600</span> * <span class="number">1000</span>;<span class="comment">//user的过期时间 600s没有活动 频道中的user自动过期</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过期时间间隔</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 过期时间间隔(ms)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getExpire</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expire;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取默认过期时间的IMClient </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session httpSession</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IMClient <span class="title">getIMClient</span><span class="params">(HttpSession session)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getIMClient(session,<span class="keyword">this</span>.expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定过期时间的IMClient </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session httpSession</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expire 过期时间，&lt;=0代表不会过期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IMClient <span class="title">getIMClient</span><span class="params">(HttpSession session, <span class="keyword">int</span> expire)</span></span>&#123;</span><br><span class="line">        IMClient client =(IMClient)session.getAttribute(<span class="string">&quot;imUser&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(client != <span class="keyword">null</span>&amp;&amp;client.getSaveTime()&lt;= <span class="keyword">new</span> Date().getTime())&#123;<span class="comment">//如果过期 则从session中删除用户</span></span><br><span class="line">            session.removeAttribute(<span class="string">&quot;imUser&quot;</span>);</span><br><span class="line">            client = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</span><br><span class="line">            client = <span class="keyword">new</span> IMClient();<span class="comment">//测试时client的作用仅仅是作为map的key所以new一个即可</span></span><br><span class="line">            client.setId(UUID.randomUUID().toString());</span><br><span class="line">            client.setSaveTime(<span class="keyword">new</span> Date().getTime()+expire);<span class="comment">//设置过期时间</span></span><br><span class="line">            session.setAttribute(<span class="string">&quot;imUser&quot;</span>,client);</span><br><span class="line">        &#125;</span><br><span class="line">        client.setExpire(expire);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExpired</span><span class="params">(IMClient client)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> client.getExpire() &gt; <span class="number">0</span> &amp;&amp; client.getSaveTime() &lt;= <span class="keyword">new</span> Date().getTime();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ChannelService</strong>  实现订阅、取消订阅、发送、接收的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lzlz000.entity.im.Channel;</span><br><span class="line"><span class="keyword">import</span> lzlz000.entity.CommonMessage;</span><br><span class="line"><span class="keyword">import</span> lzlz000.entity.im.IMClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.async.DeferredResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChannelService</span> <span class="keyword">implements</span> <span class="title">IChannelService</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientService clientService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//客户端ID与消息队列映射</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,IMMessageQueue&gt; resultMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//客户端ID与频道的映射</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,Channel&gt; channelMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChannelService</span><span class="params">(ClientService imUserService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientService = imUserService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(String channelName, IMClient client)</span> </span>&#123;</span><br><span class="line">        Channel channel = channelMap.get(channelName);</span><br><span class="line">        <span class="keyword">if</span> (channel==<span class="keyword">null</span>) &#123;</span><br><span class="line">            channel = <span class="keyword">new</span> Channel(channelName,<span class="keyword">new</span> HashSet&lt;&gt;());</span><br><span class="line">            channelMap.put(channelName,channel);</span><br><span class="line">        &#125;</span><br><span class="line">        channel.getSubscriptionSet().add(client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unsubscribe</span><span class="params">(String channelName, IMClient client)</span> </span>&#123;</span><br><span class="line">        Channel channel = channelMap.get(channelName);</span><br><span class="line">        <span class="keyword">if</span> (channel==<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Set subscriptionSet = channel.getSubscriptionSet();</span><br><span class="line">        subscriptionSet.remove(client);</span><br><span class="line">        <span class="keyword">if</span>(subscriptionSet.size()==<span class="number">0</span>)&#123;</span><br><span class="line">            channelMap.remove(channelName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unsubscribe</span><span class="params">(IMClient client)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            channelMap.values().forEach(channel -&gt; channel.getSubscriptionSet().remove(client));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">emit</span><span class="params">(String channelName, IMClient sender , CommonMessage data)</span> </span>&#123;</span><br><span class="line">        sender.setSaveTime(<span class="keyword">new</span> Date().getTime() + clientService.getExpire());<span class="comment">//发送消息时候更新savetime</span></span><br><span class="line">        Channel channel = channelMap.get(channelName);</span><br><span class="line">        <span class="keyword">if</span> (channel!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//当已达到过期时间 删除此client,并且从resultMap中删除对应的消息</span></span><br><span class="line">            channel.getSubscriptionSet().forEach(imUser -&gt; &#123;</span><br><span class="line">                <span class="keyword">boolean</span> isExpired = clientService.isExpired(imUser);</span><br><span class="line">                <span class="keyword">if</span>(isExpired)&#123;</span><br><span class="line">                    channel.getSubscriptionSet().remove(imUser);</span><br><span class="line">                    resultMap.remove(imUser.getId());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            channel.getSubscriptionSet().forEach(client-&gt; send(client,data));</span><br><span class="line">            <span class="comment">//当channel中没有订阅者，删除此channel</span></span><br><span class="line">            <span class="keyword">if</span>( channel.getSubscriptionSet().size()==<span class="number">0</span>)&#123;</span><br><span class="line">                channelMap.remove(channelName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DeferredResult&lt;List&lt;CommonMessage&gt;&gt; poll(IMClient receiver)&#123;</span><br><span class="line">        IMMessageQueue queue = resultMap.get(receiver.getId());</span><br><span class="line">        <span class="keyword">if</span> (queue==<span class="keyword">null</span>) &#123;</span><br><span class="line">            queue = <span class="keyword">new</span> IMMessageQueue();</span><br><span class="line">            resultMap.put(receiver.getId(),queue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> queue.poll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(IMClient receiver, CommonMessage message)</span></span>&#123;</span><br><span class="line">        IMMessageQueue queue = resultMap.get(receiver.getId());</span><br><span class="line">        <span class="keyword">if</span> (queue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            queue.send(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lzlz000.entity.im.Message;</span><br><span class="line"><span class="keyword">import</span> lzlz000.service.im.ChannelService;</span><br><span class="line"><span class="keyword">import</span> lzlz000.service.im.ClientService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.async.DeferredResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 长轮询即时通讯Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;im&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IMController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelService channelService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IMController</span><span class="params">(ChannelService channelService, ClientService userService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.channelService = channelService;</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//长轮询</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;poll&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> DeferredResult&lt;List&lt;CommonMessage&gt;&gt; poll(HttpServletRequest req)&#123;</span><br><span class="line">        <span class="keyword">return</span> channelService.poll(userService.getIMClient(req.getSession()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//订阅</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;subscribe&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">subscribe</span><span class="params">(HttpServletRequest req,Message channel)</span></span>&#123;</span><br><span class="line">        channelService.subscribe(channel.getChannel(),userService.getIMClient(req.getSession()));<span class="comment">//测试时User的作用仅仅是作为map的key所以new一个即可</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;订阅: &quot;</span>+channel.getChannel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取消订阅</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;unsubscribe&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">unsubscribe</span><span class="params">(HttpServletRequest req,Message channel)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span>&amp;&amp;channel.getChannel()!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            channelService.unsubscribe(channel.getChannel(),userService.getIMClient(req.getSession()));<span class="comment">//测试时User的作用仅仅是作为map的key所以new一个即可</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;取消订阅:&quot;</span>+channel.getChannel();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            channelService.unsubscribe(userService.getIMClient(req.getSession()));<span class="comment">//测试时User的作用仅仅是作为map的key所以new一个即可</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;取消订阅全部频道&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 似乎识别不了内部的自定义对象CommonMessage,需要HTTP请求设置contentType: &quot;application/json&quot;,</span></span><br><span class="line">    <span class="comment">// 把json转化为字符串传给data,并且此方法设置@RequestBody</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;emit&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">emit</span><span class="params">(HttpServletRequest req, <span class="meta">@RequestBody</span> Message msg)</span></span>&#123;</span><br><span class="line">        msg.setSender(userService.getIMClient(req.getSession()));</span><br><span class="line">        channelService.emit(msg.getChannel(),msg.getSender(),msg.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;发送成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后把controller提供的方法在封装在js中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 长轮询即时通讯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> IM =(<span class="function"><span class="keyword">function</span>(<span class="params">jQuery</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $ =jQuery;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        poll : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                url:<span class="string">&quot;/im/poll&quot;</span>,</span><br><span class="line">                type: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(data));</span><br><span class="line">                    IM.poll();</span><br><span class="line">                &#125;,</span><br><span class="line">                error: <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(err));</span><br><span class="line">                    <span class="built_in">setTimeout</span>(IM.poll,<span class="number">2000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        subscribe : <span class="function"><span class="keyword">function</span>(<span class="params">channel</span>) </span>&#123;</span><br><span class="line">            $.post(<span class="string">&#x27;/im/subscribe&#x27;</span>,&#123;</span><br><span class="line">                channel:channel</span><br><span class="line">            &#125;,<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(e);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        unsubscribe : <span class="function"><span class="keyword">function</span> (<span class="params">channelName</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> channel = channelName?&#123;<span class="attr">channel</span>:channelName&#125;:<span class="literal">null</span>;</span><br><span class="line">            $.post(<span class="string">&#x27;/im/unsubscribe&#x27;</span>,channel,<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(e);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        send : <span class="function"><span class="keyword">function</span>(<span class="params">channel,text</span>) </span>&#123;</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                url:<span class="string">&quot;/im/emit&quot;</span>,</span><br><span class="line">                type: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">                data: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                    channel:channel,</span><br><span class="line">                    message:&#123;</span><br><span class="line">                        text:text</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;),</span><br><span class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(e);</span><br><span class="line">                &#125;,</span><br><span class="line">                dataType: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">                contentType: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)(jQuery);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>至此，可实现文章开头所说的效果</p><hr><p>这其实就是一种 <strong>发布订阅模式</strong><br>客户端既是订阅者（Subscriber）又是发布者（Publisher）<br>但是http请求是客户端主动向服务器发送请求获取返回，发布订阅模式是被动的接收被订阅频道的通知。<br>因此我们只能把客户端的请求存储在服务器中（请求存储在<strong>DeferredResult</strong>对象中），当服务器数据发生改变时，通知订阅者（返回请求）。<br><img src="https://upload-images.jianshu.io/upload_images/3867641-ee9130c763f5f948.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><br>为了保证数据的及时性以及完整性，获取消息–&gt;返回消息–&gt;获取消息 循环执行（即<strong>长轮询</strong>），而服务器对应频道的对应客户端有一个队列保存着未发送的消息，在收到<strong>获取消息</strong>的请求或者<strong>发送消息</strong>的请求时都会尝试<strong>返回消息</strong>。</p>]]></content>
    
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>java</tag>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>最长递增子序列问题</title>
    <link href="/2018/03/10/%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97%E9%97%AE%E9%A2%98-Java/"/>
    <url>/2018/03/10/%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97%E9%97%AE%E9%A2%98-Java/</url>
    
    <content type="html"><![CDATA[<p>最长递增子序列问题 LIS(longest increasing subsequence) 例如</p><blockquote><p>给定一个数列，长度为N，<br>求这个数列的最长上升（递增）子数列（LIS）的长度.<br>以<br>1, 7, 2, 8, 3, 4<br>为例。<br>这个数列的最长递增子数列是 1 2 3 4，长度为4；<br>次长的长度为3， 包括 1 7 8; 1 2 3 等.</p></blockquote><p>设数组为：arr<br>设  foo(k) 为：以数列中第k项 (为了与java数组逻辑一致，这里的k从0开始计算) 结尾的最长递增子序列的长度<br>则：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">foo(<span class="number">0</span>) == <span class="number">1</span> </span><br><span class="line">foo(k) == max(arr[k]&gt;arr[<span class="number">0</span>]?foo(<span class="number">0</span>)+<span class="number">1</span>:foo(<span class="number">0</span>),</span><br><span class="line">              arr[k]&gt;arr[<span class="number">1</span>]?foo(<span class="number">1</span>)+<span class="number">1</span>:foo(<span class="number">1</span>) , </span><br><span class="line">              ... ,</span><br><span class="line">              arr[k]&gt;arr[k-<span class="number">1</span>]?foo(k-<span class="number">1</span>)+<span class="number">1</span>:foo(k-<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p>java代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class LISDemo &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        int[] arr &#x3D; new int[10];</span><br><span class="line">        Random random &#x3D; new Random();</span><br><span class="line">        for (int i &#x3D; 0; i &lt; arr.length; i++) &#123;</span><br><span class="line">            arr[i] &#x3D; random.nextInt(100);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;数组&quot;+Arrays.toString(arr));</span><br><span class="line">        long time &#x3D; System.currentTimeMillis();</span><br><span class="line">        System.out.println(&quot;结果: &quot;+foo(arr, arr.length-1));</span><br><span class="line">        System.out.println(&quot;耗时: &quot;+(System.currentTimeMillis()-time));</span><br><span class="line">    &#125;</span><br><span class="line">    private static int foo(int[] arr,int end)&#123;</span><br><span class="line">        if (end&#x3D;&#x3D;0) &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        int len &#x3D; 0;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; end; i++) &#123;</span><br><span class="line">            int temp &#x3D; foo(arr,i);</span><br><span class="line">            len &#x3D; Math.max(len,arr[end]&gt;arr[i]?temp+1:temp);</span><br><span class="line">        &#125;</span><br><span class="line">        return len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码能计算出正确的结果，但是存在问题：<br>要计算 foo(n)必须先得到 foo(0)<del>foo(n-1)的值<br>要计算 foo(n-1)必须先得到 foo(0)</del>foo(n-2)的值<br>…<br>以此类推，可以把他画成一颗多叉树，时间复杂度达到O(2^n) </p><p>运行这段代码就会发现 每当数组长度+1 运行耗时大致翻倍，数组长度为几十的时候，运行时间已经无法容忍的长了。</p><p>以foo(3)为例，可以画成下面这棵树<br><img src="/images/1240123.png"><br>可以发现，相同参数的方法被重复计算了多遍，我们可以建立一个hashmap把参数和对应的值存入其中，当结果已经计算过，就直接从hashmap中取出结果不再计算，修改代码为如下,保留了原来的方法做个对比，执行效率天差地别:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LISDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">31</span>];</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">            arr[i] = random.nextInt(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;数组&quot;</span>+Arrays.toString(arr));</span><br><span class="line">        LIS lis = <span class="keyword">new</span> LIS(arr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;结果1: &quot;</span>+lis.foo());</span><br><span class="line">        System.out.println(<span class="string">&quot;耗时1: &quot;</span>+(System.currentTimeMillis()-time));</span><br><span class="line"></span><br><span class="line">        time = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;结果2: &quot;</span>+foo(arr, arr.length-<span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;耗时2: &quot;</span>+(System.currentTimeMillis()-time));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最长递增子序列 longest increasing subsequence</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LIS</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr;</span><br><span class="line">        HashMap&lt;Integer,Integer&gt; values = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        LIS(<span class="keyword">int</span>[]arr)&#123;</span><br><span class="line">            <span class="keyword">this</span>.arr = arr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> foo(arr,arr.length-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> end)</span></span>&#123;</span><br><span class="line">            Integer value = values.get(end);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (end==<span class="number">0</span>) &#123;</span><br><span class="line">                values.put(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; end; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> temp = foo(arr,i);</span><br><span class="line">                len = Math.max(len,arr[end]&gt;arr[i]?temp+<span class="number">1</span>:temp);</span><br><span class="line">            &#125;</span><br><span class="line">            values.put(end,len);</span><br><span class="line">            <span class="keyword">return</span> len;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> end)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (end==<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; end; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> temp = foo(arr,i);</span><br><span class="line">            len = Math.max(len,arr[end]&gt;arr[i]?temp+<span class="number">1</span>:temp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>算法</tag>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis批量插入方式的比较</title>
    <link href="/2018/02/12/mybatis%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%96%B9%E5%BC%8F%E7%9A%84%E6%AF%94%E8%BE%83/"/>
    <url>/2018/02/12/mybatis%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%96%B9%E5%BC%8F%E7%9A%84%E6%AF%94%E8%BE%83/</url>
    
    <content type="html"><![CDATA[<p>数据库使用的是sqlserver，JDK版本1.8，运行在SpringBoot环境下。</p><ul><li><p>注意若使用mysql请确保：</p><p>MySql的JDBC连接的url中要加rewriteBatchedStatements参数，并保证5.1.13以上版本的驱动，才能实现高性能的批量插入。</p><p>例如： String connectionUrl=”jdbc:mysql://192.168.1.100:3306/test?rewriteBatchedStatements=true” ; </p></li></ul><p>对比3种可用的方式</p><ol><li>反复执行单条插入语句 </li><li>xml拼接sql </li><li>批处理执行</li></ol><p>先说结论：少量插入请使用反复插入单条数据，方便。数量较多请使用批处理方式。（可以考虑以有需求的插入数据量20条左右为界吧，在我的测试和数据库环境下耗时都是百毫秒级的，方便最重要）。<strong>无论何时都不用xml拼接sql的方式</strong>。</p><h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><p><strong>拼接SQL的xml</strong><br><em>newId()是sqlserver生成UUID的函数，与本文内容无关</em></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertByBatch&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.util.List&quot;</span>&gt;</span></span><br><span class="line">    INSERT INTO tb_item VALUES</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;list&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">index</span>=<span class="string">&quot;index&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">        (newId(),#&#123;item.uniqueCode&#125;,#&#123;item.projectId&#125;,#&#123;item.name&#125;,#&#123;item.type&#125;,#&#123;item.packageUnique&#125;,</span><br><span class="line">        #&#123;item.isPackage&#125;,#&#123;item.factoryId&#125;,#&#123;item.projectName&#125;,#&#123;item.spec&#125;,#&#123;item.length&#125;,#&#123;item.weight&#125;,</span><br><span class="line">        #&#123;item.material&#125;,#&#123;item.setupPosition&#125;,#&#123;item.areaPosition&#125;,#&#123;item.bottomHeight&#125;,#&#123;item.topHeight&#125;,</span><br><span class="line">        #&#123;item.serialNumber&#125;,#&#123;item.createTime&#125;<span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Mapper接口</strong><br><em>Mapper<Item> 是 mybatis插件tk.Mapper 的接口，与本文内容关系不大</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Item</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertByBatch</span><span class="params">(List&lt;Item&gt; itemList)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Service类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemMapper itemMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line">    <span class="comment">//批处理</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(List&lt;Item&gt; itemList)</span> </span>&#123;</span><br><span class="line">        SqlSession session = sqlSessionFactory.openSession(ExecutorType.BATCH,<span class="keyword">false</span>);</span><br><span class="line">        ItemMapper mapper = session.getMapper(ItemMapper.class);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; itemList.size(); i++) &#123;</span><br><span class="line">            mapper.insertSelective(itemList.get(i));</span><br><span class="line">            <span class="keyword">if</span>(i%<span class="number">1000</span>==<span class="number">999</span>)&#123;<span class="comment">//每1000条提交一次防止内存溢出</span></span><br><span class="line">                session.commit();</span><br><span class="line">                session.clearCache();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        session.commit();</span><br><span class="line">        session.clearCache();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//拼接sql</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add1</span><span class="params">(List&lt;Item&gt; itemList)</span> </span>&#123;</span><br><span class="line">        itemList.insertByBatch(itemMapper::insertSelective);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//循环插入</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add2</span><span class="params">(List&lt;Item&gt; itemList)</span> </span>&#123;</span><br><span class="line">        itemList.forEach(itemMapper::insertSelective);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>测试类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT, classes = ApplicationBoot.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ItemService itemService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Item&gt; itemList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//生成测试List</span></span><br><span class="line">    <span class="meta">@Before</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String json =<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;areaPosition\&quot;: \&quot;TEST\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;bottomHeight\&quot;: 5,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;factoryId\&quot;: \&quot;0\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;length\&quot;: 233.233,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;material\&quot;: \&quot;Q345B\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;name\&quot;: \&quot;TEST\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;package\&quot;: false,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;packageUnique\&quot;: \&quot;45f8a0ba0bf048839df85f32ebe5bb81\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;projectId\&quot;: \&quot;094b5eb5e0384bb1aaa822880a428b6d\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;projectName\&quot;: \&quot;项目_TEST1\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;serialNumber\&quot;: \&quot;1/2\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;setupPosition\&quot;: \&quot;1B柱\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;spec\&quot;: \&quot;200X200X200\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;topHeight\&quot;: 10,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;Steel\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;uniqueCode\&quot;: \&quot;12344312\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;weight\&quot;: 100\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;&quot;</span>;</span><br><span class="line">        Item test1 = JSON.parseObject(json,Item.class);</span><br><span class="line">        test1.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;<span class="comment">//测试会修改此数量</span></span><br><span class="line">            itemList.add(test1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//批处理</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tesInsert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        itemService.add(itemList);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//拼接字符串</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        itemService.add1(itemList);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//循环插入</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        itemService.add2(itemList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试结果："><a href="#测试结果：" class="headerlink" title="测试结果："></a>测试结果：</h4><p>10条 25条数据插入经多次测试，波动性较大，但基本都在百毫秒级别</p><table><thead><tr><th>方式</th><th>50条</th><th>100条</th><th>500条</th><th>1000条</th></tr></thead><tbody><tr><td>批处理</td><td>159ms</td><td>208ms</td><td>305ms</td><td>432ms</td></tr><tr><td>xml拼接sql</td><td>208ms</td><td>232ms</td><td>报错</td><td>报错</td></tr><tr><td>反复单条插入</td><td>1013ms</td><td>2266ms</td><td>8141ms</td><td>18861ms</td></tr></tbody></table><p>其中 拼接sql方式在插入500条和1000条时报错（似乎是因为sql语句过长，此条跟数据库类型有关，但是数据库应该都有单条语句长度限制）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.microsoft.sqlserver.jdbc.SQLServerException: 传入的表格格式数据流(TDS)远程过程调用(RPC)协议流不正确。此 RPC 请求中提供了过多的参数。最多应为 2100</span><br></pre></td></tr></table></figure><p>可以发现 </p><ul><li>循环插入的时间复杂度是 O(n),并且常数C很大</li><li>拼接SQL插入的时间复杂度（应该）是 O(logn),但是成功完成次数不多，不确定</li><li>批处理的效率的时间复杂度是 O(logn),并且常数C也比较小</li></ul><h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p><strong>循环插入单条数据</strong>虽然效率极低，但是代码量极少，在使用tk.Mapper的插件情况下，仅需代码,：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add1</span><span class="params">(List&lt;Item&gt; itemList)</span> </span>&#123;</span><br><span class="line">    itemList.forEach(itemMapper::insertSelective);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此，在需求插入数据数量不多的情况下肯定用它了。</p><p><strong>xml拼接sql</strong>是最不推荐的方式，使用时有大段的xml和sql语句要写，很容易出错，工作效率很低。更关键点是，虽然效率尚可，但是真正需要效率的时候你挂了，要你何用？</p><p><strong>批处理执行</strong>是有大数据量插入时推荐的做法，使用起来也比较方便。</p>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
